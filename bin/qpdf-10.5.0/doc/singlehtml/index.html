<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QPDF 10.5.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="#" class="icon icon-home"> QPDF
            <img src="_static/qpdf.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                10.5.0
              </div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-overview">What is QPDF?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-download">Downloading QPDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-installation">Building and Installing QPDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-packaging">Notes for Packagers</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cli">Running QPDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-qdf">QDF Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-library">Using the QPDF Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-weak-crypto">Weak Cryptography</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-json">QPDF JSON</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-design">Design and Library Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-linearization">Linearization</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-object-streams">Object and Cross-Reference Streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-release-notes">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-acknowledgement">Acknowledgments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">QPDF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
      <li>QPDF 10.5.0 documentation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="qpdf-version-release">
<h1>QPDF version 10.5.0<a class="headerlink" href="#qpdf-version-release" title="Permalink to this headline"></a></h1>
<p>Welcome to the QPDF documentation! For the latest version of this
documentation, please visit <a class="reference external" href="https://qpdf.readthedocs.io">https://qpdf.readthedocs.io</a>.</p>
<div class="toctree-wrapper compound">
<span id="document-overview"></span><section id="what-is-qpdf">
<span id="overview"></span><h2>What is QPDF?<a class="headerlink" href="#what-is-qpdf" title="Permalink to this headline"></a></h2>
<p>QPDF is a program and C++ library for structural, content-preserving
transformations on PDF files. QPDF’s website is located at
<a class="reference external" href="https://qpdf.sourceforge.io/">https://qpdf.sourceforge.io/</a>. QPDF’s source code is hosted on github
at <a class="reference external" href="https://github.com/qpdf/qpdf">https://github.com/qpdf/qpdf</a>. You can find the latest version of
this documentation at <a class="reference external" href="https://qpdf.readthedocs.io/">https://qpdf.readthedocs.io/</a>.</p>
<p>QPDF provides many useful capabilities to developers of PDF-producing
software or for people who just want to look at the innards of a PDF
file to learn more about how they work. With QPDF, it is possible to
copy objects from one PDF file into another and to manipulate the list
of pages in a PDF file. This makes it possible to merge and split PDF
files. The QPDF library also makes it possible for you to create PDF
files from scratch. In this mode, you are responsible for supplying
all the contents of the file, while the QPDF library takes care of all
the syntactical representation of the objects, creation of cross
references tables and, if you use them, object streams, encryption,
linearization, and other syntactic details. You are still responsible
for generating PDF content on your own.</p>
<p>QPDF has been designed with very few external dependencies, and it is
intentionally very lightweight. QPDF is <em>not</em> a PDF content creation
library, a PDF viewer, or a program capable of converting PDF into other
formats. In particular, QPDF knows nothing about the semantics of PDF
content streams. If you are looking for something that can do that, you
should look elsewhere. However, once you have a valid PDF file, QPDF can
be used to transform that file in ways that perhaps your original PDF
creation tool can’t handle. For example, many programs generate simple PDF
files but can’t password-protect them, web-optimize them, or perform
other transformations of that type.</p>
<p>This documentation aims to be comprehensive, but there is also a <a class="reference external" href="https://github.com/qpdf/qpdf/wiki">wiki</a> for less polished material and
ongoing work.</p>
</section>
<span id="document-license"></span><section id="license">
<span id="id1"></span><h2>License<a class="headerlink" href="#license" title="Permalink to this headline"></a></h2>
<p>QPDF is licensed under <a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">the Apache License, Version 2.0</a> (the “License”).
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License.</p>
</section>
<span id="document-download"></span><section id="downloading-qpdf">
<span id="download"></span><h2>Downloading QPDF<a class="headerlink" href="#downloading-qpdf" title="Permalink to this headline"></a></h2>
<p>QPDF is included in most Linux distributions. Native packages are
available for many other operating systems as well.</p>
<p>Other resources:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/qpdf/qpdf/releases/">GitHub release page</a></p></li>
<li><p><a class="reference external" href="https://github.com/qpdf/qpdf">GitHub project</a></p></li>
<li><p><a class="reference external" href="https://qpdf.sourceforge.io">QPDF project web site</a></p></li>
</ul>
</section>
<span id="document-installation"></span><section id="building-and-installing-qpdf">
<span id="installing"></span><h2>Building and Installing QPDF<a class="headerlink" href="#building-and-installing-qpdf" title="Permalink to this headline"></a></h2>
<p>This chapter describes how to build and install qpdf. Please see also
the <code class="file docutils literal notranslate"><span class="pre">README.md</span></code> and
<code class="file docutils literal notranslate"><span class="pre">INSTALL</span></code> files in the source distribution.</p>
<section id="system-requirements">
<span id="prerequisites"></span><h3>System Requirements<a class="headerlink" href="#system-requirements" title="Permalink to this headline"></a></h3>
<p>The qpdf package has few external dependencies. In order to build qpdf,
the following packages are required:</p>
<ul class="simple">
<li><p>A C++ compiler that supports C++-14.</p></li>
<li><p>zlib: <a class="reference external" href="http://www.zlib.net/">http://www.zlib.net/</a></p></li>
<li><p>jpeg: <a class="reference external" href="http://www.ijg.org/files/">http://www.ijg.org/files/</a> or <a class="reference external" href="https://libjpeg-turbo.org/">https://libjpeg-turbo.org/</a></p></li>
<li><p><em>Recommended but not required:</em> gnutls: <a class="reference external" href="https://www.gnutls.org/">https://www.gnutls.org/</a> to be
able to use the gnutls crypto provider, and/or openssl:
<a class="reference external" href="https://openssl.org/">https://openssl.org/</a> to be able to use the openssl crypto provider.</p></li>
<li><p>gnu make 3.81 or newer: <a class="reference external" href="http://www.gnu.org/software/make">http://www.gnu.org/software/make</a></p></li>
<li><p>perl version 5.8 or newer: <a class="reference external" href="http://www.perl.org/">http://www.perl.org/</a>; required for running
the test suite. Starting with qpdf version 9.1.1, perl is no longer
required at runtime.</p></li>
<li><p>GNU diffutils (any version): <a class="reference external" href="http://www.gnu.org/software/diffutils/">http://www.gnu.org/software/diffutils/</a>
is required to run the test suite. Note that this is the version of
diff present on virtually all GNU/Linux systems. This is required
because the test suite uses <strong class="command">diff -u</strong>.</p></li>
</ul>
<p>Part of qpdf’s test suite does comparisons of the contents PDF files by
converting them images and comparing the images. The image comparison
tests are disabled by default. Those tests are not required for
determining correctness of a qpdf build if you have not modified the
code since the test suite also contains expected output files that are
compared literally. The image comparison tests provide an extra check to
make sure that any content transformations don’t break the rendering of
pages. Transformations that affect the content streams themselves are
off by default and are only provided to help developers look into the
contents of PDF files. If you are making deep changes to the library
that cause changes in the contents of the files that qpdf generate,
then you should enable the image comparison tests. Enable them by
running <strong class="command">configure</strong> with the
<code class="samp docutils literal notranslate"><span class="pre">--enable-test-compare-images</span></code> flag. If you enable
this, the following additional requirements are required by the test
suite. Note that in no case are these items required to use qpdf.</p>
<ul class="simple">
<li><p>libtiff: <a class="reference external" href="http://www.remotesensing.org/libtiff/">http://www.remotesensing.org/libtiff/</a></p></li>
<li><p>GhostScript version 8.60 or newer: <a class="reference external" href="http://www.ghostscript.com">http://www.ghostscript.com</a></p></li>
</ul>
<p>If you do not enable this, then you do not need to have tiff and
ghostscript.</p>
<p>For information on building the documentation, see <a class="reference internal" href="#build-doc"><span class="std std-ref">Building Documentation</span></a>.</p>
</section>
<section id="build-instructions">
<span id="building"></span><h3>Build Instructions<a class="headerlink" href="#build-instructions" title="Permalink to this headline"></a></h3>
<p>Building qpdf on UNIX is generally just a matter of running</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./configure
make
</pre></div>
</div>
<p>You can also run <strong class="command">make check</strong> to run the test
suite and <strong class="command">make install</strong> to install. Please run
<strong class="command">./configure --help</strong> for options on what can be
configured. You can also set the value of <code class="docutils literal notranslate"><span class="pre">DESTDIR</span></code> during
installation to install to a temporary location, as is common with many
open source packages. Please see also the
<code class="file docutils literal notranslate"><span class="pre">README.md</span></code> and
<code class="file docutils literal notranslate"><span class="pre">INSTALL</span></code> files in the source distribution.</p>
<p>Building on Windows is a little bit more complicated. For details,
please see <code class="file docutils literal notranslate"><span class="pre">README-windows.md</span></code> in the source
distribution. You can also download a binary distribution for Windows.
There is a port of qpdf to Visual C++ version 6 in the
<code class="file docutils literal notranslate"><span class="pre">contrib</span></code> area generously contributed by Jian
Ma. This is also discussed in more detail in
<code class="file docutils literal notranslate"><span class="pre">README-windows.md</span></code>.</p>
<p>While <code class="docutils literal notranslate"><span class="pre">wchar_t</span></code> is part of the C++ standard, qpdf uses it in only one
place in the public API, and it’s just in a helper function. It is
possible to build qpdf on a system that doesn’t have <code class="docutils literal notranslate"><span class="pre">wchar_t</span></code>, and
it’s also possible to compile a program that uses qpdf on a system
without <code class="docutils literal notranslate"><span class="pre">wchar_t</span></code> as long as you don’t call that one method. This is a
very unusual situation. For a detailed discussion, please see the
top-level README.md file in qpdf’s source distribution.</p>
<p>There are some other things you can do with the build. Although qpdf
uses <strong class="command">autoconf</strong>, it does not use
<strong class="command">automake</strong> but instead uses a
hand-crafted non-recursive Makefile that requires gnu make. If you’re
really interested, please read the comments in the top-level
<code class="file docutils literal notranslate"><span class="pre">Makefile</span></code>.</p>
</section>
<section id="building-documentation">
<span id="build-doc"></span><h3>Building Documentation<a class="headerlink" href="#building-documentation" title="Permalink to this headline"></a></h3>
<p>The qpdf manual is written in reStructured Text and built with <a class="reference external" href="https://www.sphinx-doc.org">Sphinx</a> using the <a class="reference external" href="https://sphinx-rtd-theme.readthedocs.io">Read the Docs Sphinx Theme</a>. In order to build the
HTML documentation from source, you need to install sphinx and the
theme, which you can typically do with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">sphinx</span>
<span class="pre">sphinx_rtd_theme</span></code>. To build the PDF version of the documentation, you
need <code class="docutils literal notranslate"><span class="pre">pdflatex</span></code>, <code class="docutils literal notranslate"><span class="pre">latexmk</span></code>, and a fairly complete LaTeX
installation. Detailed requirements can be found in the Sphinx
documentation. To see how the documentation is built for the qpdf
distribution, refer to the <code class="file docutils literal notranslate"><span class="pre">build-scripts/build-doc</span></code> file in the
qpdf source distribution.</p>
</section>
<section id="crypto-providers">
<span id="crypto"></span><h3>Crypto Providers<a class="headerlink" href="#crypto-providers" title="Permalink to this headline"></a></h3>
<p>Starting with qpdf 9.1.0, the qpdf library can be built with multiple
implementations of providers of cryptographic functions, which we refer
to as “crypto providers.” At the time of writing, a crypto
implementation must provide MD5 and SHA2 (256, 384, and 512-bit) hashes
and RC4 and AES256 with and without CBC encryption. In the future, if
digital signature is added to qpdf, there may be additional requirements
beyond this.</p>
<p>Starting with qpdf version 9.1.0, the available implementations are
<code class="docutils literal notranslate"><span class="pre">native</span></code> and <code class="docutils literal notranslate"><span class="pre">gnutls</span></code>. In qpdf 10.0.0, <code class="docutils literal notranslate"><span class="pre">openssl</span></code> was added.
Additional implementations may be added if needed. It is also possible
for a developer to provide their own implementation without modifying
the qpdf library.</p>
<section id="build-support-for-crypto-providers">
<span id="crypto-build"></span><h4>Build Support For Crypto Providers<a class="headerlink" href="#build-support-for-crypto-providers" title="Permalink to this headline"></a></h4>
<p>When building with qpdf’s build system, crypto providers can be enabled
at build time using various <strong class="command">./configure</strong>
options. The default behavior is for
<strong class="command">./configure</strong> to discover which crypto providers
can be supported based on available external libraries, to build all
available crypto providers, and to use an external provider as the
default over the native one. This behavior can be changed with the
following flags to <strong class="command">./configure</strong>:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">--enable-crypto-</span><em><span class="pre">x</span></em></code>
(where <code class="samp docutils literal notranslate"><em><span class="pre">x</span></em></code> is a supported crypto
provider): enable the <code class="samp docutils literal notranslate"><em><span class="pre">x</span></em></code> crypto
provider, requiring any external dependencies it needs</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--disable-crypto-</span><em><span class="pre">x</span></em></code>:
disable the <code class="samp docutils literal notranslate"><em><span class="pre">x</span></em></code> provider, and do not
link against its dependencies even if they are available</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--with-default-crypto=</span><em><span class="pre">x</span></em></code>:
make <code class="samp docutils literal notranslate"><em><span class="pre">x</span></em></code> the default provider even if
a higher priority one is available</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--disable-implicit-crypto</span></code>: only build crypto
providers that are explicitly requested with an
<code class="samp docutils literal notranslate"><span class="pre">--enable-crypto-</span><em><span class="pre">x</span></em></code>
option</p></li>
</ul>
<p>For example, if you want to guarantee that the gnutls crypto provider is
used and that the native provider is not built, you could run
<strong class="command">./configure --enable-crypto-gnutls
--disable-implicit-crypto</strong>.</p>
<p>If you build qpdf using your own build system, in order for qpdf to work
at all, you need to enable at least one crypto provider. The file
<code class="file docutils literal notranslate"><span class="pre">libqpdf/qpdf/qpdf-config.h.in</span></code> provides
macros <code class="docutils literal notranslate"><span class="pre">DEFAULT_CRYPTO</span></code>, whose value must be a string naming the
default crypto provider, and various symbols starting with
<code class="docutils literal notranslate"><span class="pre">USE_CRYPTO_</span></code>, at least one of which has to be enabled. Additionally,
you must compile the source files that implement a crypto provider. To
get a list of those files, look at
<code class="file docutils literal notranslate"><span class="pre">libqpdf/build.mk</span></code>. If you want to omit a
particular crypto provider, as long as its <code class="docutils literal notranslate"><span class="pre">USE_CRYPTO_</span></code> symbol is
undefined, you can completely ignore the source files that belong to a
particular crypto provider. Additionally, crypto providers may have
their own external dependencies that can be omitted if the crypto
provider is not used. For example, if you are building qpdf yourself and
are using an environment that does not support gnutls or openssl, you
can ensure that <code class="docutils literal notranslate"><span class="pre">USE_CRYPTO_NATIVE</span></code> is defined, <code class="docutils literal notranslate"><span class="pre">USE_CRYPTO_GNUTLS</span></code>
is not defined, and <code class="docutils literal notranslate"><span class="pre">DEFAULT_CRYPTO</span></code> is defined to <code class="docutils literal notranslate"><span class="pre">&quot;native&quot;</span></code>. Then
you must include the source files used in the native implementation,
some of which were added or renamed from earlier versions, to your
build, and you can ignore
<code class="file docutils literal notranslate"><span class="pre">QPDFCrypto_gnutls.cc</span></code>. Always consult
<code class="file docutils literal notranslate"><span class="pre">libqpdf/build.mk</span></code> to get the list of source
files you need to build.</p>
</section>
<section id="runtime-crypto-provider-selection">
<span id="crypto-runtime"></span><h4>Runtime Crypto Provider Selection<a class="headerlink" href="#runtime-crypto-provider-selection" title="Permalink to this headline"></a></h4>
<p>You can use the <code class="samp docutils literal notranslate"><span class="pre">--show-crypto</span></code> option to
<strong class="command">qpdf</strong> to get a list of available crypto
providers. The default provider is always listed first, and the rest are
listed in lexical order. Each crypto provider is listed on a line by
itself with no other text, enabling the output of this command to be
used easily in scripts.</p>
<p>You can override which crypto provider is used by setting the
<code class="docutils literal notranslate"><span class="pre">QPDF_CRYPTO_PROVIDER</span></code> environment variable. There are few reasons to
ever do this, but you might want to do it if you were explicitly trying
to compare behavior of two different crypto providers while testing
performance or reproducing a bug. It could also be useful for people who
are implementing their own crypto providers.</p>
</section>
<section id="crypto-provider-information-for-developers">
<span id="crypto-develop"></span><h4>Crypto Provider Information for Developers<a class="headerlink" href="#crypto-provider-information-for-developers" title="Permalink to this headline"></a></h4>
<p>If you are writing code that uses libqpdf and you want to force a
certain crypto provider to be used, you can call the method
<code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider::setDefaultProvider</span></code>. The argument is the name of
a built-in or developer-supplied provider. To add your own crypto
provider, you have to create a class derived from <code class="docutils literal notranslate"><span class="pre">QPDFCryptoImpl</span></code> and
register it with <code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code>. For additional information, see
comments in <code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDFCryptoImpl.hh</span></code>.</p>
</section>
<section id="crypto-provider-design-notes">
<span id="crypto-design"></span><h4>Crypto Provider Design Notes<a class="headerlink" href="#crypto-provider-design-notes" title="Permalink to this headline"></a></h4>
<p>This section describes a few bits of rationale for why the crypto
provider interface was set up the way it was. You don’t need to know any
of this information, but it’s provided for the record and in case it’s
interesting.</p>
<p>As a general rule, I want to avoid as much as possible including large
blocks of code that are conditionally compiled such that, in most
builds, some code is never built. This is dangerous because it makes it
very easy for invalid code to creep in unnoticed. As such, I want it to
be possible to build qpdf with all available crypto providers, and this
is the way I build qpdf for local development. At the same time, if a
particular packager feels that it is a security liability for qpdf to
use crypto functionality from other than a library that gets
considerable scrutiny for this specific purpose (such as gnutls,
openssl, or nettle), then I want to give that packager the ability to
completely disable qpdf’s native implementation. Or if someone wants to
avoid adding a dependency on one of the external crypto providers, I
don’t want the availability of the provider to impose additional
external dependencies within that environment. Both of these are
situations that I know to be true for some users of qpdf.</p>
<p>I want registration and selection of crypto providers to be thread-safe,
and I want it to work deterministically for a developer to provide their
own crypto provider and be able to set it up as the default. This was
the primary motivation behind requiring C++-11 as doing so enabled me to
exploit the guaranteed thread safety of local block static
initialization. The <code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code> class uses a singleton
pattern with thread-safe initialization to create the singleton instance
of <code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code> and exposes only static methods in its public
interface. In this way, if a developer wants to call any
<code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code> methods, the library guarantees the
<code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code> is fully initialized and all built-in crypto
providers are registered. Making <code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code> actually know
about all the built-in providers may seem a bit sad at first, but this
choice makes it extremely clear exactly what the initialization behavior
is. There’s no question about provider implementations automatically
registering themselves in a nondeterministic order. It also means that
implementations do not need to know anything about the provider
interface, which makes them easier to test in isolation. Another
advantage of this approach is that a developer who wants to develop
their own crypto provider can do so in complete isolation from the qpdf
library and, with just two calls, can make qpdf use their provider in
their application. If they decided to contribute their code, plugging it
into the qpdf library would require a very small change to qpdf’s source
code.</p>
<p>The decision to make the crypto provider selectable at runtime was one I
struggled with a little, but I decided to do it for various reasons.
Allowing an end user to switch crypto providers easily could be very
useful for reproducing a potential bug. If a user reports a bug that
some cryptographic thing is broken, I can easily ask that person to try
with the <code class="docutils literal notranslate"><span class="pre">QPDF_CRYPTO_PROVIDER</span></code> variable set to different values. The
same could apply in the event of a performance problem. This also makes
it easier for qpdf’s own test suite to exercise code with different
providers without having to make every program that links with qpdf
aware of the possibility of multiple providers. In qpdf’s continuous
integration environment, the entire test suite is run for each supported
crypto provider. This is made simple by being able to select the
provider using an environment variable.</p>
<p>Finally, making crypto providers selectable in this way establish a
pattern that I may follow again in the future for stream filter
providers. One could imagine a future enhancement where someone could
provide their own implementations for basic filters like
<code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code> or for other filters that qpdf doesn’t support.
Implementing the registration functions and internal storage of
registered providers was also easier using C++-11’s functional
interfaces, which was another reason to require C++-11 at this time.</p>
</section>
</section>
</section>
<span id="document-packaging"></span><section id="notes-for-packagers">
<span id="packaging"></span><h2>Notes for Packagers<a class="headerlink" href="#notes-for-packagers" title="Permalink to this headline"></a></h2>
<p>If you are packaging qpdf for an operating system distribution, this
chapter is for you. Otherwise, feel free to skip.</p>
<section id="build-options">
<h3>Build Options<a class="headerlink" href="#build-options" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Perl must be present at build time. Prior to qpdf version 9.1.1,
there was a runtime dependency on perl, but this is no longer the
case.</p></li>
<li><p>Make sure you are getting the intended behavior with regard to crypto
providers. Read <a class="reference internal" href="index.html#crypto-build"><span class="std std-ref">Build Support For Crypto Providers</span></a> for details.</p></li>
<li><p>Passing <code class="samp docutils literal notranslate"><span class="pre">--enable-show-failed-test-output</span></code> to
<strong class="command">./configure</strong> will cause any failed test
output to be written to the console. This can be very useful for
seeing test failures generated by autobuilders where you can’t access
qtest.log after the fact.</p></li>
<li><p>If qpdf’s build environment detects the presence of autoconf and
related tools, it will check to ensure that automatically generated
files are up-to-date with recorded checksums and fail if it detects a
discrepancy. This feature is intended to prevent you from
accidentally forgetting to regenerate automatic files after modifying
their sources. If your packaging environment automatically refreshes
automatic files, it can cause this check to fail. Suppress qpdf’s
checks by passing <code class="samp docutils literal notranslate"><span class="pre">--disable-check-autofiles</span></code>
to <strong class="command">/.configure</strong>. This is safe since qpdf’s
<strong class="command">autogen.sh</strong> just runs autotools in the
normal way.</p></li>
<li><p>QPDF’s <strong class="command">make install</strong> does not install completion files by
default, but as a packager, it’s good if you install them wherever
your distribution expects such files to go. You can find completion
files to install in the <code class="file docutils literal notranslate"><span class="pre">completions</span></code> directory.</p></li>
<li><p>Packagers are encouraged to install the source files from the
<code class="file docutils literal notranslate"><span class="pre">examples</span></code> directory along with qpdf development packages.</p></li>
</ul>
</section>
<section id="packaging-documentation">
<span id="packaging-doc"></span><h3>Packaging Documentation<a class="headerlink" href="#packaging-documentation" title="Permalink to this headline"></a></h3>
<p>Starting in qpdf version 10.5, pre-built documentation is no longer
distributed with the qpdf source distribution. Here are a few options
you may want to consider for your packages:</p>
<ul>
<li><p><strong>Do nothing</strong></p>
<p>When you run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code>, the file <code class="file docutils literal notranslate"><span class="pre">README-doc.txt</span></code> is
installed in <code class="docutils literal notranslate"><span class="pre">$(docdir)</span></code>. That file tells the reader where to find
the documentation online and where to go to download offline copies
of the documentation. This is the option selected by the debian
packages.</p>
</li>
<li><p><strong>Embed pre-built documentation</strong></p>
<p>You can obtain pre-built documentation and extract its contents into
your distribution. This is what the Windows binary distributions
available from the qpdf release site do. You can find the pre-build
documentation in the release area in the file
<code class="file docutils literal notranslate"><span class="pre">qpdf-</span><em><span class="pre">version</span></em><span class="pre">-doc.zip</span></code>.</p>
</li>
<li><p><strong>Build the documentation yourself</strong></p>
<p>You can build the documentation as part of your build process. Be
sure to pass <code class="docutils literal notranslate"><span class="pre">--enable-doc-maintenance</span></code> to <code class="docutils literal notranslate"><span class="pre">./configure</span></code>, and
install it with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">doc-dist</span> <span class="pre">DOC_DEST=...</span></code>. This is what the
AppImage build does. The latest version of Sphinx at the time of the
initial conversion a sphinx-based documentation was 4.3.2. Older
versions are not guaranteed to work.</p>
</li>
</ul>
<section id="documentation-packaging-rationale">
<h4>Documentation Packaging Rationale<a class="headerlink" href="#documentation-packaging-rationale" title="Permalink to this headline"></a></h4>
<p>This section describes the reason for things being the way they are.
It’s for information only; you don’t have to know any of this to
package qpdf.</p>
<p>What is the reason for this change? Prior to qpdf 10.5, the qpdf
manual was a docbook XML file. The generated documents were the
product of running the file through build-time style sheets and
contained no copyrighted material of their own. Starting with version
10.5, the manual is written produced with <a class="reference external" href="https://www.sphinx-doc.org">Sphinx</a>. This change was made to make it much
easier to automatically generate portions of the documentation and to
make the documentation easier to work with. The HTML output of Sphinx
is also much more readable, usable, and suitable for online
consumption than the output of the docbook style sheets. The downsides
are that the generated HTML documentation now contains Javascript code
and embedded fonts, and the PDF version of the documentation is no
longer as suitable for printing (at least as of the 10.5 distribution)
since external link targets are no longer shown and cross references
no longer contain page number information. The presence of copyrighted
material in the generated documentation, even though things are
licensed with MIT and BSD licenses, complicates the job of the
packager in various ways. For one thing, it means the
<code class="file docutils literal notranslate"><span class="pre">NOTICE.md</span></code> file in the source repository would have to keep up
with the copyright information for files that are not controlled in
the repository. Additionally, some distributions (notably
Debian/Ubuntu) discourage inclusion of sphinx-generated documentation
in packages, preferring you instead to build the documentation as part
of the package build process and to depend at runtime on a shared
package that contains the code. At the time of the conversion of the
qpdf manual from docbook to sphinx, newer versions of both sphinx and
the html theme were required than were available in some of most of
the Debian/Ubuntu versions for which qpdf was packaged.</p>
<p>Since always-on Internet connectivity is much more common than it used
to be, many users of qpdf would prefer to consume the documentation
online anyway, and the lack of pre-built documentation in the
distribution won’t be as big of a deal. However there are still some
people who can’t or choose not to view documentation online. For them,
pre-built documentation is still available.</p>
</section>
</section>
</section>
<span id="document-cli"></span><section id="running-qpdf">
<span id="using"></span><h2>Running QPDF<a class="headerlink" href="#running-qpdf" title="Permalink to this headline"></a></h2>
<p>This chapter describes how to run the qpdf program from the command
line.</p>
<section id="basic-invocation">
<span id="invocation"></span><h3>Basic Invocation<a class="headerlink" href="#basic-invocation" title="Permalink to this headline"></a></h3>
<p>When running qpdf, the basic invocation is as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qpdf [ options ] { infilename | --empty } outfilename
</pre></div>
</div>
<p>This converts PDF file <code class="samp docutils literal notranslate"><span class="pre">infilename</span></code> to PDF file
<code class="samp docutils literal notranslate"><span class="pre">outfilename</span></code>. The output file is functionally
identical to the input file but may have been structurally reorganized.
Also, orphaned objects will be removed from the file. Many
transformations are available as controlled by the options below. In
place of <code class="samp docutils literal notranslate"><span class="pre">infilename</span></code>, the parameter
<code class="samp docutils literal notranslate"><span class="pre">--empty</span></code> may be specified. This causes qpdf to
use a dummy input file that contains zero pages. The only normal use
case for using <code class="samp docutils literal notranslate"><span class="pre">--empty</span></code> would be if you were
going to add pages from another source, as discussed in <a class="reference internal" href="#page-selection"><span class="std std-ref">Page Selection Options</span></a>.</p>
<p>If <code class="samp docutils literal notranslate"><span class="pre">&#64;filename</span></code> appears as a word anywhere in the
command-line, it will be read line by line, and each line will be
treated as a command-line argument. Leading and trailing whitespace is
intentionally not removed from lines, which makes it possible to handle
arguments that start or end with spaces. The <code class="samp docutils literal notranslate"><span class="pre">&#64;-</span></code>
option allows arguments to be read from standard input. This allows qpdf
to be invoked with an arbitrary number of arbitrarily long arguments. It
is also very useful for avoiding having to pass passwords on the command
line. Note that the <code class="samp docutils literal notranslate"><span class="pre">&#64;filename</span></code> can’t appear in
the middle of an argument, so constructs such as
<code class="samp docutils literal notranslate"><span class="pre">--arg=&#64;option</span></code> will not work. You would have to
include the argument and its options together in the arguments file.</p>
<p><code class="samp docutils literal notranslate"><span class="pre">outfilename</span></code> does not have to be seekable, even
when generating linearized files. Specifying “<code class="samp docutils literal notranslate"><span class="pre">-</span></code>”
as <code class="samp docutils literal notranslate"><span class="pre">outfilename</span></code> means to write to standard
output. If you want to overwrite the input file with the output, use the
option <code class="samp docutils literal notranslate"><span class="pre">--replace-input</span></code> and omit the output file
name. You can’t specify the same file as both the input and the output.
If you do this, qpdf will tell you about the
<code class="samp docutils literal notranslate"><span class="pre">--replace-input</span></code> option.</p>
<p>Most options require an output file, but some testing or inspection
commands do not. These are specifically noted.</p>
<section id="exit-status">
<span id="id1"></span><h4>Exit Status<a class="headerlink" href="#exit-status" title="Permalink to this headline"></a></h4>
<p>The exit status of <strong class="command">qpdf</strong> may be interpreted as
follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code>: no errors or warnings were found. The file may still have
problems qpdf can’t detect. If
<code class="samp docutils literal notranslate"><span class="pre">--warning-exit-0</span></code> was specified, exit status 0
is used even if there are warnings.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code>: errors were found. qpdf was not able to fully process the
file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">3</span></code>: qpdf encountered problems that it was able to recover from. In
some cases, the resulting file may still be damaged. Note that qpdf
still exits with status <code class="docutils literal notranslate"><span class="pre">3</span></code> if it finds warnings even when
<code class="samp docutils literal notranslate"><span class="pre">--no-warn</span></code> is specified. With
<code class="samp docutils literal notranslate"><span class="pre">--warning-exit-0</span></code>, warnings without errors
exit with status 0 instead of 3.</p></li>
</ul>
<p>Note that <strong class="command">qpdf</strong> never exists with status <code class="docutils literal notranslate"><span class="pre">1</span></code>.
If you get an exit status of <code class="docutils literal notranslate"><span class="pre">1</span></code>, it was something else, like the
shell not being able to find or execute <strong class="command">qpdf</strong>.</p>
</section>
</section>
<section id="shell-completion">
<span id="id2"></span><h3>Shell Completion<a class="headerlink" href="#shell-completion" title="Permalink to this headline"></a></h3>
<p>Starting in qpdf version 8.3.0, qpdf provides its own completion support
for zsh and bash. You can enable bash completion with <strong class="command">eval
$(qpdf --completion-bash)</strong> and zsh completion with
<strong class="command">eval $(qpdf --completion-zsh)</strong>. If
<strong class="command">qpdf</strong> is not in your path, you should invoke it
above with an absolute path. If you invoke it with a relative path, it
will warn you, and the completion won’t work if you’re in a different
directory.</p>
<p>qpdf will use <code class="docutils literal notranslate"><span class="pre">argv[0]</span></code> to figure out where its executable is. This
may produce unwanted results in some cases, especially if you are trying
to use completion with copy of qpdf that is built from source. You can
specify a full path to the qpdf you want to use for completion in the
<code class="docutils literal notranslate"><span class="pre">QPDF_EXECUTABLE</span></code> environment variable.</p>
</section>
<section id="basic-options">
<span id="id3"></span><h3>Basic Options<a class="headerlink" href="#basic-options" title="Permalink to this headline"></a></h3>
<p>The following options are the most common ones and perform commonly
needed transformations.</p>
<dl>
<dt><code class="samp docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Display command-line invocation help.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Display the current version of qpdf.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--copyright</span></code></dt><dd><p>Show detailed copyright information.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-crypto</span></code></dt><dd><p>Show a list of available crypto providers, each on a line by itself.
The default provider is always listed first. See <a class="reference internal" href="index.html#crypto"><span class="std std-ref">Crypto Providers</span></a> for more information about crypto
providers.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--completion-bash</span></code></dt><dd><p>Output a completion command you can eval to enable shell completion
from bash.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--completion-zsh</span></code></dt><dd><p>Output a completion command you can eval to enable shell completion
from zsh.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--password=</span><em><span class="pre">password</span></em></code></dt><dd><p>Specifies a password for accessing encrypted files. To read the
password from a file or standard input, you can use
<code class="samp docutils literal notranslate"><span class="pre">--password-file</span></code>, added in qpdf 10.2. Note
that you can also use <code class="samp docutils literal notranslate"><span class="pre">&#64;filename</span></code> or
<code class="samp docutils literal notranslate"><span class="pre">&#64;-</span></code> as described above to put the password in
a file or pass it via standard input, but you would do so by
specifying the entire
<code class="samp docutils literal notranslate"><span class="pre">--password=</span><em><span class="pre">password</span></em></code>
option in the file. Syntax such as
<code class="samp docutils literal notranslate"><span class="pre">--password=&#64;filename</span></code> won’t work since
<code class="samp docutils literal notranslate"><span class="pre">&#64;filename</span></code> is not recognized in the middle of
an argument.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--password-file=</span><em><span class="pre">filename</span></em></code></dt><dd><p>Reads the first line from the specified file and uses it as the
password for accessing encrypted files.
<code class="samp docutils literal notranslate"><em><span class="pre">filename</span></em></code>
may be <code class="docutils literal notranslate"><span class="pre">-</span></code> to read the password from standard input. Note that, in
this case, the password is echoed and there is no prompt, so use with
caution.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--is-encrypted</span></code></dt><dd><p>Silently exit with status 0 if the file is encrypted or status 2 if
the file is not encrypted. This is useful for shell scripts. Other
options are ignored if this is given. This option is mutually
exclusive with <code class="samp docutils literal notranslate"><span class="pre">--requires-password</span></code>. Both this
option and <code class="samp docutils literal notranslate"><span class="pre">--requires-password</span></code> exit with
status 2 for non-encrypted files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--requires-password</span></code></dt><dd><p>Silently exit with status 0 if a password (other than as supplied) is
required. Exit with status 2 if the file is not encrypted. Exit with
status 3 if the file is encrypted but requires no password or the
correct password has been supplied. This is useful for shell scripts.
Note that any supplied password is used when opening the file. When
used with a <code class="samp docutils literal notranslate"><span class="pre">--password</span></code> option, this option
can be used to check the correctness of the password. In that case,
an exit status of 3 means the file works with the supplied password.
This option is mutually exclusive with
<code class="samp docutils literal notranslate"><span class="pre">--is-encrypted</span></code>. Both this option and
<code class="samp docutils literal notranslate"><span class="pre">--is-encrypted</span></code> exit with status 2 for
non-encrypted files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Increase verbosity of output. For now, this just prints some
indication of any file that it creates.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--progress</span></code></dt><dd><p>Indicate progress while writing files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--no-warn</span></code></dt><dd><p>Suppress writing of warnings to stderr. If warnings were detected and
suppressed, <strong class="command">qpdf</strong> will still exit with exit
code 3. See also <code class="samp docutils literal notranslate"><span class="pre">--warning-exit-0</span></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--warning-exit-0</span></code></dt><dd><p>If warnings are found but no errors, exit with exit code 0 instead 3.
When combined with <code class="samp docutils literal notranslate"><span class="pre">--no-warn</span></code>, the effect is
for <strong class="command">qpdf</strong> to completely ignore warnings.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--linearize</span></code></dt><dd><p>Causes generation of a linearized (web-optimized) output file.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--replace-input</span></code></dt><dd><p>If specified, the output file name should be omitted. This option
tells qpdf to replace the input file with the output. It does this by
writing to
<code class="file docutils literal notranslate"><em><span class="pre">infilename</span></em><span class="pre">.~qpdf-temp#</span></code>
and, when done, overwriting the input file with the temporary file.
If there were any warnings, the original input is saved as
<code class="file docutils literal notranslate"><em><span class="pre">infilename</span></em><span class="pre">.~qpdf-orig</span></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--copy-encryption=file</span></code></dt><dd><p>Encrypt the file using the same encryption parameters, including user
and owner password, as the specified file. Use
<code class="samp docutils literal notranslate"><span class="pre">--encryption-file-password</span></code> to specify a
password if one is needed to open this file. Note that copying the
encryption parameters from a file also copies the first half of
<code class="docutils literal notranslate"><span class="pre">/ID</span></code> from the file since this is part of the encryption
parameters.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--encryption-file-password=password</span></code></dt><dd><p>If the file specified with <code class="samp docutils literal notranslate"><span class="pre">--copy-encryption</span></code>
requires a password, specify the password using this option. Note
that only one of the user or owner password is required. Both
passwords will be preserved since QPDF does not distinguish between
the two passwords. It is possible to preserve encryption parameters,
including the owner password, from a file even if you don’t know the
file’s owner password.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--allow-weak-crypto</span></code></dt><dd><p>Starting with version 10.4, qpdf issues warnings when requested to
create files using RC4 encryption. This option suppresses those
warnings. In future versions of qpdf, qpdf will refuse to create
files with weak cryptography when this flag is not given. See <a class="reference internal" href="index.html#weak-crypto"><span class="std std-ref">Weak Cryptography</span></a> for additional details.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--encrypt</span> <span class="pre">options</span> <span class="pre">--</span></code></dt><dd><p>Causes generation an encrypted output file. Please see <a class="reference internal" href="#encryption-options"><span class="std std-ref">Encryption Options</span></a> for details on how to specify
encryption parameters.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--decrypt</span></code></dt><dd><p>Removes any encryption on the file. A password must be supplied if
the file is password protected.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--password-is-hex-key</span></code></dt><dd><p>Overrides the usual computation/retrieval of the PDF file’s
encryption key from user/owner password with an explicit
specification of the encryption key. When this option is specified,
the argument to the <code class="samp docutils literal notranslate"><span class="pre">--password</span></code> option is
interpreted as a hexadecimal-encoded key value. This only applies to
the password used to open the main input file. It does not apply to
other files opened by <code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> or other
options or to files being written.</p>
<p>Most users will never have a need for this option, and no standard
viewers support this mode of operation, but it can be useful for
forensic or investigatory purposes. For example, if a PDF file is
encrypted with an unknown password, a brute-force attack using the
key directly is sometimes more efficient than one using the password.
Also, if a file is heavily damaged, it may be possible to derive the
encryption key and recover parts of the file using it directly. To
expose the encryption key used by an encrypted file that you can open
normally, use the <code class="samp docutils literal notranslate"><span class="pre">--show-encryption-key</span></code>
option.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--suppress-password-recovery</span></code></dt><dd><p>Ordinarily, qpdf attempts to automatically compensate for passwords
specified in the wrong character encoding. This option suppresses
that behavior. Under normal conditions, there are no reasons to use
this option. See <a class="reference internal" href="#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a> for a
discussion</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--password-mode=</span><em><span class="pre">mode</span></em></code></dt><dd><p>This option can be used to fine-tune how qpdf interprets Unicode
(non-ASCII) password strings passed on the command line. With the
exception of the <code class="samp docutils literal notranslate"><span class="pre">hex-bytes</span></code> mode, these only
apply to passwords provided when encrypting files. The
<code class="samp docutils literal notranslate"><span class="pre">hex-bytes</span></code> mode also applies to passwords
specified for reading files. For additional discussion of the
supported password modes and when you might want to use them, see
<a class="reference internal" href="#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a>. The following modes
are supported:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">auto</span></code>: Automatically determine whether the
specified password is a properly encoded Unicode (UTF-8) string,
and transcode it as required by the PDF spec based on the type
encryption being applied. On Windows starting with version 8.4.0,
and on almost all other modern platforms, incoming passwords will
be properly encoded in UTF-8, so this is almost always what you
want.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">unicode</span></code>: Tells qpdf that the incoming
password is UTF-8, overriding whatever its automatic detection
determines. The only difference between this mode and
<code class="samp docutils literal notranslate"><span class="pre">auto</span></code> is that qpdf will fail with an error
message if the password is not valid UTF-8 instead of falling back
to <code class="samp docutils literal notranslate"><span class="pre">bytes</span></code> mode with a warning.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">bytes</span></code>: Interpret the password as a literal
byte string. For non-Windows platforms, this is what versions of
qpdf prior to 8.4.0 did. For Windows platforms, there is no way to
specify strings of binary data on the command line directly, but
you can use the <code class="samp docutils literal notranslate"><span class="pre">&#64;filename</span></code> option to do it,
in which case this option forces qpdf to respect the string of
bytes as provided. This option will allow you to encrypt PDF files
with passwords that will not be usable by other readers.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">hex-bytes</span></code>: Interpret the password as a
hex-encoded string. This provides a way to pass binary data as a
password on all platforms including Windows. As with
<code class="samp docutils literal notranslate"><span class="pre">bytes</span></code>, this option may allow creation of
files that can’t be opened by other readers. This mode affects
qpdf’s interpretation of passwords specified for decrypting files
as well as for encrypting them. It makes it possible to specify
strings that are encoded in some manner other than the system’s
default encoding.</p></li>
</ul>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--rotate=[+|-]angle[:page-range]</span></code></dt><dd><p>Apply rotation to specified pages. The
<code class="samp docutils literal notranslate"><span class="pre">page-range</span></code> portion of the option value has
the same format as page ranges in <a class="reference internal" href="#page-selection"><span class="std std-ref">Page Selection Options</span></a>. If the page range is omitted, the
rotation is applied to all pages. The <code class="samp docutils literal notranslate"><span class="pre">angle</span></code>
portion of the parameter may be either 0, 90, 180, or 270. If
preceded by <code class="samp docutils literal notranslate"><span class="pre">+</span></code> or <code class="samp docutils literal notranslate"><span class="pre">-</span></code>,
the angle is added to or subtracted from the specified pages’
original rotations. This is almost always what you want. Otherwise
the pages’ rotations are set to the exact value, which may cause the
appearances of the pages to be inconsistent, especially for scans.
For example, the command <strong class="command">qpdf in.pdf out.pdf
--rotate=+90:2,4,6 --rotate=180:7-8</strong> would rotate pages
2, 4, and 6 90 degrees clockwise from their original rotation and
force the rotation of pages 7 through 8 to 180 degrees regardless of
their original rotation, and the command <strong class="command">qpdf in.pdf
out.pdf --rotate=+180</strong> would rotate all pages by 180
degrees.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--keep-files-open=</span><em><span class="pre">[yn]</span></em></code></dt><dd><p>This option controls whether qpdf keeps individual files open while
merging. Prior to version 8.1.0, qpdf always kept all files open, but
this meant that the number of files that could be merged was limited
by the operating system’s open file limit. Version 8.1.0 opened files
as they were referenced and closed them after each read, but this
caused a major performance impact. Version 8.2.0 optimized the
performance but did so in a way that, for local file systems, there
was a small but unavoidable performance hit, but for networked file
systems, the performance impact could be very high. Starting with
version 8.2.1, the default behavior is that files are kept open if no
more than 200 files are specified, but this default behavior can be
explicitly overridden with the
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open</span></code> flag. If you are merging
more than 200 files but less than the operating system’s max open
files limit, you may want to use
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open=y</span></code>, especially if working
over a networked file system. If you are using a local file system
where the overhead is low and you might sometimes merge more than the
OS limit’s number of files from a script and are not worried about a
few seconds additional processing time, you may want to specify
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open=n</span></code>. The threshold for
switching may be changed from the default 200 with the
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open-threshold</span></code> option.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--keep-files-open-threshold=</span><em><span class="pre">count</span></em></code></dt><dd><p>If specified, overrides the default value of 200 used as the
threshold for qpdf deciding whether or not to keep files open. See
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open</span></code> for details.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--pages</span> <span class="pre">options</span> <span class="pre">--</span></code></dt><dd><p>Select specific pages from one or more input files. See <a class="reference internal" href="#page-selection"><span class="std std-ref">Page Selection Options</span></a> for details on how to do
page selection (splitting and merging).</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--collate=</span><em><span class="pre">n</span></em></code></dt><dd><p>When specified, collate rather than concatenate pages from files
specified with <code class="samp docutils literal notranslate"><span class="pre">--pages</span></code>. With a numeric
argument, collate in groups of <code class="samp docutils literal notranslate"><em><span class="pre">n</span></em></code>.
The default is 1. See <a class="reference internal" href="#page-selection"><span class="std std-ref">Page Selection Options</span></a> for additional details.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--flatten-rotation</span></code></dt><dd><p>For each page that is rotated using the <code class="docutils literal notranslate"><span class="pre">/Rotate</span></code> key in the page’s
dictionary, remove the <code class="docutils literal notranslate"><span class="pre">/Rotate</span></code> key and implement the identical
rotation semantics by modifying the page’s contents. This option can
be useful to prepare files for buggy PDF applications that don’t
properly handle rotated pages.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--split-pages=[n]</span></code></dt><dd><p>Write each group of <code class="samp docutils literal notranslate"><span class="pre">n</span></code> pages to a separate
output file. If <code class="samp docutils literal notranslate"><span class="pre">n</span></code> is not specified, create
single pages. Output file names are generated as follows:</p>
<ul class="simple">
<li><p>If the string <code class="docutils literal notranslate"><span class="pre">%d</span></code> appears in the output file name, it is
replaced with a range of zero-padded page numbers starting from 1.</p></li>
<li><p>Otherwise, if the output file name ends in
<code class="file docutils literal notranslate"><span class="pre">.pdf</span></code> (case insensitive), a zero-padded
page range, preceded by a dash, is inserted before the file
extension.</p></li>
<li><p>Otherwise, the file name is appended with a zero-padded page range
preceded by a dash.</p></li>
</ul>
<p>Page ranges are a single number in the case of single-page groups or
two numbers separated by a dash otherwise. For example, if
<code class="file docutils literal notranslate"><span class="pre">infile.pdf</span></code> has 12 pages</p>
<ul class="simple">
<li><p><strong class="command">qpdf --split-pages infile.pdf %d-out</strong>
would generate files <code class="file docutils literal notranslate"><span class="pre">01-out</span></code> through
<code class="file docutils literal notranslate"><span class="pre">12-out</span></code></p></li>
<li><p><strong class="command">qpdf --split-pages=2 infile.pdf
outfile.pdf</strong> would generate files
<code class="file docutils literal notranslate"><span class="pre">outfile-01-02.pdf</span></code> through
<code class="file docutils literal notranslate"><span class="pre">outfile-11-12.pdf</span></code></p></li>
<li><p><strong class="command">qpdf --split-pages infile.pdf
something.else</strong> would generate files
<code class="file docutils literal notranslate"><span class="pre">something.else-01</span></code> through
<code class="file docutils literal notranslate"><span class="pre">something.else-12</span></code></p></li>
</ul>
<p>Note that outlines, threads, and other global features of the
original PDF file are not preserved. For each page of output, this
option creates an empty PDF and copies a single page from the output
into it. If you require the global data, you will have to run
<strong class="command">qpdf</strong> with the
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> option once for each file. Using
<code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code> is much faster if you don’t
require the global data.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--overlay</span> <span class="pre">options</span> <span class="pre">--</span></code></dt><dd><p>Overlay pages from another file onto the output pages. See <a class="reference internal" href="#overlay-underlay"><span class="std std-ref">Overlay and Underlay Options</span></a> for details on
overlay/underlay.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--underlay</span> <span class="pre">options</span> <span class="pre">--</span></code></dt><dd><p>Overlay pages from another file onto the output pages. See <a class="reference internal" href="#overlay-underlay"><span class="std std-ref">Overlay and Underlay Options</span></a> for details on
overlay/underlay.</p>
</dd>
</dl>
<p>Password-protected files may be opened by specifying a password. By
default, qpdf will preserve any encryption data associated with a file.
If <code class="samp docutils literal notranslate"><span class="pre">--decrypt</span></code> is specified, qpdf will attempt to
remove any encryption information. If <code class="samp docutils literal notranslate"><span class="pre">--encrypt</span></code>
is specified, qpdf will replace the document’s encryption parameters
with whatever is specified.</p>
<p>Note that qpdf does not obey encryption restrictions already imposed on
the file. Doing so would be meaningless since qpdf can be used to remove
encryption from the file entirely. This functionality is not intended to
be used for bypassing copyright restrictions or other restrictions
placed on files by their producers.</p>
<p>Prior to 8.4.0, in the case of passwords that contain characters that
fall outside of 7-bit US-ASCII, qpdf left the burden of supplying
properly encoded encryption and decryption passwords to the user.
Starting in qpdf 8.4.0, qpdf does this automatically in most cases. For
an in-depth discussion, please see <a class="reference internal" href="#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a>. Previous versions of this manual
described workarounds using the <strong class="command">iconv</strong> command.
Such workarounds are no longer required or recommended with qpdf 8.4.0.
However, for backward compatibility, qpdf attempts to detect those
workarounds and do the right thing in most cases.</p>
</section>
<section id="encryption-options">
<span id="id4"></span><h3>Encryption Options<a class="headerlink" href="#encryption-options" title="Permalink to this headline"></a></h3>
<p>To change the encryption parameters of a file, use the –encrypt flag.
The syntax is</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>--encrypt user-password owner-password key-length [ restrictions ] --
</pre></div>
</div>
<p>Note that “<code class="samp docutils literal notranslate"><span class="pre">--</span></code>” terminates parsing of encryption
flags and must be present even if no restrictions are present.</p>
<p>Either or both of the user password and the owner password may be empty
strings. Starting in qpdf 10.2, qpdf defaults to not allowing creation
of PDF files with a non-empty user password, an empty owner password,
and a 256-bit key since such files can be opened with no password. If
you want to create such files, specify the encryption option
<code class="samp docutils literal notranslate"><span class="pre">--allow-insecure</span></code>, as described below.</p>
<p>The value for
<code class="samp docutils literal notranslate"><em><span class="pre">key-length</span></em></code> may
be 40, 128, or 256. The restriction flags are dependent upon key length.
When no additional restrictions are given, the default is to be fully
permissive.</p>
<p>If <code class="samp docutils literal notranslate"><em><span class="pre">key-length</span></em></code>
is 40, the following restriction options are available:</p>
<dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">--print=[yn]</span></code></dt><dd><p>Determines whether or not to allow printing.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--modify=[yn]</span></code></dt><dd><p>Determines whether or not to allow document modification.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--extract=[yn]</span></code></dt><dd><p>Determines whether or not to allow text/image extraction.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--annotate=[yn]</span></code></dt><dd><p>Determines whether or not to allow comments and form fill-in and
signing.</p>
</dd>
</dl>
<p>If <code class="samp docutils literal notranslate"><em><span class="pre">key-length</span></em></code>
is 128, the following restriction options are available:</p>
<dl>
<dt><code class="samp docutils literal notranslate"><span class="pre">--accessibility=[yn]</span></code></dt><dd><p>Determines whether or not to allow accessibility to visually
impaired. The qpdf library disregards this field when AES is used or
when 256-bit encryption is used. You should really never disable
accessibility, but qpdf lets you do it in case you need to configure
a file this way for testing purposes. The PDF spec says that
conforming readers should disregard this permission and always allow
accessibility.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--extract=[yn]</span></code></dt><dd><p>Determines whether or not to allow text/graphic extraction.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--assemble=[yn]</span></code></dt><dd><p>Determines whether document assembly (rotation and reordering of
pages) is allowed.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--annotate=[yn]</span></code></dt><dd><p>Determines whether modifying annotations is allowed. This includes
adding comments and filling in form fields. Also allows editing of
form fields if <code class="samp docutils literal notranslate"><span class="pre">--modify-other=y</span></code> is given.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--form=[yn]</span></code></dt><dd><p>Determines whether filling form fields is allowed.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--modify-other=[yn]</span></code></dt><dd><p>Allow all document editing except those controlled separately by the
<code class="samp docutils literal notranslate"><span class="pre">--assemble</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--annotate</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">--form</span></code> options.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--print=</span><em><span class="pre">print-opt</span></em></code></dt><dd><p>Controls printing access.
<code class="samp docutils literal notranslate"><em><span class="pre">print-opt</span></em></code>
may be one of the following:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">full</span></code>: allow full printing</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">low</span></code>: allow low-resolution printing only</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">none</span></code>: disallow printing</p></li>
</ul>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--modify=</span><em><span class="pre">modify-opt</span></em></code></dt><dd><p>Controls modify access. This way of controlling modify access has
less granularity than new options added in qpdf 8.4.
<code class="samp docutils literal notranslate"><em><span class="pre">modify-opt</span></em></code>
may be one of the following:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">all</span></code>: allow full document modification</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">annotate</span></code>: allow comment authoring, form
operations, and document assembly</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">form</span></code>: allow form field fill-in and signing
and document assembly</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">assembly</span></code>: allow document assembly only</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">none</span></code>: allow no modifications</p></li>
</ul>
<p>Using the <code class="samp docutils literal notranslate"><span class="pre">--modify</span></code> option does not allow you
to create certain combinations of permissions such as allowing form
filling but not allowing document assembly. Starting with qpdf 8.4,
you can either just use the other options to control fields
individually, or you can use something like <code class="samp docutils literal notranslate"><span class="pre">--modify=form</span>
<span class="pre">--assembly=n</span></code> to fine tune.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--cleartext-metadata</span></code></dt><dd><p>If specified, any metadata stream in the document will be left
unencrypted even if the rest of the document is encrypted. This also
forces the PDF version to be at least 1.5.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--use-aes=[yn]</span></code></dt><dd><p>If <code class="samp docutils literal notranslate"><span class="pre">--use-aes=y</span></code> is specified, AES encryption
will be used instead of RC4 encryption. This forces the PDF version
to be at least 1.6.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--allow-insecure</span></code></dt><dd><p>From qpdf 10.2, qpdf defaults to not allowing creation of PDF files
where the user password is non-empty, the owner password is empty,
and a 256-bit key is in use. Files created in this way are insecure
since they can be opened without a password. Users would ordinarily
never want to create such files. If you are using qpdf to
intentionally created strange files for testing (a definite valid use
of qpdf!), this option allows you to create such insecure files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--force-V4</span></code></dt><dd><p>Use of this option forces the <code class="docutils literal notranslate"><span class="pre">/V</span></code> and <code class="docutils literal notranslate"><span class="pre">/R</span></code> parameters in the
document’s encryption dictionary to be set to the value <code class="docutils literal notranslate"><span class="pre">4</span></code>. As
qpdf will automatically do this when required, there is no reason to
ever use this option. It exists primarily for use in testing qpdf
itself. This option also forces the PDF version to be at least 1.5.</p>
</dd>
</dl>
<p>If <code class="samp docutils literal notranslate"><em><span class="pre">key-length</span></em></code>
is 256, the minimum PDF version is 1.7 with extension level 8, and the
AES-based encryption format used is the PDF 2.0 encryption method
supported by Acrobat X. the same options are available as with 128 bits
with the following exceptions:</p>
<dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">--use-aes</span></code></dt><dd><p>This option is not available with 256-bit keys. AES is always used
with 256-bit encryption keys.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--force-V4</span></code></dt><dd><p>This option is not available with 256 keys.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--force-R5</span></code></dt><dd><p>If specified, qpdf sets the minimum version to 1.7 at extension level
3 and writes the deprecated encryption format used by Acrobat version
IX. This option should not be used in practice to generate PDF files
that will be in general use, but it can be useful to generate files
if you are trying to test proper support in another application for
PDF files encrypted in this way.</p>
</dd>
</dl>
<p>The default for each permission option is to be fully permissive.</p>
</section>
<section id="page-selection-options">
<span id="page-selection"></span><h3>Page Selection Options<a class="headerlink" href="#page-selection-options" title="Permalink to this headline"></a></h3>
<p>Starting with qpdf 3.0, it is possible to split and merge PDF files by
selecting pages from one or more input files. Whatever file is given as
the primary input file is used as the starting point, but its pages are
replaced with pages as specified.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>--pages input-file [ --password=password ] [ page-range ] [ ... ] --
</pre></div>
</div>
<p>Multiple input files may be specified. Each one is given as the name of
the input file, an optional password (if required to open the file), and
the range of pages. Note that “<code class="samp docutils literal notranslate"><span class="pre">--</span></code>” terminates
parsing of page selection flags.</p>
<p>Starting with qpf 8.4, the special input file name
“<code class="file docutils literal notranslate"><span class="pre">.</span></code>” can be used as a shortcut for the
primary input filename.</p>
<p>For each file that pages should be taken from, specify the file, a
password needed to open the file (if any), and a page range. The
password needs to be given only once per file. If any of the input files
are the same as the primary input file or the file used to copy
encryption parameters (if specified), you do not need to repeat the
password here. The same file can be repeated multiple times. If a file
that is repeated has a password, the password only has to be given the
first time. All non-page data (info, outlines, page numbers, etc.) are
taken from the primary input file. To discard these, use
<code class="samp docutils literal notranslate"><span class="pre">--empty</span></code> as the primary input.</p>
<p>Starting with qpdf 5.0.0, it is possible to omit the page range. If qpdf
sees a value in the place where it expects a page range and that value
is not a valid range but is a valid file name, qpdf will implicitly use
the range <code class="docutils literal notranslate"><span class="pre">1-z</span></code>, meaning that it will include all pages in the file.
This makes it possible to easily combine all pages in a set of files
with a command like <strong class="command">qpdf --empty out.pdf --pages *.pdf
--</strong>.</p>
<p>The page range is a set of numbers separated by commas, ranges of
numbers separated dashes, or combinations of those. The character “z”
represents the last page. A number preceded by an “r” indicates to count
from the end, so <code class="docutils literal notranslate"><span class="pre">r3-r1</span></code> would be the last three pages of the
document. Pages can appear in any order. Ranges can appear with a high
number followed by a low number, which causes the pages to appear in
reverse. Numbers may be repeated in a page range. A page range may be
optionally appended with <code class="docutils literal notranslate"><span class="pre">:even</span></code> or <code class="docutils literal notranslate"><span class="pre">:odd</span></code> to indicate only the even
or odd pages in the given range. Note that even and odd refer to the
positions within the specified, range, not whether the original number
is even or odd.</p>
<p>Example page ranges:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">1,3,5-9,15-12</span></code>: pages 1, 3, 5, 6, 7, 8, 9, 15, 14, 13, and 12 in
that order.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">z-1</span></code>: all pages in the document in reverse</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r3-r1</span></code>: the last three pages of the document</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r1-r3</span></code>: the last three pages of the document in reverse order</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1-20:even</span></code>: even pages from 2 to 20</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">5,7-9,12:odd</span></code>: pages 5, 8, and, 12, which are the pages in odd
positions from among the original range, which represents pages 5, 7,
8, 9, and 12.</p></li>
</ul>
<p>Starting in qpdf version 8.3, you can specify the
<code class="samp docutils literal notranslate"><span class="pre">--collate</span></code> option. Note that this option is
specified outside of <code class="samp docutils literal notranslate"><span class="pre">--pages ... --</span></code>. When
<code class="samp docutils literal notranslate"><span class="pre">--collate</span></code> is specified, it changes the meaning
of <code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> so that the specified files, as
modified by page ranges, are collated rather than concatenated. For
example, if you add the files <code class="file docutils literal notranslate"><span class="pre">odd.pdf</span></code> and
<code class="file docutils literal notranslate"><span class="pre">even.pdf</span></code> containing odd and even pages of a
document respectively, you could run <strong class="command">qpdf --collate odd.pdf
--pages odd.pdf even.pdf -- all.pdf</strong> to collate the pages.
This would pick page 1 from odd, page 1 from even, page 2 from odd, page
2 from even, etc. until all pages have been included. Any number of
files and page ranges can be specified. If any file has fewer pages,
that file is just skipped when its pages have all been included. For
example, if you ran <strong class="command">qpdf --collate --empty --pages a.pdf
1-5 b.pdf 6-4 c.pdf r1 -- out.pdf</strong>, you would get the
following pages in this order:</p>
<ul class="simple">
<li><p>a.pdf page 1</p></li>
<li><p>b.pdf page 6</p></li>
<li><p>c.pdf last page</p></li>
<li><p>a.pdf page 2</p></li>
<li><p>b.pdf page 5</p></li>
<li><p>a.pdf page 3</p></li>
<li><p>b.pdf page 4</p></li>
<li><p>a.pdf page 4</p></li>
<li><p>a.pdf page 5</p></li>
</ul>
<p>Starting in qpdf version 10.2, you may specify a numeric argument to
<code class="samp docutils literal notranslate"><span class="pre">--collate</span></code>. With
<code class="samp docutils literal notranslate"><span class="pre">--collate=</span><em><span class="pre">n</span></em></code>,
pull groups of <code class="samp docutils literal notranslate"><em><span class="pre">n</span></em></code> pages from each file,
again, stopping when there are no more pages. For example, if you ran
<strong class="command">qpdf --collate=2 --empty --pages a.pdf 1-5 b.pdf 6-4 c.pdf
r1 -- out.pdf</strong>, you would get the following pages in this
order:</p>
<ul class="simple">
<li><p>a.pdf page 1</p></li>
<li><p>a.pdf page 2</p></li>
<li><p>b.pdf page 6</p></li>
<li><p>b.pdf page 5</p></li>
<li><p>c.pdf last page</p></li>
<li><p>a.pdf page 3</p></li>
<li><p>a.pdf page 4</p></li>
<li><p>b.pdf page 4</p></li>
<li><p>a.pdf page 5</p></li>
</ul>
<p>Starting in qpdf version 8.3, when you split and merge files, any page
labels (page numbers) are preserved in the final file. It is expected
that more document features will be preserved by splitting and merging.
In the mean time, semantics of splitting and merging vary across
features. For example, the document’s outlines (bookmarks) point to
actual page objects, so if you select some pages and not others,
bookmarks that point to pages that are in the output file will work, and
remaining bookmarks will not work. A future version of
<strong class="command">qpdf</strong> may do a better job at handling these
issues. (Note that the qpdf library already contains all of the APIs
required in order to implement this in your own application if you need
it.) In the mean time, you can always use
<code class="samp docutils literal notranslate"><span class="pre">--empty</span></code> as the primary input file to avoid
copying all of that from the first file. For example, to take pages 1
through 5 from a <code class="file docutils literal notranslate"><span class="pre">infile.pdf</span></code> while preserving
all metadata associated with that file, you could use</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qpdf infile.pdf --pages . 1-5 -- outfile.pdf
</pre></div>
</div>
<p>If you wanted pages 1 through 5 from
<code class="file docutils literal notranslate"><span class="pre">infile.pdf</span></code> but you wanted the rest of the
metadata to be dropped, you could instead run</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qpdf --empty --pages infile.pdf 1-5 -- outfile.pdf
</pre></div>
</div>
<p>If you wanted to take pages 1 through 5 from
<code class="file docutils literal notranslate"><span class="pre">file1.pdf</span></code> and pages 11 through 15 from
<code class="file docutils literal notranslate"><span class="pre">file2.pdf</span></code> in reverse, taking document-level
metadata from <code class="file docutils literal notranslate"><span class="pre">file2.pdf</span></code>, you would run</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qpdf file2.pdf --pages file1.pdf 1-5 . 15-11 -- outfile.pdf
</pre></div>
</div>
<p>If, for some reason, you wanted to take the first page of an encrypted
file called <code class="file docutils literal notranslate"><span class="pre">encrypted.pdf</span></code> with password
<code class="docutils literal notranslate"><span class="pre">pass</span></code> and repeat it twice in an output file, and if you wanted to
drop document-level metadata but preserve encryption, you would use</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>qpdf --empty --copy-encryption=encrypted.pdf \
     --encryption-file-password=pass \
     --pages encrypted.pdf --password=pass 1 \
           ./encrypted.pdf --password=pass 1 -- \
     outfile.pdf
</pre></div>
</div>
<p>Note that we had to specify the password all three times because giving
a password as <code class="samp docutils literal notranslate"><span class="pre">--encryption-file-password</span></code> doesn’t
count for page selection, and as far as qpdf is concerned,
<code class="file docutils literal notranslate"><span class="pre">encrypted.pdf</span></code> and
<code class="file docutils literal notranslate"><span class="pre">./encrypted.pdf</span></code> are separated files. These
are all corner cases that most users should hopefully never have to be
bothered with.</p>
<p>Prior to version 8.4, it was not possible to specify the same page from
the same file directly more than once, and the workaround of specifying
the same file in more than one way was required. Version 8.4 removes
this limitation, but there is still a valid use case. When you specify
the same page from the same file more than once, qpdf will share objects
between the pages. If you are going to do further manipulation on the
file and need the two instances of the same original page to be deep
copies, then you can specify the file in two different ways. For example
<strong class="command">qpdf in.pdf --pages . 1 ./in.pdf 1 -- out.pdf</strong>
would create a file with two copies of the first page of the input, and
the two copies would share any objects in common. This includes fonts,
images, and anything else the page references.</p>
</section>
<section id="overlay-and-underlay-options">
<span id="overlay-underlay"></span><h3>Overlay and Underlay Options<a class="headerlink" href="#overlay-and-underlay-options" title="Permalink to this headline"></a></h3>
<p>Starting with qpdf 8.4, it is possible to overlay or underlay pages from
other files onto the output generated by qpdf. Specify overlay or
underlay as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ --overlay | --underlay } file [ options ] --
</pre></div>
</div>
<p>Overlay and underlay options are processed late, so they can be combined
with other like merging and will apply to the final output. The
<code class="samp docutils literal notranslate"><span class="pre">--overlay</span></code> and <code class="samp docutils literal notranslate"><span class="pre">--underlay</span></code>
options work the same way, except underlay pages are drawn underneath
the page to which they are applied, possibly obscured by the original
page, and overlay files are drawn on top of the page to which they are
applied, possibly obscuring the page. You can combine overlay and
underlay.</p>
<p>The default behavior of overlay and underlay is that pages are taken
from the overlay/underlay file in sequence and applied to corresponding
pages in the output until there are no more output pages. If the overlay
or underlay file runs out of pages, remaining output pages are left
alone. This behavior can be modified by options, which are provided
between the <code class="samp docutils literal notranslate"><span class="pre">--overlay</span></code> or
<code class="samp docutils literal notranslate"><span class="pre">--underlay</span></code> flag and the
<code class="samp docutils literal notranslate"><span class="pre">--</span></code> option. The following options are supported:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">--password=password</span></code>: supply a password if the
overlay/underlay file is encrypted.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--to=page-range</span></code>: a range of pages in the same
form at described in <a class="reference internal" href="#page-selection"><span class="std std-ref">Page Selection Options</span></a>
indicates which pages in the output should have the overlay/underlay
applied. If not specified, overlay/underlay are applied to all pages.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--from=[page-range]</span></code>: a range of pages that
specifies which pages in the overlay/underlay file will be used for
overlay or underlay. If not specified, all pages will be used. This
can be explicitly specified to be empty if
<code class="samp docutils literal notranslate"><span class="pre">--repeat</span></code> is used.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--repeat=page-range</span></code>: an optional range of
pages that specifies which pages in the overlay/underlay file will be
repeated after the “from” pages are used up. If you want to repeat a
range of pages starting at the beginning, you can explicitly use
<code class="samp docutils literal notranslate"><span class="pre">--from=</span></code>.</p></li>
</ul>
<p>Here are some examples.</p>
<ul class="simple">
<li><p><strong class="command">--overlay o.pdf --to=1-5 --from=1-3 --repeat=4
--</strong>: overlay the first three pages from file
<code class="file docutils literal notranslate"><span class="pre">o.pdf</span></code> onto the first three pages of the
output, then overlay page 4 from <code class="file docutils literal notranslate"><span class="pre">o.pdf</span></code>
onto pages 4 and 5 of the output. Leave remaining output pages
untouched.</p></li>
<li><p><strong class="command">--underlay footer.pdf --from= --repeat=1,2
--</strong>: Underlay page 1 of
<code class="file docutils literal notranslate"><span class="pre">footer.pdf</span></code> on all odd output pages, and
underlay page 2 of <code class="file docutils literal notranslate"><span class="pre">footer.pdf</span></code> on all even
output pages.</p></li>
</ul>
</section>
<section id="embedded-files-attachments-options">
<span id="attachments"></span><h3>Embedded Files/Attachments Options<a class="headerlink" href="#embedded-files-attachments-options" title="Permalink to this headline"></a></h3>
<p>Starting with qpdf 10.2, you can work with file attachments in PDF files
from the command line. The following options are available:</p>
<dl>
<dt><code class="samp docutils literal notranslate"><span class="pre">--list-attachments</span></code></dt><dd><p>Show the “key” and stream number for embedded files. With
<code class="samp docutils literal notranslate"><span class="pre">--verbose</span></code>, additional information, including
preferred file name, description, dates, and more are also displayed.
The key is usually but not always equal to the file name, and is
needed by some of the other options.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-attachment=</span><em><span class="pre">key</span></em></code></dt><dd><p>Write the contents of the specified attachment to standard output as
binary data. The key should match one of the keys shown by
<code class="samp docutils literal notranslate"><span class="pre">--list-attachments</span></code>. If specified multiple
times, only the last attachment will be shown.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--add-attachment</span> <em><span class="pre">file</span></em> <em><span class="pre">options</span></em> <span class="pre">--</span></code></dt><dd><p>Add or replace an attachment with the contents of
<code class="samp docutils literal notranslate"><em><span class="pre">file</span></em></code>. This may be specified more
than once. The following additional options may appear before the
<code class="docutils literal notranslate"><span class="pre">--</span></code> that ends this option:</p>
<dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">--key=</span><em><span class="pre">key</span></em></code></dt><dd><p>The key to use to register the attachment in the embedded files
table. Defaults to the last path element of
<code class="samp docutils literal notranslate"><em><span class="pre">file</span></em></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--filename=</span><em><span class="pre">name</span></em></code></dt><dd><p>The file name to be used for the attachment. This is what is
usually displayed to the user and is the name most graphical PDF
viewers will use when saving a file. It defaults to the last path
element of <code class="samp docutils literal notranslate"><em><span class="pre">file</span></em></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--creationdate=</span><em><span class="pre">date</span></em></code></dt><dd><p>The attachment’s creation date in PDF format; defaults to the
current time. The date format is explained below.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--moddate=</span><em><span class="pre">date</span></em></code></dt><dd><p>The attachment’s modification date in PDF format; defaults to the
current time. The date format is explained below.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--mimetype=</span><em><span class="pre">type/subtype</span></em></code></dt><dd><p>The mime type for the attachment, e.g. <code class="docutils literal notranslate"><span class="pre">text/plain</span></code> or
<code class="docutils literal notranslate"><span class="pre">application/pdf</span></code>. Note that the mimetype appears in a field
called <code class="docutils literal notranslate"><span class="pre">/Subtype</span></code> in the PDF but actually includes the full type
and subtype of the mime type.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--description=</span><em><span class="pre">&quot;text&quot;</span></em></code></dt><dd><p>Descriptive text for the attachment, displayed by some PDF
viewers.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--replace</span></code></dt><dd><p>Indicates that any existing attachment with the same key should be
replaced by the new attachment. Otherwise,
<strong class="command">qpdf</strong> gives an error if an attachment
with that key is already present.</p>
</dd>
</dl>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--remove-attachment=</span><em><span class="pre">key</span></em></code></dt><dd><p>Remove the specified attachment. This doesn’t only remove the
attachment from the embedded files table but also clears out the file
specification. That means that any potential internal links to the
attachment will be broken. This option may be specified multiple
times. Run with <code class="samp docutils literal notranslate"><span class="pre">--verbose</span></code> to see status of
the removal.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--copy-attachments-from</span> <em><span class="pre">file</span></em> <em><span class="pre">options</span></em> <span class="pre">--</span></code></dt><dd><p>Copy attachments from another file. This may be specified more than
once. The following additional options may appear before the <code class="docutils literal notranslate"><span class="pre">--</span></code>
that ends this option:</p>
<dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">--password=</span><em><span class="pre">password</span></em></code></dt><dd><p>If required, the password needed to open
<code class="samp docutils literal notranslate"><em><span class="pre">file</span></em></code></p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--prefix=</span><em><span class="pre">prefix</span></em></code></dt><dd><p>Only required if the file from which attachments are being copied
has attachments with keys that conflict with attachments already
in the file. In this case, the specified prefix will be prepended
to each key. This affects only the key in the embedded files
table, not the file name. The PDF specification doesn’t preclude
multiple attachments having the same file name.</p>
</dd>
</dl>
</dd>
</dl>
<p>When a date is required, the date should conform to the PDF date format
specification, which is
<code class="docutils literal notranslate"><span class="pre">D:</span></code><code class="samp docutils literal notranslate"><em><span class="pre">yyyymmddhhmmss&lt;z&gt;</span></em></code>, where
<code class="samp docutils literal notranslate"><em><span class="pre">&lt;z&gt;</span></em></code> is either <code class="docutils literal notranslate"><span class="pre">Z</span></code> for UTC or a
timezone offset in the form <code class="samp docutils literal notranslate"><em><span class="pre">-hh'mm'</span></em></code> or
<code class="samp docutils literal notranslate"><em><span class="pre">+hh'mm'</span></em></code>. Examples:
<code class="docutils literal notranslate"><span class="pre">D:20210207161528-05'00'</span></code>, <code class="docutils literal notranslate"><span class="pre">D:20210207211528Z</span></code>.</p>
</section>
<section id="advanced-parsing-options">
<span id="advanced-parsing"></span><h3>Advanced Parsing Options<a class="headerlink" href="#advanced-parsing-options" title="Permalink to this headline"></a></h3>
<p>These options control aspects of how qpdf reads PDF files. Mostly these
are of use to people who are working with damaged files. There is little
reason to use these options unless you are trying to solve specific
problems. The following options are available:</p>
<dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">--suppress-recovery</span></code></dt><dd><p>Prevents qpdf from attempting to recover damaged files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--ignore-xref-streams</span></code></dt><dd><p>Tells qpdf to ignore any cross-reference streams.</p>
</dd>
</dl>
<p>Ordinarily, qpdf will attempt to recover from certain types of errors in
PDF files. These include errors in the cross-reference table, certain
types of object numbering errors, and certain types of stream length
errors. Sometimes, qpdf may think it has recovered but may not have
actually recovered, so care should be taken when using this option as
some data loss is possible. The
<code class="samp docutils literal notranslate"><span class="pre">--suppress-recovery</span></code> option will prevent qpdf
from attempting recovery. In this case, it will fail on the first error
that it encounters.</p>
<p>Ordinarily, qpdf reads cross-reference streams when they are present in
a PDF file. If <code class="samp docutils literal notranslate"><span class="pre">--ignore-xref-streams</span></code> is
specified, qpdf will ignore any cross-reference streams for hybrid PDF
files. The purpose of hybrid files is to make some content available to
viewers that are not aware of cross-reference streams. It is almost
never desirable to ignore them. The only time when you might want to use
this feature is if you are testing creation of hybrid PDF files and wish
to see how a PDF consumer that doesn’t understand object and
cross-reference streams would interpret such a file.</p>
</section>
<section id="advanced-transformation-options">
<span id="advanced-transformation"></span><h3>Advanced Transformation Options<a class="headerlink" href="#advanced-transformation-options" title="Permalink to this headline"></a></h3>
<p>These transformation options control fine points of how qpdf creates the
output file. Mostly these are of use only to people who are very
familiar with the PDF file format or who are PDF developers. The
following options are available:</p>
<dl>
<dt><code class="samp docutils literal notranslate"><span class="pre">--compress-streams=</span><em><span class="pre">[yn]</span></em></code></dt><dd><p>By default, or with <code class="samp docutils literal notranslate"><span class="pre">--compress-streams=y</span></code>,
qpdf will compress any stream with no other filters applied to it
with the <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code> filter when it writes it. To suppress this
behavior and preserve uncompressed streams as uncompressed, use
<code class="samp docutils literal notranslate"><span class="pre">--compress-streams=n</span></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--decode-level=</span><em><span class="pre">option</span></em></code></dt><dd><p>Controls which streams qpdf tries to decode. The default is
<code class="samp docutils literal notranslate"><span class="pre">generalized</span></code>. The following options are
available:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">none</span></code>: do not attempt to decode any streams</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">generalized</span></code>: decode streams filtered with
supported generalized filters: <code class="docutils literal notranslate"><span class="pre">/LZWDecode</span></code>, <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code>,
<code class="docutils literal notranslate"><span class="pre">/ASCII85Decode</span></code>, and <code class="docutils literal notranslate"><span class="pre">/ASCIIHexDecode</span></code>. We define generalized
filters as those to be used for general-purpose compression or
encoding, as opposed to filters specifically designed for image
data. Note that, by default, streams already compressed with
<code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code> are not uncompressed and recompressed unless you
also specify <code class="samp docutils literal notranslate"><span class="pre">--recompress-flate</span></code>.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">specialized</span></code>: in addition to generalized,
decode streams with supported non-lossy specialized filters;
currently this is just <code class="docutils literal notranslate"><span class="pre">/RunLengthDecode</span></code></p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">all</span></code>: in addition to generalized and
specialized, decode streams with supported lossy filters;
currently this is just <code class="docutils literal notranslate"><span class="pre">/DCTDecode</span></code> (JPEG)</p></li>
</ul>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--stream-data=</span><em><span class="pre">option</span></em></code></dt><dd><p>Controls transformation of stream data. This option predates the
<code class="samp docutils literal notranslate"><span class="pre">--compress-streams</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--decode-level</span></code> options. Those options can be
used to achieve the same affect with more control. The value of
<code class="samp docutils literal notranslate"><em><span class="pre">option</span></em></code> may
be one of the following:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">compress</span></code>: recompress stream data when
possible (default); equivalent to
<code class="samp docutils literal notranslate"><span class="pre">--compress-streams=y</span></code>
<code class="samp docutils literal notranslate"><span class="pre">--decode-level=generalized</span></code>. Does not
recompress streams already compressed with <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code> unless
<code class="samp docutils literal notranslate"><span class="pre">--recompress-flate</span></code> is also specified.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">preserve</span></code>: leave all stream data as is;
equivalent to <code class="samp docutils literal notranslate"><span class="pre">--compress-streams=n</span></code>
<code class="samp docutils literal notranslate"><span class="pre">--decode-level=none</span></code></p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">uncompress</span></code>: uncompress stream data
compressed with generalized filters when possible; equivalent to
<code class="samp docutils literal notranslate"><span class="pre">--compress-streams=n</span></code>
<code class="samp docutils literal notranslate"><span class="pre">--decode-level=generalized</span></code></p></li>
</ul>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--recompress-flate</span></code></dt><dd><p>By default, streams already compressed with <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code> are left
alone rather than being uncompressed and recompressed. This option
causes qpdf to uncompress and recompress the streams. There is a
significant performance cost to using this option, but you probably
want to use it if you specify
<code class="samp docutils literal notranslate"><span class="pre">--compression-level</span></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--compression-level=</span><em><span class="pre">level</span></em></code></dt><dd><p>When writing new streams that are compressed with <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code>,
use the specified compression level. The value of
<code class="samp docutils literal notranslate"><span class="pre">level</span></code> should be a number from 1 to 9 and is
passed directly to zlib, which implements deflate compression. Note
that qpdf doesn’t uncompress and recompress streams by default. To
have this option apply to already compressed streams, you should also
specify <code class="samp docutils literal notranslate"><span class="pre">--recompress-flate</span></code>. If your goal is
to shrink the size of PDF files, you should also use
<code class="samp docutils literal notranslate"><span class="pre">--object-streams=generate</span></code>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--normalize-content=[yn]</span></code></dt><dd><p>Enables or disables normalization of content streams. Content
normalization is enabled by default in QDF mode. Please see <a class="reference internal" href="index.html#qdf"><span class="std std-ref">QDF Mode</span></a> for additional discussion of QDF mode.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--object-streams=</span><em><span class="pre">mode</span></em></code></dt><dd><p>Controls handling of object streams. The value of
<code class="samp docutils literal notranslate"><em><span class="pre">mode</span></em></code> may be
one of the following:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">preserve</span></code>: preserve original object streams
(default)</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">disable</span></code>: don’t write any object streams</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">generate</span></code>: use object streams wherever
possible</p></li>
</ul>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced</span></code></dt><dd><p>Tells qpdf to preserve objects that are not referenced when writing
the file. Ordinarily any object that is not referenced in a traversal
of the document from the trailer dictionary will be discarded. This
may be useful in working with some damaged files or inspecting files
with known unreferenced objects.</p>
<p>This flag is ignored for linearized files and has the effect of
causing objects in the new file to be written in order by object ID
from the original file. This does not mean that object numbers will
be the same since qpdf may create stream lengths as direct or
indirect differently from the original file, and the original file
may have gaps in its numbering.</p>
<p>See also <code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced-resources</span></code>,
which does something completely different.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--remove-unreferenced-resources=</span><em><span class="pre">option</span></em></code></dt><dd><p>The <code class="samp docutils literal notranslate"><em><span class="pre">option</span></em></code> may be <code class="docutils literal notranslate"><span class="pre">auto</span></code>,
<code class="docutils literal notranslate"><span class="pre">yes</span></code>, or <code class="docutils literal notranslate"><span class="pre">no</span></code>. The default is <code class="docutils literal notranslate"><span class="pre">auto</span></code>.</p>
<p>Starting with qpdf 8.1, when splitting pages, qpdf is able to attempt
to remove images and fonts that are not used by a page even if they
are referenced in the page’s resources dictionary. When shared
resources are in use, this behavior can greatly reduce the file sizes
of split pages, but the analysis is very slow. In versions from 8.1
through 9.1.1, qpdf did this analysis by default. Starting in qpdf
10.0.0, if <code class="docutils literal notranslate"><span class="pre">auto</span></code> is used, qpdf does a quick analysis of the file
to determine whether the file is likely to have unreferenced objects
on pages, a pattern that frequently occurs when resource dictionaries
are shared across multiple pages and rarely occurs otherwise. If it
discovers this pattern, then it will attempt to remove unreferenced
resources. Usually this means you get the slower splitting speed only
when it’s actually going to create smaller files. You can suppress
removal of unreferenced resources altogether by specifying <code class="docutils literal notranslate"><span class="pre">no</span></code> or
force it to do the full algorithm by specifying <code class="docutils literal notranslate"><span class="pre">yes</span></code>.</p>
<p>Other than cases in which you don’t care about file size and care a
lot about runtime, there are few reasons to use this option,
especially now that <code class="docutils literal notranslate"><span class="pre">auto</span></code> mode is supported. One reason to use
this is if you suspect that qpdf is removing resources it shouldn’t
be removing. If you encounter that case, please report it as bug at
<a class="reference external" href="https://github.com/qpdf/qpdf/issues/">https://github.com/qpdf/qpdf/issues/</a>.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced-resources</span></code></dt><dd><p>This is a synonym for
<code class="samp docutils literal notranslate"><span class="pre">--remove-unreferenced-resources=no</span></code>.</p>
<p>See also <code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced</span></code>, which does
something completely different.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--newline-before-endstream</span></code></dt><dd><p>Tells qpdf to insert a newline before the <code class="docutils literal notranslate"><span class="pre">endstream</span></code> keyword, not
counted in the length, after any stream content even if the last
character of the stream was a newline. This may result in two
newlines in some cases. This is a requirement of PDF/A. While qpdf
doesn’t specifically know how to generate PDF/A-compliant PDFs, this
at least prevents it from removing compliance on already compliant
files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--linearize-pass1=</span><em><span class="pre">file</span></em></code></dt><dd><p>Write the first pass of linearization to the named file. The
resulting file is not a valid PDF file. This option is useful only
for debugging <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>’s linearization code. When qpdf
linearizes files, it writes the file in two passes, using the first
pass to calculate sizes and offsets that are required for hint tables
and the linearization dictionary. Ordinarily, the first pass is
discarded. This option enables it to be captured.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--coalesce-contents</span></code></dt><dd><p>When a page’s contents are split across multiple streams, this option
causes qpdf to combine them into a single stream. Use of this option
is never necessary for ordinary usage, but it can help when working
with some files in some cases. For example, this can also be combined
with QDF mode or content normalization to make it easier to look at
all of a page’s contents at once.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--flatten-annotations=</span><em><span class="pre">option</span></em></code></dt><dd><p>This option collapses annotations into the pages’ contents with
special handling for form fields. Ordinarily, an annotation is
rendered separately and on top of the page. Combining annotations
into the page’s contents effectively freezes the placement of the
annotations, making them look right after various page
transformations. The library functionality backing this option was
added for the benefit of programs that want to create <em>n-up</em> page
layouts and other similar things that don’t work well with
annotations. The <code class="samp docutils literal notranslate"><em><span class="pre">option</span></em></code> parameter
may be any of the following:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">all</span></code>: include all annotations that are not
marked invisible or hidden</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">print</span></code>: only include annotations that
indicate that they should appear when the page is printed</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">screen</span></code>: omit annotations that indicate
they should not appear on the screen</p></li>
</ul>
<p>Note that form fields are special because the annotations that are
used to render filled-in form fields may become out of date from the
fields’ values if the form is filled in by a program that doesn’t
know how to update the appearances. If qpdf detects this case, its
default behavior is not to flatten those annotations because doing so
would cause the value of the form field to be lost. This gives you a
chance to go back and resave the form with a program that knows how
to generate appearances. QPDF itself can generate appearances with
some limitations. See the
<code class="samp docutils literal notranslate"><span class="pre">--generate-appearances</span></code> option below.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--generate-appearances</span></code></dt><dd><p>If a file contains interactive form fields and indicates that the
appearances are out of date with the values of the form, this flag
will regenerate appearances, subject to a few limitations. Note that
there is not usually a reason to do this, but it can be necessary
before using the <code class="samp docutils literal notranslate"><span class="pre">--flatten-annotations</span></code>
option. Most of these are not a problem with well-behaved PDF files.
The limitations are as follows:</p>
<ul class="simple">
<li><p>Radio button and checkbox appearances use the pre-set values in
the PDF file. QPDF just makes sure that the correct appearance is
displayed based on the value of the field. This is fine for PDF
files that create their forms properly. Some PDF writers save
appearances for fields when they change, which could cause some
controls to have inconsistent appearances.</p></li>
<li><p>For text fields and list boxes, any characters that fall outside
of US-ASCII or, if detected, “Windows ANSI” or “Mac Roman”
encoding, will be replaced by the <code class="docutils literal notranslate"><span class="pre">?</span></code> character.</p></li>
<li><p>Quadding is ignored. Quadding is used to specify whether the
contents of a field should be left, center, or right aligned with
the field.</p></li>
<li><p>Rich text, multi-line, and other more elaborate formatting
directives are ignored.</p></li>
<li><p>There is no support for multi-select fields or signature fields.</p></li>
</ul>
<p>If qpdf doesn’t do a good enough job with your form, use an external
application to save your filled-in form before processing it with
qpdf.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--optimize-images</span></code></dt><dd><p>This flag causes qpdf to recompress all images that are not
compressed with DCT (JPEG) using DCT compression as long as doing so
decreases the size in bytes of the image data and the image does not
fall below minimum specified dimensions. Useful information is
provided when used in combination with
<code class="samp docutils literal notranslate"><span class="pre">--verbose</span></code>. See also the
<code class="samp docutils literal notranslate"><span class="pre">--oi-min-width</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--oi-min-height</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">--oi-min-area</span></code> options. By default, starting
in qpdf 8.4, inline images are converted to regular images and
optimized as well. Use <code class="samp docutils literal notranslate"><span class="pre">--keep-inline-images</span></code>
to prevent inline images from being included.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--oi-min-width=</span><em><span class="pre">width</span></em></code></dt><dd><p>Avoid optimizing images whose width is below the specified amount. If
omitted, the default is 128 pixels. Use 0 for no minimum.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--oi-min-height=</span><em><span class="pre">height</span></em></code></dt><dd><p>Avoid optimizing images whose height is below the specified amount.
If omitted, the default is 128 pixels. Use 0 for no minimum.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--oi-min-area=</span><em><span class="pre">area-in-pixels</span></em></code></dt><dd><p>Avoid optimizing images whose pixel count (width × height) is below
the specified amount. If omitted, the default is 16,384 pixels. Use 0
for no minimum.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--externalize-inline-images</span></code></dt><dd><p>Convert inline images to regular images. By default, images whose
data is at least 1,024 bytes are converted when this option is
selected. Use <code class="samp docutils literal notranslate"><span class="pre">--ii-min-bytes</span></code> to change the
size threshold. This option is implicitly selected when
<code class="samp docutils literal notranslate"><span class="pre">--optimize-images</span></code> is selected. Use
<code class="samp docutils literal notranslate"><span class="pre">--keep-inline-images</span></code> to exclude inline images
from image optimization.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--ii-min-bytes=</span><em><span class="pre">bytes</span></em></code></dt><dd><p>Avoid converting inline images whose size is below the specified
minimum size to regular images. If omitted, the default is 1,024
bytes. Use 0 for no minimum.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--keep-inline-images</span></code></dt><dd><p>Prevent inline images from being included in image optimization. This
option has no affect when <code class="samp docutils literal notranslate"><span class="pre">--optimize-images</span></code>
is not specified.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--remove-page-labels</span></code></dt><dd><p>Remove page labels from the output file.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--qdf</span></code></dt><dd><p>Turns on QDF mode. For additional information on QDF, please see <a class="reference internal" href="index.html#qdf"><span class="std std-ref">QDF Mode</span></a>. Note that <code class="samp docutils literal notranslate"><span class="pre">--linearize</span></code>
disables QDF mode.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--min-version=</span><em><span class="pre">version</span></em></code></dt><dd><p>Forces the PDF version of the output file to be at least
<code class="samp docutils literal notranslate"><em><span class="pre">version</span></em></code>. In other words, if the
input file has a lower version than the specified version, the
specified version will be used. If the input file has a higher
version, the input file’s original version will be used. It is seldom
necessary to use this option since qpdf will automatically increase
the version as needed when adding features that require newer PDF
readers.</p>
<p>The version number may be expressed in the form
<code class="samp docutils literal notranslate"><em><span class="pre">major.minor.extension-level</span></em></code>, in
which case the version is interpreted as
<code class="samp docutils literal notranslate"><em><span class="pre">major.minor</span></em></code> at extension level
<code class="samp docutils literal notranslate"><em><span class="pre">extension-level</span></em></code>. For example,
version <code class="docutils literal notranslate"><span class="pre">1.7.8</span></code> represents version 1.7 at extension level 8. Note
that minimal syntax checking is done on the command line.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--force-version=</span><em><span class="pre">version</span></em></code></dt><dd><p>This option forces the PDF version to be the exact version specified
<em>even when the file may have content that is not supported in that
version</em>. The version number is interpreted in the same way as with
<code class="samp docutils literal notranslate"><span class="pre">--min-version</span></code> so that extension levels can be
set. In some cases, forcing the output file’s PDF version to be lower
than that of the input file will cause qpdf to disable certain
features of the document. Specifically, 256-bit keys are disabled if
the version is less than 1.7 with extension level 8 (except R5 is
disabled if less than 1.7 with extension level 3), AES encryption is
disabled if the version is less than 1.6, cleartext metadata and
object streams are disabled if less than 1.5, 128-bit encryption keys
are disabled if less than 1.4, and all encryption is disabled if less
than 1.3. Even with these precautions, qpdf won’t be able to do
things like eliminate use of newer image compression schemes,
transparency groups, or other features that may have been added in
more recent versions of PDF.</p>
<p>As a general rule, with the exception of big structural things like
the use of object streams or AES encryption, PDF viewers are supposed
to ignore features in files that they don’t support from newer
versions. This means that forcing the version to a lower version may
make it possible to open your PDF file with an older version, though
bear in mind that some of the original document’s functionality may
be lost.</p>
</dd>
</dl>
<p>By default, when a stream is encoded using non-lossy filters that qpdf
understands and is not already compressed using a good compression
scheme, qpdf will uncompress and recompress streams. Assuming proper
filter implements, this is safe and generally results in smaller files.
This behavior may also be explicitly requested with
<code class="samp docutils literal notranslate"><span class="pre">--stream-data=compress</span></code>.</p>
<p>When <code class="samp docutils literal notranslate"><span class="pre">--normalize-content=y</span></code> is specified, qpdf
will attempt to normalize whitespace and newlines in page content
streams. This is generally safe but could, in some cases, cause damage
to the content streams. This option is intended for people who wish to
study PDF content streams or to debug PDF content. You should not use
this for “production” PDF files.</p>
<p>When normalizing content, if qpdf runs into any lexical errors, it will
print a warning indicating that content may be damaged. The only
situation in which qpdf is known to cause damage during content
normalization is when a page’s contents are split across multiple
streams and streams are split in the middle of a lexical token such as a
string, name, or inline image. Note that files that do this are invalid
since the PDF specification states that content streams are not to be
split in the middle of a token. If you want to inspect the original
content streams in an uncompressed format, you can always run with
<code class="samp docutils literal notranslate"><span class="pre">--qdf</span> <span class="pre">--normalize-content=n</span></code> for a QDF file
without content normalization, or alternatively
<code class="samp docutils literal notranslate"><span class="pre">--stream-data=uncompress</span></code> for a regular non-QDF
mode file with uncompressed streams. These will both uncompress all the
streams but will not attempt to normalize content. Please note that if
you are using content normalization or QDF mode for the purpose of
manually inspecting files, you don’t have to care about this.</p>
<p>Object streams, also known as compressed objects, were introduced into
the PDF specification at version 1.5, corresponding to Acrobat 6. Some
older PDF viewers may not support files with object streams. qpdf can be
used to transform files with object streams to files without object
streams or vice versa. As mentioned above, there are three object stream
modes: <code class="samp docutils literal notranslate"><span class="pre">preserve</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">disable</span></code>, and <code class="samp docutils literal notranslate"><span class="pre">generate</span></code>.</p>
<p>In <code class="samp docutils literal notranslate"><span class="pre">preserve</span></code> mode, the relationship to objects
and the streams that contain them is preserved from the original file.
In <code class="samp docutils literal notranslate"><span class="pre">disable</span></code> mode, all objects are written as
regular, uncompressed objects. The resulting file should be readable by
older PDF viewers. (Of course, the content of the files may include
features not supported by older viewers, but at least the structure will
be supported.) In <code class="samp docutils literal notranslate"><span class="pre">generate</span></code> mode, qpdf will
create its own object streams. This will usually result in more compact
PDF files, though they may not be readable by older viewers. In this
mode, qpdf will also make sure the PDF version number in the header is
at least 1.5.</p>
<p>The <code class="samp docutils literal notranslate"><span class="pre">--qdf</span></code> flag turns on QDF mode, which changes
some of the defaults described above. Specifically, in QDF mode, by
default, stream data is uncompressed, content streams are normalized,
and encryption is removed. These defaults can still be overridden by
specifying the appropriate options as described above. Additionally, in
QDF mode, stream lengths are stored as indirect objects, objects are
laid out in a less efficient but more readable fashion, and the
documents are interspersed with comments that make it easier for the
user to find things and also make it possible for
<strong class="command">fix-qdf</strong> to work properly. QDF mode is intended
for people, mostly developers, who wish to inspect or modify PDF files
in a text editor. For details, please see <a class="reference internal" href="index.html#qdf"><span class="std std-ref">QDF Mode</span></a>.</p>
</section>
<section id="testing-inspection-and-debugging-options">
<span id="testing-options"></span><h3>Testing, Inspection, and Debugging Options<a class="headerlink" href="#testing-inspection-and-debugging-options" title="Permalink to this headline"></a></h3>
<p>These options can be useful for digging into PDF files or for use in
automated test suites for software that uses the qpdf library. When any
of the options in this section are specified, no output file should be
given. The following options are available:</p>
<dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">--deterministic-id</span></code></dt><dd><p>Causes generation of a deterministic value for /ID. This prevents use
of timestamp and output file name information in the /ID generation.
Instead, at some slight additional runtime cost, the /ID field is
generated to include a digest of the significant parts of the content
of the output PDF file. This means that a given qpdf operation should
generate the same /ID each time it is run, which can be useful when
caching results or for generation of some test data. Use of this flag
is not compatible with creation of encrypted files.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--static-id</span></code></dt><dd><p>Causes generation of a fixed value for /ID. This is intended for
testing only. Never use it for production files. If you are trying to
get the same /ID each time for a given file and you are not
generating encrypted files, consider using the
<code class="samp docutils literal notranslate"><span class="pre">--deterministic-id</span></code> option.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--static-aes-iv</span></code></dt><dd><p>Causes use of a static initialization vector for AES-CBC. This is
intended for testing only so that output files can be reproducible.
Never use it for production files. This option in particular is not
secure since it significantly weakens the encryption.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--no-original-object-ids</span></code></dt><dd><p>Suppresses inclusion of original object ID comments in QDF files.
This can be useful when generating QDF files for test purposes,
particularly when comparing them to determine whether two PDF files
have identical content.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-encryption</span></code></dt><dd><p>Shows document encryption parameters. Also shows the document’s user
password if the owner password is given.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-encryption-key</span></code></dt><dd><p>When encryption information is being displayed, as when
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> or
<code class="samp docutils literal notranslate"><span class="pre">--show-encryption</span></code> is given, display the
computed or retrieved encryption key as a hexadecimal string. This
value is not ordinarily useful to users, but it can be used as the
argument to <code class="samp docutils literal notranslate"><span class="pre">--password</span></code> if the
<code class="samp docutils literal notranslate"><span class="pre">--password-is-hex-key</span></code> is specified. Note
that, when PDF files are encrypted, passwords and other metadata are
used only to compute an encryption key, and the encryption key is
what is actually used for encryption. This enables retrieval of that
key.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--check-linearization</span></code></dt><dd><p>Checks file integrity and linearization status.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-linearization</span></code></dt><dd><p>Checks and displays all data in the linearization hint tables.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-xref</span></code></dt><dd><p>Shows the contents of the cross-reference table in a human-readable
form. This is especially useful for files with cross-reference
streams which are stored in a binary format.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-object=trailer|obj[,gen]</span></code></dt><dd><p>Show the contents of the given object. This is especially useful for
inspecting objects that are inside of object streams (also known as
“compressed objects”).</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--raw-stream-data</span></code></dt><dd><p>When used along with the <code class="samp docutils literal notranslate"><span class="pre">--show-object</span></code>
option, if the object is a stream, shows the raw stream data instead
of object’s contents.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--filtered-stream-data</span></code></dt><dd><p>When used along with the <code class="samp docutils literal notranslate"><span class="pre">--show-object</span></code>
option, if the object is a stream, shows the filtered stream data
instead of object’s contents. If the stream is filtered using filters
that qpdf does not support, an error will be issued.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-npages</span></code></dt><dd><p>Prints the number of pages in the input file on a line by itself.
Since the number of pages appears by itself on a line, this option
can be useful for scripting if you need to know the number of pages
in a file.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--show-pages</span></code></dt><dd><p>Shows the object and generation number for each page dictionary
object and for each content stream associated with the page. Having
this information makes it more convenient to inspect objects from a
particular page.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--with-images</span></code></dt><dd><p>When used along with <code class="samp docutils literal notranslate"><span class="pre">--show-pages</span></code>, also shows
the object and generation numbers for the image objects on each page.
(At present, information about images in shared resource dictionaries
are not output by this command. This is discussed in a comment in the
source code.)</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--json</span></code></dt><dd><p>Generate a JSON representation of the file. This is described in
depth in <a class="reference internal" href="index.html#json"><span class="std std-ref">QPDF JSON</span></a></p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--json-help</span></code></dt><dd><p>Describe the format of the JSON output.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--json-key=key</span></code></dt><dd><p>This option is repeatable. If specified, only top-level keys
specified will be included in the JSON output. If not specified, all
keys will be shown.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--json-object=trailer|obj[,gen]</span></code></dt><dd><p>This option is repeatable. If specified, only specified objects will
be shown in the “<code class="docutils literal notranslate"><span class="pre">objects</span></code>” key of the JSON output. If absent, all
objects will be shown.</p>
</dd>
<dt><code class="samp docutils literal notranslate"><span class="pre">--check</span></code></dt><dd><p>Checks file structure and well as encryption, linearization, and
encoding of stream data. A file for which
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> reports no errors may still have
errors in stream data content but should otherwise be structurally
sound. If <code class="samp docutils literal notranslate"><span class="pre">--check</span></code> any errors, qpdf will exit
with a status of 2. There are some recoverable conditions that
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> detects. These are issued as warnings
instead of errors. If qpdf finds no errors but finds warnings, it
will exit with a status of 3 (as of version 2.0.4). When
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> is combined with other options,
checks are always performed before any other options are processed.
For erroneous files, <code class="samp docutils literal notranslate"><span class="pre">--check</span></code> will cause qpdf
to attempt to recover, after which other options are effectively
operating on the recovered file. Combining
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> with other options in this way can be
useful for manually recovering severely damaged files. Note that
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> produces no output to standard output
when everything is valid, so if you are using this to
programmatically validate files in bulk, it is safe to run without
output redirected to <code class="file docutils literal notranslate"><span class="pre">/dev/null</span></code> and just
check for a 0 exit code.</p>
</dd>
</dl>
<p>The <code class="samp docutils literal notranslate"><span class="pre">--raw-stream-data</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--filtered-stream-data</span></code> options are ignored
unless <code class="samp docutils literal notranslate"><span class="pre">--show-object</span></code> is given. Either of these
options will cause the stream data to be written to standard output. In
order to avoid commingling of stream data with other output, it is
recommend that these objects not be combined with other test/inspection
options.</p>
<p>If <code class="samp docutils literal notranslate"><span class="pre">--filtered-stream-data</span></code> is given and
<code class="samp docutils literal notranslate"><span class="pre">--normalize-content=y</span></code> is also given, qpdf will
attempt to normalize the stream data as if it is a page content stream.
This attempt will be made even if it is not a page content stream, in
which case it will produce unusable results.</p>
</section>
<section id="unicode-passwords">
<span id="id5"></span><h3>Unicode Passwords<a class="headerlink" href="#unicode-passwords" title="Permalink to this headline"></a></h3>
<p>At the library API level, all methods that perform encryption and
decryption interpret passwords as strings of bytes. It is up to the
caller to ensure that they are appropriately encoded. Starting with qpdf
version 8.4.0, qpdf will attempt to make this easier for you when
interact with qpdf via its command line interface. The PDF specification
requires passwords used to encrypt files with 40-bit or 128-bit
encryption to be encoded with PDF Doc encoding. This encoding is a
single-byte encoding that supports ISO-Latin-1 and a handful of other
commonly used characters. It has a large overlap with Windows ANSI but
is not exactly the same. There is generally not a way to provide PDF Doc
encoded strings on the command line. As such, qpdf versions prior to
8.4.0 would often create PDF files that couldn’t be opened with other
software when given a password with non-ASCII characters to encrypt a
file with 40-bit or 128-bit encryption. Starting with qpdf 8.4.0, qpdf
recognizes the encoding of the parameter and transcodes it as needed.
The rest of this section provides the details about exactly how qpdf
behaves. Most users will not need to know this information, but it might
be useful if you have been working around qpdf’s old behavior or if you
are using qpdf to generate encrypted files for testing other PDF
software.</p>
<p>A note about Windows: when qpdf builds, it attempts to determine what it
has to do to use <code class="docutils literal notranslate"><span class="pre">wmain</span></code> instead of <code class="docutils literal notranslate"><span class="pre">main</span></code> on Windows. The <code class="docutils literal notranslate"><span class="pre">wmain</span></code>
function is an alternative entry point that receives all arguments as
UTF-16-encoded strings. When qpdf starts up this way, it converts all
the strings to UTF-8 encoding and then invokes the regular main. This
means that, as far as qpdf is concerned, it receives its command-line
arguments with UTF-8 encoding, just as it would in any modern Linux or
UNIX environment.</p>
<p>If a file is being encrypted with 40-bit or 128-bit encryption and the
supplied password is not a valid UTF-8 string, qpdf will fall back to
the behavior of interpreting the password as a string of bytes. If you
have old scripts that encrypt files by passing the output of
<strong class="command">iconv</strong> to qpdf, you no longer need to do that,
but if you do, qpdf should still work. The only exception would be for
the extremely unlikely case of a password that is encoded with a
single-byte encoding but also happens to be valid UTF-8. Such a password
would contain strings of even numbers of characters that alternate
between accented letters and symbols. In the extremely unlikely event
that you are intentionally using such passwords and qpdf is thwarting
you by interpreting them as UTF-8, you can use
<code class="samp docutils literal notranslate"><span class="pre">--password-mode=bytes</span></code> to suppress qpdf’s
automatic behavior.</p>
<p>The <code class="samp docutils literal notranslate"><span class="pre">--password-mode</span></code> option, as described earlier
in this chapter, can be used to change qpdf’s interpretation of supplied
passwords. There are very few reasons to use this option. One would be
the unlikely case described in the previous paragraph in which the
supplied password happens to be valid UTF-8 but isn’t supposed to be
UTF-8. Your best bet would be just to provide the password as a valid
UTF-8 string, but you could also use
<code class="samp docutils literal notranslate"><span class="pre">--password-mode=bytes</span></code>. Another reason to use
<code class="samp docutils literal notranslate"><span class="pre">--password-mode=bytes</span></code> would be to intentionally
generate PDF files encrypted with passwords that are not properly
encoded. The qpdf test suite does this to generate invalid files for the
purpose of testing its password recovery capability. If you were trying
to create intentionally incorrect files for a similar purposes, the
<code class="samp docutils literal notranslate"><span class="pre">bytes</span></code> password mode can enable you to do this.</p>
<p>When qpdf attempts to decrypt a file with a password that contains
non-ASCII characters, it will generate a list of alternative passwords
by attempting to interpret the password as each of a handful of
different coding systems and then transcode them to the required format.
This helps to compensate for the supplied password being given in the
wrong coding system, such as would happen if you used the
<strong class="command">iconv</strong> workaround that was previously needed.
It also generates passwords by doing the reverse operation: translating
from correct in incorrect encoding of the password. This would enable
qpdf to decrypt files using passwords that were improperly encoded by
whatever software encrypted the files, including older versions of qpdf
invoked without properly encoded passwords. The combination of these two
recovery methods should make qpdf transparently open most encrypted
files with the password supplied correctly but in the wrong coding
system. There are no real downsides to this behavior, but if you don’t
want qpdf to do this, you can use the
<code class="samp docutils literal notranslate"><span class="pre">--suppress-password-recovery</span></code> option. One reason
to do that is to ensure that you know the exact password that was used
to encrypt the file.</p>
<p>With these changes, qpdf now generates compliant passwords in most
cases. There are still some exceptions. In particular, the PDF
specification directs compliant writers to normalize Unicode passwords
and to perform certain transformations on passwords with bidirectional
text. Implementing this functionality requires using a real Unicode
library like ICU. If a client application that uses qpdf wants to do
this, the qpdf library will accept the resulting passwords, but qpdf
will not perform these transformations itself. It is possible that this
will be addressed in a future version of qpdf. The <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>
methods that enable encryption on the output file accept passwords as
strings of bytes.</p>
<p>Please note that the <code class="samp docutils literal notranslate"><span class="pre">--password-is-hex-key</span></code>
option is unrelated to all this. This flag bypasses the normal process
of going from password to encryption string entirely, allowing the raw
encryption key to be specified directly. This is useful for forensic
purposes or for brute-force recovery of files with unknown passwords.</p>
</section>
</section>
<span id="document-qdf"></span><section id="qdf-mode">
<span id="qdf"></span><h2>QDF Mode<a class="headerlink" href="#qdf-mode" title="Permalink to this headline"></a></h2>
<p>In QDF mode, qpdf creates PDF files in what we call <em>QDF
form</em>. A PDF file in QDF form, sometimes called a QDF
file, is a completely valid PDF file that has <code class="docutils literal notranslate"><span class="pre">%QDF-1.0</span></code> as its third
line (after the pdf header and binary characters) and has certain other
characteristics. The purpose of QDF form is to make it possible to edit
PDF files, with some restrictions, in an ordinary text editor. This can
be very useful for experimenting with different PDF constructs or for
making one-off edits to PDF files (though there are other reasons why
this may not always work). Note that QDF mode does not support
linearized files. If you enable linearization, QDF mode is automatically
disabled.</p>
<p>It is ordinarily very difficult to edit PDF files in a text editor for
two reasons: most meaningful data in PDF files is compressed, and PDF
files are full of offset and length information that makes it hard to
add or remove data. A QDF file is organized in a manner such that, if
edits are kept within certain constraints, the
<strong class="command">fix-qdf</strong> program, distributed with qpdf, is
able to restore edited files to a correct state. The
<strong class="command">fix-qdf</strong> program takes no command-line
arguments. It reads a possibly edited QDF file from standard input and
writes a repaired file to standard output.</p>
<p>The following attributes characterize a QDF file:</p>
<ul class="simple">
<li><p>All objects appear in numerical order in the PDF file, including when
objects appear in object streams.</p></li>
<li><p>Objects are printed in an easy-to-read format, and all line endings
are normalized to UNIX line endings.</p></li>
<li><p>Unless specifically overridden, streams appear uncompressed (when
qpdf supports the filters and they are compressed with a non-lossy
compression scheme), and most content streams are normalized (line
endings are converted to just a UNIX-style linefeeds).</p></li>
<li><p>All streams lengths are represented as indirect objects, and the
stream length object is always the next object after the stream. If
the stream data does not end with a newline, an extra newline is
inserted, and a special comment appears after the stream indicating
that this has been done.</p></li>
<li><p>If the PDF file contains object streams, if object stream <em>n</em>
contains <em>k</em> objects, those objects are numbered from <em>n+1</em> through
<em>n+k</em>, and the object number/offset pairs appear on a separate line
for each object. Additionally, each object in the object stream is
preceded by a comment indicating its object number and index. This
makes it very easy to find objects in object streams.</p></li>
<li><p>All beginnings of objects, <code class="docutils literal notranslate"><span class="pre">stream</span></code> tokens, <code class="docutils literal notranslate"><span class="pre">endstream</span></code> tokens,
and <code class="docutils literal notranslate"><span class="pre">endobj</span></code> tokens appear on lines by themselves. A blank line
follows every <code class="docutils literal notranslate"><span class="pre">endobj</span></code> token.</p></li>
<li><p>If there is a cross-reference stream, it is unfiltered.</p></li>
<li><p>Page dictionaries and page content streams are marked with special
comments that make them easy to find.</p></li>
<li><p>Comments precede each object indicating the object number of the
corresponding object in the original file.</p></li>
</ul>
<p>When editing a QDF file, any edits can be made as long as the above
constraints are maintained. This means that you can freely edit a page’s
content without worrying about messing up the QDF file. It is also
possible to add new objects so long as those objects are added after the
last object in the file or subsequent objects are renumbered. If a QDF
file has object streams in it, you can always add the new objects before
the xref stream and then change the number of the xref stream, since
nothing generally ever references it by number.</p>
<p>It is not generally practical to remove objects from QDF files without
messing up object numbering, but if you remove all references to an
object, you can run qpdf on the file (after running
<strong class="command">fix-qdf</strong>), and qpdf will omit the now-orphaned
object.</p>
<p>When <strong class="command">fix-qdf</strong> is run, it goes through the file
and recomputes the following parts of the file:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">/N</span></code>, <code class="docutils literal notranslate"><span class="pre">/W</span></code>, and <code class="docutils literal notranslate"><span class="pre">/First</span></code> keys of all object stream
dictionaries</p></li>
<li><p>the pairs of numbers representing object numbers and offsets of
objects in object streams</p></li>
<li><p>all stream lengths</p></li>
<li><p>the cross-reference table or cross-reference stream</p></li>
<li><p>the offset to the cross-reference table or cross-reference stream
following the <code class="docutils literal notranslate"><span class="pre">startxref</span></code> token</p></li>
</ul>
</section>
<span id="document-library"></span><section id="using-the-qpdf-library">
<span id="using-library"></span><h2>Using the QPDF Library<a class="headerlink" href="#using-the-qpdf-library" title="Permalink to this headline"></a></h2>
<section id="using-qpdf-from-c">
<span id="using-from-cxx"></span><h3>Using QPDF from C++<a class="headerlink" href="#using-qpdf-from-c" title="Permalink to this headline"></a></h3>
<p>The source tree for the qpdf package has an
<code class="file docutils literal notranslate"><span class="pre">examples</span></code> directory that contains a few
example programs. The <code class="file docutils literal notranslate"><span class="pre">qpdf/qpdf.cc</span></code> source
file also serves as a useful example since it exercises almost all of
the qpdf library’s public interface. The best source of documentation on
the library itself is reading comments in
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDF.hh</span></code>,
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDFWriter.hh</span></code>, and
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDFObjectHandle.hh</span></code>.</p>
<p>All header files are installed in the
<code class="file docutils literal notranslate"><span class="pre">include/qpdf</span></code> directory. It is recommend that
you use <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;qpdf/QPDF.hh&gt;</span></code> rather than adding
<code class="file docutils literal notranslate"><span class="pre">include/qpdf</span></code> to your include path.</p>
<p>When linking against the qpdf static library, you may also need to
specify <code class="docutils literal notranslate"><span class="pre">-lz</span> <span class="pre">-ljpeg</span></code> on your link command. If your system understands
how to read libtool <code class="file docutils literal notranslate"><span class="pre">.la</span></code> files, this may not
be necessary.</p>
<p>The qpdf library is safe to use in a multithreaded program, but no
individual <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object instance (including <code class="docutils literal notranslate"><span class="pre">QPDF</span></code>,
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>, or <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>) can be used in more than one
thread at a time. Multiple threads may simultaneously work with
different instances of these and all other QPDF objects.</p>
</section>
<section id="using-qpdf-from-other-languages">
<span id="using-other-languages"></span><h3>Using QPDF from other languages<a class="headerlink" href="#using-qpdf-from-other-languages" title="Permalink to this headline"></a></h3>
<p>The qpdf library is implemented in C++, which makes it hard to use
directly in other languages. There are a few things that can help.</p>
<dl class="simple">
<dt>“C”</dt><dd><p>The qpdf library includes a “C” language interface that provides a
subset of the overall capabilities. The header file
<code class="file docutils literal notranslate"><span class="pre">qpdf/qpdf-c.h</span></code> includes information about
its use. As long as you use a C++ linker, you can link C programs
with qpdf and use the C API. For languages that can directly load
methods from a shared library, the C API can also be useful. People
have reported success using the C API from other languages on Windows
by directly calling functions in the DLL.</p>
</dd>
<dt>Python</dt><dd><p>A Python module called
<a class="reference external" href="https://pypi.org/project/pikepdf/">pikepdf</a> provides a clean and
highly functional set of Python bindings to the qpdf library. Using
pikepdf, you can work with PDF files in a natural way and combine
qpdf’s capabilities with other functionality provided by Python’s
rich standard library and available modules.</p>
</dd>
<dt>Other Languages</dt><dd><p>Starting with version 8.3.0, the <strong class="command">qpdf</strong>
command-line tool can produce a JSON representation of the PDF file’s
non-content data. This can facilitate interacting programmatically
with PDF files through qpdf’s command line interface. For more
information, please see <a class="reference internal" href="index.html#json"><span class="std std-ref">QPDF JSON</span></a>.</p>
</dd>
</dl>
</section>
<section id="a-note-about-unicode-file-names">
<span id="unicode-files"></span><h3>A Note About Unicode File Names<a class="headerlink" href="#a-note-about-unicode-file-names" title="Permalink to this headline"></a></h3>
<p>When strings are passed to qpdf library routines either as <code class="docutils literal notranslate"><span class="pre">char*</span></code> or
as <code class="docutils literal notranslate"><span class="pre">std::string</span></code>, they are treated as byte arrays except where
otherwise noted. When Unicode is desired, qpdf wants UTF-8 unless
otherwise noted in comments in header files. In modern UNIX/Linux
environments, this generally does the right thing. In Windows, it’s a
bit more complicated. Starting in qpdf 8.4.0, passwords that contain
Unicode characters are handled much better, and starting in qpdf 8.4.1,
the library attempts to properly handle Unicode characters in filenames.
In particular, in Windows, if a UTF-8 encoded string is used as a
filename in either <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> or <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>, it is internally
converted to <code class="docutils literal notranslate"><span class="pre">wchar_t*</span></code>, and Unicode-aware Windows APIs are used. As
such, qpdf will generally operate properly on files with non-ASCII
characters in their names as long as the filenames are UTF-8 encoded for
passing into the qpdf library API, but there are still some rough edges,
such as the encoding of the filenames in error messages our CLI output
messages. Patches or bug reports are welcome for any continuing issues
with Unicode file names in Windows.</p>
</section>
</section>
<span id="document-weak-crypto"></span><section id="weak-cryptography">
<span id="weak-crypto"></span><h2>Weak Cryptography<a class="headerlink" href="#weak-cryptography" title="Permalink to this headline"></a></h2>
<p>Start with version 10.4, qpdf is taking steps to reduce the likelihood
of a user <em>accidentally</em> creating PDF files with insecure cryptography
but will continue to allow creation of such files indefinitely with
explicit acknowledgment.</p>
<p>The PDF file format makes use of RC4, which is known to be a weak
cryptography algorithm, and MD5, which is a weak hashing algorithm. In
version 10.4, qpdf generates warnings for some (but not all) cases of
writing files with weak cryptography when invoked from the command-line.
These warnings can be suppressed using the
<code class="samp docutils literal notranslate"><span class="pre">--allow-weak-crypto</span></code> option.</p>
<p>It is planned for qpdf version 11 to be stricter, making it an error to
write files with insecure cryptography from the command-line tool in
most cases without specifying the
<code class="samp docutils literal notranslate"><span class="pre">--allow-weak-crypto</span></code> flag and also to require
explicit steps when using the C++ library to enable use of insecure
cryptography.</p>
<p>Note that qpdf must always retain support for weak cryptographic
algorithms since this is required for reading older PDF files that use
it. Additionally, qpdf will always retain the ability to create files
using weak cryptographic algorithms since, as a development tool, qpdf
explicitly supports creating older or deprecated types of PDF files
since these are sometimes needed to test or work with older versions of
software. Even if other cryptography libraries drop support for RC4 or
MD5, qpdf can always fall back to its internal implementations of those
algorithms, so they are not going to disappear from qpdf.</p>
</section>
<span id="document-json"></span><section id="qpdf-json">
<span id="json"></span><h2>QPDF JSON<a class="headerlink" href="#qpdf-json" title="Permalink to this headline"></a></h2>
<section id="overview">
<span id="json-overview"></span><h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h3>
<p>Beginning with qpdf version 8.3.0, the <strong class="command">qpdf</strong>
command-line program can produce a JSON representation of the
non-content data in a PDF file. It includes a dump in JSON format of all
objects in the PDF file excluding the content of streams. This JSON
representation makes it very easy to look in detail at the structure of
a given PDF file, and it also provides a great way to work with PDF
files programmatically from the command-line in languages that can’t
call or link with the qpdf library directly. Note that stream data can
be extracted from PDF files using other qpdf command-line options.</p>
</section>
<section id="json-guarantees">
<span id="id1"></span><h3>JSON Guarantees<a class="headerlink" href="#json-guarantees" title="Permalink to this headline"></a></h3>
<p>The qpdf JSON representation includes a JSON serialization of the raw
objects in the PDF file as well as some computed information in a more
easily extracted format. QPDF provides some guarantees about its JSON
format. These guarantees are designed to simplify the experience of a
developer working with the JSON format.</p>
<dl>
<dt>Compatibility</dt><dd><p>The top-level JSON object output is a dictionary. The JSON output
contains various nested dictionaries and arrays. With the exception
of dictionaries that are populated by the fields of objects from the
file, all instances of a dictionary are guaranteed to have exactly
the same keys. Future versions of qpdf are free to add additional
keys but not to remove keys or change the type of object that a key
points to. The qpdf program validates this guarantee, and in the
unlikely event that a bug in qpdf should cause it to generate data
that doesn’t conform to this rule, it will ask you to file a bug
report.</p>
<p>The top-level JSON structure contains a “<code class="docutils literal notranslate"><span class="pre">version</span></code>” key whose value
is simple integer. The value of the <code class="docutils literal notranslate"><span class="pre">version</span></code> key will be
incremented if a non-compatible change is made. A non-compatible
change would be any change that involves removal of a key, a change
to the format of data pointed to by a key, or a semantic change that
requires a different interpretation of a previously existing key. A
strong effort will be made to avoid breaking compatibility.</p>
</dd>
<dt>Documentation</dt><dd><p>The <strong class="command">qpdf</strong> command can be invoked with the
<code class="samp docutils literal notranslate"><span class="pre">--json-help</span></code> option. This will output a JSON
structure that has the same structure as the JSON output that qpdf
generates, except that each field in the help output is a description
of the corresponding field in the JSON output. The specific
guarantees are as follows:</p>
<ul class="simple">
<li><p>A dictionary in the help output means that the corresponding
location in the actual JSON output is also a dictionary with
exactly the same keys; that is, no keys present in help are absent
in the real output, and no keys will be present in the real output
that are not in help. As a special case, if the dictionary has a
single key whose name starts with <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> and ends with <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, it
means that the JSON output is a dictionary that can have any keys,
each of which conforms to the value of the special key. This is
used for cases in which the keys of the dictionary are things like
object IDs.</p></li>
<li><p>A string in the help output is a description of the item that
appears in the corresponding location of the actual output. The
corresponding output can have any format.</p></li>
<li><p>An array in the help output always contains a single element. It
indicates that the corresponding location in the actual output is
also an array, and that each element of the array has whatever
format is implied by the single element of the help output’s
array.</p></li>
</ul>
<p>For example, the help output indicates includes a “<code class="docutils literal notranslate"><span class="pre">pagelabels</span></code>”
key whose value is an array of one element. That element is a
dictionary with keys “<code class="docutils literal notranslate"><span class="pre">index</span></code>” and “<code class="docutils literal notranslate"><span class="pre">label</span></code>”. In addition to
describing the meaning of those keys, this tells you that the actual
JSON output will contain a <code class="docutils literal notranslate"><span class="pre">pagelabels</span></code> array, each of whose
elements is a dictionary that contains an <code class="docutils literal notranslate"><span class="pre">index</span></code> key, a <code class="docutils literal notranslate"><span class="pre">label</span></code>
key, and no other keys.</p>
</dd>
<dt>Directness and Simplicity</dt><dd><p>The JSON output contains the value of every object in the file, but
it also contains some processed data. This is analogous to how qpdf’s
library interface works. The processed data is similar to the helper
functions in that it allows you to look at certain aspects of the PDF
file without having to understand all the nuances of the PDF
specification, while the raw objects allow you to mine the PDF for
anything that the higher-level interfaces are lacking.</p>
</dd>
</dl>
</section>
<section id="limitations-of-json-representation">
<span id="json-limitations"></span><h3>Limitations of JSON Representation<a class="headerlink" href="#limitations-of-json-representation" title="Permalink to this headline"></a></h3>
<p>There are a few limitations to be aware of with the JSON structure:</p>
<ul class="simple">
<li><p>Strings, names, and indirect object references in the original PDF
file are all converted to strings in the JSON representation. In the
case of a “normal” PDF file, you can tell the difference because a
name starts with a slash (<code class="docutils literal notranslate"><span class="pre">/</span></code>), and an indirect object reference
looks like <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">n</span> <span class="pre">R</span></code>, but if there were to be a string that looked
like a name or indirect object reference, there would be no way to
tell this from the JSON output. Note that there are certain cases
where you know for sure what something is, such as knowing that
dictionary keys in objects are always names and that certain things
in the higher-level computed data are known to contain indirect
object references.</p></li>
<li><p>The JSON format doesn’t support binary data very well. Mostly the
details are not important, but they are presented here for
information. When qpdf outputs a string in the JSON representation,
it converts the string to UTF-8, assuming usual PDF string semantics.
Specifically, if the original string is UTF-16, it is converted to
UTF-8. Otherwise, it is assumed to have PDF doc encoding, and is
converted to UTF-8 with that assumption. This causes strange things
to happen to binary strings. For example, if you had the binary
string <code class="docutils literal notranslate"><span class="pre">&lt;038051&gt;</span></code>, this would be output to the JSON as <code class="docutils literal notranslate"><span class="pre">\u0003•Q</span></code>
because <code class="docutils literal notranslate"><span class="pre">03</span></code> is not a printable character and <code class="docutils literal notranslate"><span class="pre">80</span></code> is the bullet
character in PDF doc encoding and is mapped to the Unicode value
<code class="docutils literal notranslate"><span class="pre">2022</span></code>. Since <code class="docutils literal notranslate"><span class="pre">51</span></code> is <code class="docutils literal notranslate"><span class="pre">Q</span></code>, it is output as is. If you wanted to
convert back from here to a binary string, would have to recognize
Unicode values whose code points are higher than <code class="docutils literal notranslate"><span class="pre">0xFF</span></code> and map
those back to their corresponding PDF doc encoding characters. There
is no way to tell the difference between a Unicode string that was
originally encoded as UTF-16 or one that was converted from PDF doc
encoding. In other words, it’s best if you don’t try to use the JSON
format to extract binary strings from the PDF file, but if you really
had to, it could be done. Note that qpdf’s
<code class="samp docutils literal notranslate"><span class="pre">--show-object</span></code> option does not have this
limitation and will reveal the string as encoded in the original
file.</p></li>
</ul>
</section>
<section id="json-special-considerations">
<span id="json-considerations"></span><h3>JSON: Special Considerations<a class="headerlink" href="#json-special-considerations" title="Permalink to this headline"></a></h3>
<p>For the most part, the built-in JSON help tells you everything you need
to know about the JSON format, but there are a few non-obvious things to
be aware of:</p>
<ul class="simple">
<li><p>While qpdf guarantees that keys present in the help will be present
in the output, those fields may be null or empty if the information
is not known or absent in the file. Also, if you specify
<code class="samp docutils literal notranslate"><span class="pre">--json-keys</span></code>, the keys that are not listed
will be excluded entirely except for those that
<code class="samp docutils literal notranslate"><span class="pre">--json-help</span></code> says are always present.</p></li>
<li><p>In a few places, there are keys with names containing
<code class="docutils literal notranslate"><span class="pre">pageposfrom1</span></code>. The values of these keys are null or an integer. If
an integer, they point to a page index within the file numbering from
1. Note that JSON indexes from 0, and you would also use 0-based
indexing using the API. However, 1-based indexing is easier in this
case because the command-line syntax for specifying page ranges is
1-based. If you were going to write a program that looked through the
JSON for information about specific pages and then use the
command-line to extract those pages, 1-based indexing is easier.
Besides, it’s more convenient to subtract 1 from a program in a real
programming language than it is to add 1 from shell code.</p></li>
<li><p>The image information included in the <code class="docutils literal notranslate"><span class="pre">page</span></code> section of the JSON
output includes the key “<code class="docutils literal notranslate"><span class="pre">filterable</span></code>”. Note that the value of this
field may depend on the <code class="samp docutils literal notranslate"><span class="pre">--decode-level</span></code> that
you invoke qpdf with. The JSON output includes a top-level key
“<code class="docutils literal notranslate"><span class="pre">parameters</span></code>” that indicates the decode level used for computing
whether a stream was filterable. For example, jpeg images will be
shown as not filterable by default, but they will be shown as
filterable if you run <strong class="command">qpdf --json
--decode-level=all</strong>.</p></li>
</ul>
</section>
</section>
<span id="document-design"></span><section id="design-and-library-notes">
<span id="design"></span><h2>Design and Library Notes<a class="headerlink" href="#design-and-library-notes" title="Permalink to this headline"></a></h2>
<section id="introduction">
<span id="design-intro"></span><h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h3>
<p>This section was written prior to the implementation of the qpdf package
and was subsequently modified to reflect the implementation. In some
cases, for purposes of explanation, it may differ slightly from the
actual implementation. As always, the source code and test suite are
authoritative. Even if there are some errors, this document should serve
as a road map to understanding how this code works.</p>
<p>In general, one should adhere strictly to a specification when writing
but be liberal in reading. This way, the product of our software will be
accepted by the widest range of other programs, and we will accept the
widest range of input files. This library attempts to conform to that
philosophy whenever possible but also aims to provide strict checking
for people who want to validate PDF files. If you don’t want to see
warnings and are trying to write something that is tolerant, you can
call <code class="docutils literal notranslate"><span class="pre">setSuppressWarnings(true)</span></code>. If you want to fail on the first
error, you can call <code class="docutils literal notranslate"><span class="pre">setAttemptRecovery(false)</span></code>. The default behavior
is to generating warnings for recoverable problems. Note that recovery
will not always produce the desired results even if it is able to get
through the file. Unlike most other PDF files that produce generic
warnings such as “This file is damaged,”, qpdf generally issues a
detailed error message that would be most useful to a PDF developer.
This is by design as there seems to be a shortage of PDF validation
tools out there. This was, in fact, one of the major motivations behind
the initial creation of qpdf.</p>
</section>
<section id="design-goals">
<span id="id1"></span><h3>Design Goals<a class="headerlink" href="#design-goals" title="Permalink to this headline"></a></h3>
<p>The QPDF package includes support for reading and rewriting PDF files.
It aims to hide from the user details involving object locations,
modified (appended) PDF files, the directness/indirectness of objects,
and stream filters including encryption. It does not aim to hide
knowledge of the object hierarchy or content stream contents. Put
another way, a user of the qpdf library is expected to have knowledge
about how PDF files work, but is not expected to have to keep track of
bookkeeping details such as file positions.</p>
<p>A user of the library never has to care whether an object is direct or
indirect, though it is possible to determine whether an object is direct
or not if this information is needed. All access to objects deals with
this transparently. All memory management details are also handled by
the library.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PointerHolder</span></code> object is used internally by the library to deal
with memory management. This is basically a smart pointer object very
similar in spirit to C++-11’s <code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code> object, but predating
it by several years. This library also makes use of a technique for
giving fine-grained access to methods in one class to other classes by
using public subclasses with friends and only private members that in
turn call private methods of the containing class. See
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::Factory</span></code> as an example.</p>
<p>The top-level qpdf class is <code class="docutils literal notranslate"><span class="pre">QPDF</span></code>. A <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object represents a PDF
file. The library provides methods for both accessing and mutating PDF
files.</p>
<p>The primary class for interacting with PDF objects is
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. Instances of this class can be passed around by
value, copied, stored in containers, etc. with very low overhead.
Instances of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> created by reading from a file will
always contain a reference back to the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object from which they
were created. A <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> may be direct or indirect. If
indirect, the <code class="docutils literal notranslate"><span class="pre">QPDFObject</span></code> the <code class="docutils literal notranslate"><span class="pre">PointerHolder</span></code> initially points to
is a null pointer. In this case, the first attempt to access the
underlying <code class="docutils literal notranslate"><span class="pre">QPDFObject</span></code> will result in the <code class="docutils literal notranslate"><span class="pre">QPDFObject</span></code> being
resolved via a call to the referenced <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> instance. This makes it
essentially impossible to make coding errors in which certain things
will work for some PDF files and not for others based on which objects
are direct and which objects are indirect.</p>
<p>Instances of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> can be directly created and modified
using static factory methods in the <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> class. There
are factory methods for each type of object as well as a convenience
method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::parse</span></code> that creates an object from a string
representation of the object. Existing instances of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>
can also be modified in several ways. See comments in
<code class="file docutils literal notranslate"><span class="pre">QPDFObjectHandle.hh</span></code> for details.</p>
<p>An instance of <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> is constructed by using the class’s default
constructor. If desired, the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object may be configured with
various methods that change its default behavior. Then the
<code class="docutils literal notranslate"><span class="pre">QPDF::processFile()</span></code> method is passed the name of a PDF file, which
permanently associates the file with that QPDF object. A password may
also be given for access to password-protected files. QPDF does not
enforce encryption parameters and will treat user and owner passwords
equivalently. Either password may be used to access an encrypted file.
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> will allow recovery of a user password given an owner password.
The input PDF file must be seekable. (Output files written by
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> need not be seekable, even when creating linearized
files.) During construction, <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> validates the PDF file’s header,
and then reads the cross reference tables and trailer dictionaries. The
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class keeps only the first trailer dictionary though it does
read all of them so it can check the <code class="docutils literal notranslate"><span class="pre">/Prev</span></code> key. <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class users
may request the root object and the trailer dictionary specifically. The
cross reference table is kept private. Objects may then be requested by
number of by walking the object tree.</p>
<p>When a PDF file has a cross-reference stream instead of a
cross-reference table and trailer, requesting the document’s trailer
dictionary returns the stream dictionary from the cross-reference stream
instead.</p>
<p>There are some convenience routines for very common operations such as
walking the page tree and returning a vector of all page objects. For
full details, please see the header files
<code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code> and
<code class="file docutils literal notranslate"><span class="pre">QPDFObjectHandle.hh</span></code>. There are also some
additional helper classes that provide higher level API functions for
certain document constructions. These are discussed in <a class="reference internal" href="#helper-classes"><span class="std std-ref">Helper Classes</span></a>.</p>
</section>
<section id="helper-classes">
<span id="id2"></span><h3>Helper Classes<a class="headerlink" href="#helper-classes" title="Permalink to this headline"></a></h3>
<p>QPDF version 8.1 introduced the concept of helper classes. Helper
classes are intended to contain higher level APIs that allow developers
to work with certain document constructs at an abstraction level above
that of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> while staying true to qpdf’s philosophy of
not hiding document structure from the developer. As with qpdf in
general, the goal is take away some of the more tedious bookkeeping
aspects of working with PDF files, not to remove the need for the
developer to understand how the PDF construction in question works. The
driving factor behind the creation of helper classes was to allow the
evolution of higher level interfaces in qpdf without polluting the
interfaces of the main top-level classes <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>.</p>
<p>There are two kinds of helper classes: <em>document</em> helpers and <em>object</em>
helpers. Document helpers are constructed with a reference to a <code class="docutils literal notranslate"><span class="pre">QPDF</span></code>
object and provide methods for working with structures that are at the
document level. Object helpers are constructed with an instance of a
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> and provide methods for working with specific types
of objects.</p>
<p>Examples of document helpers include <code class="docutils literal notranslate"><span class="pre">QPDFPageDocumentHelper</span></code>, which
contains methods for operating on the document’s page trees, such as
enumerating all pages of a document and adding and removing pages; and
<code class="docutils literal notranslate"><span class="pre">QPDFAcroFormDocumentHelper</span></code>, which contains document-level methods
related to interactive forms, such as enumerating form fields and
creating mappings between form fields and annotations.</p>
<p>Examples of object helpers include <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code> for
performing operations on pages such as page rotation and some operations
on content streams, <code class="docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper</span></code> for performing
operations related to interactive form fields, and
<code class="docutils literal notranslate"><span class="pre">QPDFAnnotationObjectHelper</span></code> for working with annotations.</p>
<p>It is always possible to retrieve the underlying <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> reference from
a document helper and the underlying <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> reference from
an object helper. Helpers are designed to be helpers, not wrappers. The
intention is that, in general, it is safe to freely intermix operations
that use helpers with operations that use the underlying objects.
Document and object helpers do not attempt to provide a complete
interface for working with the things they are helping with, nor do they
attempt to encapsulate underlying structures. They just provide a few
methods to help with error-prone, repetitive, or complex tasks. In some
cases, a helper object may cache some information that is expensive to
gather. In such cases, the helper classes are implemented so that their
own methods keep the cache consistent, and the header file will provide
a method to invalidate the cache and a description of what kinds of
operations would make the cache invalid. If in doubt, you can always
discard a helper class and create a new one with the same underlying
objects, which will ensure that you have discarded any stale
information.</p>
<p>By Convention, document helpers are called
<code class="docutils literal notranslate"><span class="pre">QPDFSomethingDocumentHelper</span></code> and are derived from
<code class="docutils literal notranslate"><span class="pre">QPDFDocumentHelper</span></code>, and object helpers are called
<code class="docutils literal notranslate"><span class="pre">QPDFSomethingObjectHelper</span></code> and are derived from <code class="docutils literal notranslate"><span class="pre">QPDFObjectHelper</span></code>.
For details on specific helpers, please see their header files. You can
find them by looking at
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDF*DocumentHelper.hh</span></code> and
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDF*ObjectHelper.hh</span></code>.</p>
<p>In order to avoid creation of circular dependencies, the following
general guidelines are followed with helper classes:</p>
<ul class="simple">
<li><p>Core class interfaces do not know about helper classes. For example,
no methods of <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> or <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> will include helper
classes in their interfaces.</p></li>
<li><p>Interfaces of object helpers will usually not use document helpers in
their interfaces. This is because it is much more useful for document
helpers to have methods that return object helpers. Most operations
in PDF files start at the document level and go from there to the
object level rather than the other way around. It can sometimes be
useful to map back from object-level structures to document-level
structures. If there is a desire to do this, it will generally be
provided by a method in the document helper class.</p></li>
<li><p>Most of the time, object helpers don’t know about other object
helpers. However, in some cases, one type of object may be a
container for another type of object, in which case it may make sense
for the outer object to know about the inner object. For example,
there are methods in the <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code> that know
<code class="docutils literal notranslate"><span class="pre">QPDFAnnotationObjectHelper</span></code> because references to annotations are
contained in page dictionaries.</p></li>
<li><p>Any helper or core library class may use helpers in their
implementations.</p></li>
</ul>
<p>Prior to qpdf version 8.1, higher level interfaces were added as
“convenience functions” in either <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> or <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. For
compatibility, older convenience functions for operating with pages will
remain in those classes even as alternatives are provided in helper
classes. Going forward, new higher level interfaces will be provided
using helper classes.</p>
</section>
<section id="implementation-notes">
<span id="id3"></span><h3>Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline"></a></h3>
<p>This section contains a few notes about QPDF’s internal implementation,
particularly around what it does when it first processes a file. This
section is a bit of a simplification of what it actually does, but it
could serve as a starting point to someone trying to understand the
implementation. There is nothing in this section that you need to know
to use the qpdf library.</p>
<p><code class="docutils literal notranslate"><span class="pre">QPDFObject</span></code> is the basic PDF Object class. It is an abstract base
class from which are derived classes for each type of PDF object.
Clients do not interact with Objects directly but instead interact with
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class creates a new object, it dynamically allocates
the appropriate type of <code class="docutils literal notranslate"><span class="pre">QPDFObject</span></code> and immediately hands the pointer
to an instance of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. The parser reads a token from
the current file position. If the token is a not either a dictionary or
array opener, an object is immediately constructed from the single token
and the parser returns. Otherwise, the parser iterates in a special mode
in which it accumulates objects until it finds a balancing closer.
During this process, the “<code class="docutils literal notranslate"><span class="pre">R</span></code>” keyword is recognized and an indirect
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> may be constructed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">QPDF::resolve()</span></code> method, which is used to resolve an indirect
object, may be invoked from the <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> class. It first
checks a cache to see whether this object has already been read. If not,
it reads the object from the PDF file and caches it. It the returns the
resulting <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. The calling object handle then replaces
its <code class="docutils literal notranslate"><span class="pre">PointerHolder&lt;QDFObject&gt;</span></code> with the one from the newly returned
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. In this way, only a single copy of any direct
object need exist and clients can access objects transparently without
knowing caring whether they are direct or indirect objects.
Additionally, no object is ever read from the file more than once. That
means that only the portions of the PDF file that are actually needed
are ever read from the input file, thus allowing the qpdf package to
take advantage of this important design goal of PDF files.</p>
<p>If the requested object is inside of an object stream, the object stream
itself is first read into memory. Then the tokenizer reads objects from
the memory stream based on the offset information stored in the stream.
Those individual objects are cached, after which the temporary buffer
holding the object stream contents are discarded. In this way, the first
time an object in an object stream is requested, all objects in the
stream are cached.</p>
<p>The following example should clarify how <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> processes a simple
file.</p>
<ul>
<li><p>Client constructs <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> <code class="docutils literal notranslate"><span class="pre">pdf</span></code> and calls
<code class="docutils literal notranslate"><span class="pre">pdf.processFile(&quot;a.pdf&quot;);</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class checks the beginning of
<code class="file docutils literal notranslate"><span class="pre">a.pdf</span></code> for a PDF header. It then reads the
cross reference table mentioned at the end of the file, ensuring that
it is looking before the last <code class="docutils literal notranslate"><span class="pre">%%EOF</span></code>. After getting to <code class="docutils literal notranslate"><span class="pre">trailer</span></code>
keyword, it invokes the parser.</p></li>
<li><p>The parser sees “<code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code>”, so it calls itself recursively in
dictionary creation mode.</p></li>
<li><p>In dictionary creation mode, the parser keeps accumulating objects
until it encounters “<code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code>”. Each object that is read is pushed onto
a stack. If “<code class="docutils literal notranslate"><span class="pre">R</span></code>” is read, the last two objects on the stack are
inspected. If they are integers, they are popped off the stack and
their values are used to construct an indirect object handle which is
then pushed onto the stack. When “<code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code>” is finally read, the stack
is converted into a <code class="docutils literal notranslate"><span class="pre">QPDF_Dictionary</span></code> which is placed in a
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> and returned.</p></li>
<li><p>The resulting dictionary is saved as the trailer dictionary.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">/Prev</span></code> key is searched. If present, <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> seeks to that
point and repeats except that the new trailer dictionary is not
saved. If <code class="docutils literal notranslate"><span class="pre">/Prev</span></code> is not present, the initial parsing process is
complete.</p>
<p>If there is an encryption dictionary, the document’s encryption
parameters are initialized.</p>
</li>
<li><p>The client requests root object. The <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class gets the value of
root key from trailer dictionary and returns it. It is an unresolved
indirect <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>.</p></li>
<li><p>The client requests the <code class="docutils literal notranslate"><span class="pre">/Pages</span></code> key from root
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. The <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> notices that it is
indirect so it asks <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> to resolve it. <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> looks in the
object cache for an object with the root dictionary’s object ID and
generation number. Upon not seeing it, it checks the cross reference
table, gets the offset, and reads the object present at that offset.
It stores the result in the object cache and returns the cached
result. The calling <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> replaces its object pointer
with the one from the resolved <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>, verifies that it
a valid dictionary object, and returns the (unresolved indirect)
<code class="docutils literal notranslate"><span class="pre">QPDFObject</span></code> handle to the top of the Pages hierarchy.</p>
<p>As the client continues to request objects, the same process is
followed for each new requested object.</p>
</li>
</ul>
</section>
<section id="casting-policy">
<span id="casting"></span><h3>Casting Policy<a class="headerlink" href="#casting-policy" title="Permalink to this headline"></a></h3>
<p>This section describes the casting policy followed by qpdf’s
implementation. This is no concern to qpdf’s end users and largely of no
concern to people writing code that uses qpdf, but it could be of
interest to people who are porting qpdf to a new platform or who are
making modifications to the code.</p>
<p>The C++ code in qpdf is free of old-style casts except where unavoidable
(e.g. where the old-style cast is in a macro provided by a third-party
header file). When there is a need for a cast, it is handled, in order
of preference, by rewriting the code to avoid the need for a cast,
calling <code class="docutils literal notranslate"><span class="pre">const_cast</span></code>, calling <code class="docutils literal notranslate"><span class="pre">static_cast</span></code>, calling
<code class="docutils literal notranslate"><span class="pre">reinterpret_cast</span></code>, or calling some combination of the above. As a
last resort, a compiler-specific <code class="docutils literal notranslate"><span class="pre">#pragma</span></code> may be used to suppress a
warning that we don’t want to fix. Examples may include suppressing
warnings about the use of old-style casts in code that is shared between
C and C++ code.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">QIntC</span></code> namespace, provided by
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QIntC.hh</span></code>, implements safe
functions for converting between integer types. These functions do range
checking and throw a <code class="docutils literal notranslate"><span class="pre">std::range_error</span></code>, which is subclass of
<code class="docutils literal notranslate"><span class="pre">std::runtime_error</span></code>, if conversion from one integer type to another
results in loss of information. There are many cases in which we have to
move between different integer types because of incompatible integer
types used in interoperable interfaces. Some are unavoidable, such as
moving between sizes and offsets, and others are there because of old
code that is too in entrenched to be fixable without breaking source
compatibility and causing pain for users. QPDF is compiled with extra
warnings to detect conversions with potential data loss, and all such
cases should be fixed by either using a function from <code class="docutils literal notranslate"><span class="pre">QIntC</span></code> or a
<code class="docutils literal notranslate"><span class="pre">static_cast</span></code>.</p>
<p>When the intention is just to switch the type because of exchanging data
between incompatible interfaces, use <code class="docutils literal notranslate"><span class="pre">QIntC</span></code>. This is the usual case.
However, there are some cases in which we are explicitly intending to
use the exact same bit pattern with a different type. This is most
common when switching between signed and unsigned characters. A lot of
qpdf’s code uses unsigned characters internally, but <code class="docutils literal notranslate"><span class="pre">std::string</span></code> and
<code class="docutils literal notranslate"><span class="pre">char</span></code> are signed. Using <code class="docutils literal notranslate"><span class="pre">QIntC::to_char</span></code> would be wrong for
converting from unsigned to signed characters because a negative
<code class="docutils literal notranslate"><span class="pre">char</span></code> value and the corresponding <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">char</span></code> value greater
than 127 <em>mean the same thing</em>. There are also
cases in which we use <code class="docutils literal notranslate"><span class="pre">static_cast</span></code> when working with bit fields where
we are not representing a numerical value but rather a bunch of bits
packed together in some integer type. Also note that <code class="docutils literal notranslate"><span class="pre">size_t</span></code> and
<code class="docutils literal notranslate"><span class="pre">long</span></code> both typically differ between 32-bit and 64-bit environments,
so sometimes an explicit cast may not be needed to avoid warnings on one
platform but may be needed on another. A conversion with <code class="docutils literal notranslate"><span class="pre">QIntC</span></code>
should always be used when the types are different even if the
underlying size is the same. QPDF’s CI build builds on 32-bit and 64-bit
platforms, and the test suite is very thorough, so it is hard to make
any of the potential errors here without being caught in build or test.</p>
<p>Non-const <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">char*</span></code> is used in the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> interface. The
pipeline interface has a <code class="docutils literal notranslate"><span class="pre">write</span></code> call that uses <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">char*</span></code>
without a <code class="docutils literal notranslate"><span class="pre">const</span></code> qualifier. The main reason for this is
to support pipelines that make calls to third-party libraries, such as
zlib, that don’t include <code class="docutils literal notranslate"><span class="pre">const</span></code> in their interfaces. Unfortunately,
there are many places in the code where it is desirable to have
<code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char*</span></code> with pipelines. None of the pipeline implementations
in qpdf
currently modify the data passed to write, and doing so would be counter
to the intent of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>, but there is nothing in the code to
prevent this from being done. There are places in the code where
<code class="docutils literal notranslate"><span class="pre">const_cast</span></code> is used to remove the const-ness of pointers going into
<code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>s. This could theoretically be unsafe, but there is
adequate testing to assert that it is safe and will remain safe in
qpdf’s code.</p>
</section>
<section id="encryption">
<span id="id4"></span><h3>Encryption<a class="headerlink" href="#encryption" title="Permalink to this headline"></a></h3>
<p>Encryption is supported transparently by qpdf. When opening a PDF file,
if an encryption dictionary exists, the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object processes this
dictionary using the password (if any) provided. The primary decryption
key is computed and cached. No further access is made to the encryption
dictionary after that time. When an object is read from a file, the
object ID and generation of the object in which it is contained is
always known. Using this information along with the stored encryption
key, all stream and string objects are transparently decrypted. Raw
encrypted objects are never stored in memory. This way, nothing in the
library ever has to know or care whether it is reading an encrypted
file.</p>
<p>An interface is also provided for writing encrypted streams and strings
given an encryption key. This is used by <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> when it rewrites
encrypted files.</p>
<p>When copying encrypted files, unless otherwise directed, qpdf will
preserve any encryption in force in the original file. qpdf can do this
with either the user or the owner password. There is no difference in
capability based on which password is used. When 40 or 128 bit
encryption keys are used, the user password can be recovered with the
owner password. With 256 keys, the user and owner passwords are used
independently to encrypt the actual encryption key, so while either can
be used, the owner password can no longer be used to recover the user
password.</p>
<p>Starting with version 4.0.0, qpdf can read files that are not encrypted
but that contain encrypted attachments, but it cannot write such files.
qpdf also requires the password to be specified in order to open the
file, not just to extract attachments, since once the file is open, all
decryption is handled transparently. When copying files like this while
preserving encryption, qpdf will apply the file’s encryption to
everything in the file, not just to the attachments. When decrypting the
file, qpdf will decrypt the attachments. In general, when copying PDF
files with multiple encryption formats, qpdf will choose the newest
format. The only exception to this is that clear-text metadata will be
preserved as clear-text if it is that way in the original file.</p>
<p>One point of confusion some people have about encrypted PDF files is
that encryption is not the same as password protection. Password
protected files are always encrypted, but it is also possible to create
encrypted files that do not have passwords. Internally, such files use
the empty string as a password, and most readers try the empty string
first to see if it works and prompt for a password only if the empty
string doesn’t work. Normally such files have an empty user password and
a non-empty owner password. In that way, if the file is opened by an
ordinary reader without specification of password, the restrictions
specified in the encryption dictionary can be enforced. Most users
wouldn’t even realize such a file was encrypted. Since qpdf always
ignores the restrictions (except for the purpose of reporting what they
are), qpdf doesn’t care which password you use. QPDF will allow you to
create PDF files with non-empty user passwords and empty owner
passwords. Some readers will require a password when you open these
files, and others will open the files without a password and not enforce
restrictions. Having a non-empty user password and an empty owner
password doesn’t really make sense because it would mean that opening
the file with the user password would be more restrictive than not
supplying a password at all. QPDF also allows you to create PDF files
with the same password as both the user and owner password. Some readers
will not ever allow such files to be accessed without restrictions
because they never try the password as the owner password if it works as
the user password. Nonetheless, one of the powerful aspects of qpdf is
that it allows you to finely specify the way encrypted files are
created, even if the results are not useful to some readers. One use
case for this would be for testing a PDF reader to ensure that it
handles odd configurations of input files.</p>
</section>
<section id="random-number-generation">
<span id="random-numbers"></span><h3>Random Number Generation<a class="headerlink" href="#random-number-generation" title="Permalink to this headline"></a></h3>
<p>QPDF generates random numbers to support generation of encrypted data.
Starting in qpdf 10.0.0, qpdf uses the crypto provider as its source of
random numbers. Older versions used the OS-provided source of secure
random numbers or, if allowed at build time, insecure random numbers
from stdlib. Starting with version 5.1.0, you can disable use of
OS-provided secure random numbers at build time. This is especially
useful on Windows if you want to avoid a dependency on Microsoft’s
cryptography API. You can also supply your own random data provider. For
details on how to do this, please refer to the top-level README.md file
in the source distribution and to comments in
<code class="file docutils literal notranslate"><span class="pre">QUtil.hh</span></code>.</p>
</section>
<section id="adding-and-removing-pages">
<span id="adding-and-remove-pages"></span><h3>Adding and Removing Pages<a class="headerlink" href="#adding-and-removing-pages" title="Permalink to this headline"></a></h3>
<p>While qpdf’s API has supported adding and modifying objects for some
time, version 3.0 introduces specific methods for adding and removing
pages. These are largely convenience routines that handle two tricky
issues: pushing inheritable resources from the <code class="docutils literal notranslate"><span class="pre">/Pages</span></code> tree down to
individual pages and manipulation of the <code class="docutils literal notranslate"><span class="pre">/Pages</span></code> tree itself. For
details, see <code class="docutils literal notranslate"><span class="pre">addPage</span></code> and surrounding methods in
<code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code>.</p>
</section>
<section id="reserving-object-numbers">
<span id="reserved-objects"></span><h3>Reserving Object Numbers<a class="headerlink" href="#reserving-object-numbers" title="Permalink to this headline"></a></h3>
<p>Version 3.0 of qpdf introduced the concept of reserved objects. These
are seldom needed for ordinary operations, but there are cases in which
you may want to add a series of indirect objects with references to each
other to a <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object. This causes a problem because you can’t
determine the object ID that a new indirect object will have until you
add it to the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object with <code class="docutils literal notranslate"><span class="pre">QPDF::makeIndirectObject</span></code>. The
only way to add two mutually referential objects to a <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object
prior to version 3.0 would be to add the new objects first and then make
them refer to each other after adding them. Now it is possible to create
a <em>reserved object</em> using
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::newReserved</span></code>. This is an indirect object that stays
“unresolved” even if it is queried for its type. So now, if you want to
create a set of mutually referential objects, you can create
reservations for each one of them and use those reservations to
construct the references. When finished, you can call
<code class="docutils literal notranslate"><span class="pre">QPDF::replaceReserved</span></code> to replace the reserved objects with the real
ones. This functionality will never be needed by most applications, but
it is used internally by QPDF when copying objects from other PDF files,
as discussed in <a class="reference internal" href="#foreign-objects"><span class="std std-ref">Copying Objects From Other PDF Files</span></a>. For an example of how to use reserved
objects, search for <code class="docutils literal notranslate"><span class="pre">newReserved</span></code> in
<code class="file docutils literal notranslate"><span class="pre">test_driver.cc</span></code> in qpdf’s sources.</p>
</section>
<section id="copying-objects-from-other-pdf-files">
<span id="foreign-objects"></span><h3>Copying Objects From Other PDF Files<a class="headerlink" href="#copying-objects-from-other-pdf-files" title="Permalink to this headline"></a></h3>
<p>Version 3.0 of qpdf introduced the ability to copy objects into a
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object from a different <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object, which we refer to as
<em>foreign objects</em>. This allows arbitrary
merging of PDF files. The “from” <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object must remain valid after
the copy as discussed in the note below. The
<strong class="command">qpdf</strong> command-line tool provides limited
support for basic page selection, including merging in pages from other
files, but the library’s API makes it possible to implement arbitrarily
complex merging operations. The main method for copying foreign objects
is <code class="docutils literal notranslate"><span class="pre">QPDF::copyForeignObject</span></code>. This takes an indirect object from
another <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> and copies it recursively into this object while
preserving all object structure, including circular references. This
means you can add a direct object that you create from scratch to a
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object with <code class="docutils literal notranslate"><span class="pre">QPDF::makeIndirectObject</span></code>, and you can add an
indirect object from another file with <code class="docutils literal notranslate"><span class="pre">QPDF::copyForeignObject</span></code>. The
fact that <code class="docutils literal notranslate"><span class="pre">QPDF::makeIndirectObject</span></code> does not automatically detect a
foreign object and copy it is an explicit design decision. Copying a
foreign object seems like a sufficiently significant thing to do that it
should be done explicitly.</p>
<p>The other way to copy foreign objects is by passing a page from one
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> to another by calling <code class="docutils literal notranslate"><span class="pre">QPDF::addPage</span></code>. In contrast to
<code class="docutils literal notranslate"><span class="pre">QPDF::makeIndirectObject</span></code>, this method automatically distinguishes
between indirect objects in the current file, foreign objects, and
direct objects.</p>
<p>Please note: when you copy objects from one <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> to another, the
source <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object must remain valid until you have finished with
the destination object. This is because the original object is still
used to retrieve any referenced stream data from the copied object.</p>
</section>
<section id="writing-pdf-files">
<span id="rewriting"></span><h3>Writing PDF Files<a class="headerlink" href="#writing-pdf-files" title="Permalink to this headline"></a></h3>
<p>The qpdf library supports file writing of <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> objects to PDF files
through the <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> class. The <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> class has two
writing modes: one for non-linearized files, and one for linearized
files. See <a class="reference internal" href="index.html#linearization"><span class="std std-ref">Linearization</span></a> for a description of
linearization is implemented. This section describes how we write
non-linearized files including the creation of QDF files (see <a class="reference internal" href="index.html#qdf"><span class="std std-ref">QDF Mode</span></a>.</p>
<p>This outline was written prior to implementation and is not exactly
accurate, but it provides a correct “notional” idea of how writing
works. Look at the code in <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> for exact details.</p>
<ul>
<li><p>Initialize state:</p>
<ul class="simple">
<li><p>next object number = 1</p></li>
<li><p>object queue = empty</p></li>
<li><p>renumber table: old object id/generation to new id/0 = empty</p></li>
<li><p>xref table: new id -&gt; offset = empty</p></li>
</ul>
</li>
<li><p>Create a QPDF object from a file.</p></li>
<li><p>Write header for new PDF file.</p></li>
<li><p>Request the trailer dictionary.</p></li>
<li><p>For each value that is an indirect object, grab the next object
number (via an operation that returns and increments the number). Map
object to new number in renumber table. Push object onto queue.</p></li>
<li><p>While there are more objects on the queue:</p>
<ul>
<li><p>Pop queue.</p></li>
<li><p>Look up object’s new number <em>n</em> in the renumbering table.</p></li>
<li><p>Store current offset into xref table.</p></li>
<li><p>Write <code class="docutils literal notranslate"><span class="pre">:samp:`{n}`</span> <span class="pre">0</span> <span class="pre">obj</span></code>.</p></li>
<li><p>If object is null, whether direct or indirect, write out null,
thus eliminating unresolvable indirect object references.</p></li>
<li><p>If the object is a stream stream, write stream contents, piped
through any filters as required, to a memory buffer. Use this
buffer to determine the stream length.</p></li>
<li><p>If object is not a stream, array, or dictionary, write out its
contents.</p></li>
<li><p>If object is an array or dictionary (including stream), traverse
its elements (for array) or values (for dictionaries), handling
recursive dictionaries and arrays, looking for indirect objects.
When an indirect object is found, if it is not resolvable, ignore.
(This case is handled when writing it out.) Otherwise, look it up
in the renumbering table. If not found, grab the next available
object number, assign to the referenced object in the renumbering
table, and push the referenced object onto the queue. As a special
case, when writing out a stream dictionary, replace length,
filters, and decode parameters as required.</p>
<p>Write out dictionary or array, replacing any unresolvable indirect
object references with null (pdf spec says reference to
non-existent object is legal and resolves to null) and any
resolvable ones with references to the renumbered objects.</p>
</li>
<li><p>If the object is a stream, write <code class="docutils literal notranslate"><span class="pre">stream\n</span></code>, the stream contents
(from the memory buffer), and <code class="docutils literal notranslate"><span class="pre">\nendstream\n</span></code>.</p></li>
<li><p>When done, write <code class="docutils literal notranslate"><span class="pre">endobj</span></code>.</p></li>
</ul>
</li>
</ul>
<p>Once we have finished the queue, all referenced objects will have been
written out and all deleted objects or unreferenced objects will have
been skipped. The new cross-reference table will contain an offset for
every new object number from 1 up to the number of objects written. This
can be used to write out a new xref table. Finally we can write out the
trailer dictionary with appropriately computed /ID (see spec, 8.3, File
Identifiers), the cross reference table offset, and <code class="docutils literal notranslate"><span class="pre">%%EOF</span></code>.</p>
</section>
<section id="filtered-streams">
<span id="id5"></span><h3>Filtered Streams<a class="headerlink" href="#filtered-streams" title="Permalink to this headline"></a></h3>
<p>Support for streams is implemented through the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> interface
which was designed for this package.</p>
<p>When reading streams, create a series of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> objects. The
<code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> abstract base requires implementation <code class="docutils literal notranslate"><span class="pre">write()</span></code> and
<code class="docutils literal notranslate"><span class="pre">finish()</span></code> and provides an implementation of <code class="docutils literal notranslate"><span class="pre">getNext()</span></code>. Each
pipeline object, upon receiving data, does whatever it is going to do
and then writes the data (possibly modified) to its successor.
Alternatively, a pipeline may be an end-of-the-line pipeline that does
something like store its output to a file or a memory buffer ignoring a
successor. For additional details, look at
<code class="file docutils literal notranslate"><span class="pre">Pipeline.hh</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">QPDF</span></code> can read raw or filtered streams. When reading a filtered
stream, the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class creates a <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> object for one of each
appropriate filter object and chains them together. The last filter
should write to whatever type of output is required. The <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class
has an interface to write raw or filtered stream contents to a given
pipeline.</p>
</section>
<section id="object-accessor-methods">
<span id="object-accessors"></span><h3>Object Accessor Methods<a class="headerlink" href="#object-accessor-methods" title="Permalink to this headline"></a></h3>
<p>For general information about how to access instances of
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>, please see the comments in
<code class="file docutils literal notranslate"><span class="pre">QPDFObjectHandle.hh</span></code>. Search for “Accessor
methods”. This section provides a more in-depth discussion of the
behavior and the rationale for the behavior.</p>
<p><em>Why were type errors made into warnings?</em> When type checks were
introduced into qpdf in the early days, it was expected that type errors
would only occur as a result of programmer error. However, in practice,
type errors would occur with malformed PDF files because of assumptions
made in code, including code within the qpdf library and code written by
library users. The most common case would be chaining calls to
<code class="docutils literal notranslate"><span class="pre">getKey()</span></code> to access keys deep within a dictionary. In many cases,
qpdf would be able to recover from these situations, but the old
behavior often resulted in crashes rather than graceful recovery. For
this reason, the errors were changed to warnings.</p>
<p><em>Why even warn about type errors when the user can’t usually do anything
about them?</em> Type warnings are extremely valuable during development.
Since it’s impossible to catch at compile time things like typos in
dictionary key names or logic errors around what the structure of a PDF
file might be, the presence of type warnings can save lots of developer
time. They have also proven useful in exposing issues in qpdf itself
that would have otherwise gone undetected.</p>
<p><em>Can there be a type-safe ``QPDFObjectHandle``?</em> It would be great if
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> could be more strongly typed so that you’d have to
have check that something was of a particular type before calling
type-specific accessor methods. However, implementing this at this stage
of the library’s history would be quite difficult, and it would make a
the common pattern of drilling into an object no longer work. While it
would be possible to have a parallel interface, it would create a lot of
extra code. If qpdf were written in a language like rust, an interface
like this would make a lot of sense, but, for a variety of reasons, the
qpdf API is consistent with other APIs of its time, relying on exception
handling to catch errors. The underlying PDF objects are inherently not
type-safe. Forcing stronger type safety in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> would
ultimately cause a lot more code to have to be written and would like
make software that uses qpdf more brittle, and even so, checks would
have to occur at runtime.</p>
<p><em>Why do type errors sometimes raise exceptions?</em> The way warnings work
in qpdf requires a <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object to be associated with an object
handle for a warning to be issued. It would be nice if this could be
fixed, but it would require major changes to the API. Rather than
throwing away these conditions, we convert them to exceptions. It’s not
that bad though. Since any object handle that was read from a file has
an associated <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object, it would only be type errors on objects
that were created explicitly that would cause exceptions, and in that
case, type errors are much more likely to be the result of a coding
error than invalid input.</p>
<p><em>Why does the behavior of a type exception differ between the C and C++
API?</em> There is no way to throw and catch exceptions in C short of
something like <code class="docutils literal notranslate"><span class="pre">setjmp</span></code> and <code class="docutils literal notranslate"><span class="pre">longjmp</span></code>, and that approach is not
portable across language barriers. Since the C API is often used from
other languages, it’s important to keep things as simple as possible.
Starting in qpdf 10.5, exceptions that used to crash code using the C
API will be written to stderr by default, and it is possible to register
an error handler. There’s no reason that the error handler can’t
simulate exception handling in some way, such as by using <code class="docutils literal notranslate"><span class="pre">setjmp</span></code> and
<code class="docutils literal notranslate"><span class="pre">longjmp</span></code> or by setting some variable that can be checked after
library calls are made. In retrospect, it might have been better if the
C API object handle methods returned error codes like the other methods
and set return values in passed-in pointers, but this would complicate
both the implementation and the use of the library for a case that is
actually quite rare and largely avoidable.</p>
</section>
</section>
<span id="document-linearization"></span><section id="linearization">
<span id="id1"></span><h2>Linearization<a class="headerlink" href="#linearization" title="Permalink to this headline"></a></h2>
<p>This chapter describes how <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> and <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> implement
creation and processing of linearized PDFS.</p>
<section id="basic-strategy-for-linearization">
<span id="linearization-strategy"></span><h3>Basic Strategy for Linearization<a class="headerlink" href="#basic-strategy-for-linearization" title="Permalink to this headline"></a></h3>
<p>To avoid the incestuous problem of having the qpdf library validate its
own linearized files, we have a special linearized file checking mode
which can be invoked via <strong class="command">qpdf
--check-linearization</strong> (or <strong class="command">qpdf
--check</strong>). This mode reads the linearization parameter
dictionary and the hint streams and validates that object ordering,
parameters, and hint stream contents are correct. The validation code
was first tested against linearized files created by external tools
(Acrobat and pdlin) and then used to validate files created by
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> itself.</p>
</section>
<section id="preparing-for-linearization">
<span id="linearized-preparation"></span><h3>Preparing For Linearization<a class="headerlink" href="#preparing-for-linearization" title="Permalink to this headline"></a></h3>
<p>Before creating a linearized PDF file from any other PDF file, the PDF
file must be altered such that all page attributes are propagated down
to the page level (and not inherited from parents in the <code class="docutils literal notranslate"><span class="pre">/Pages</span></code>
tree). We also have to know which objects refer to which other objects,
being concerned with page boundaries and a few other cases. We refer to
this part of preparing the PDF file as
<em>optimization</em>, discussed in
<a class="reference internal" href="#optimization"><span class="std std-ref">Optimization</span></a>. Note the, in this context, the
term <em>optimization</em> is a qpdf term, and the
term <em>linearization</em> is a term from the PDF
specification. Do not be confused by the fact that many applications
refer to linearization as optimization or web optimization.</p>
<p>When creating linearized PDF files from optimized PDF files, there are
really only a few issues that need to be dealt with:</p>
<ul class="simple">
<li><p>Creation of hints tables</p></li>
<li><p>Placing objects in the correct order</p></li>
<li><p>Filling in offsets and byte sizes</p></li>
</ul>
</section>
<section id="optimization">
<span id="id2"></span><h3>Optimization<a class="headerlink" href="#optimization" title="Permalink to this headline"></a></h3>
<p>In order to perform various operations such as linearization and
splitting files into pages, it is necessary to know which objects are
referenced by which pages, page thumbnails, and root and trailer
dictionary keys. It is also necessary to ensure that all page-level
attributes appear directly at the page level and are not inherited from
parents in the pages tree.</p>
<p>We refer to the process of enforcing these constraints as
<em>optimization</em>. As mentioned above, note
that some applications refer to linearization as optimization. Although
this optimization was initially motivated by the need to create
linearized files, we are using these terms separately.</p>
<p>PDF file optimization is implemented in the
<code class="file docutils literal notranslate"><span class="pre">QPDF_optimization.cc</span></code> source file. That file
is richly commented and serves as the primary reference for the
optimization process.</p>
<p>After optimization has been completed, the private member variables
<code class="docutils literal notranslate"><span class="pre">obj_user_to_objects</span></code> and <code class="docutils literal notranslate"><span class="pre">object_to_obj_users</span></code> in <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> have
been populated. Any object that has more than one value in the
<code class="docutils literal notranslate"><span class="pre">object_to_obj_users</span></code> table is shared. Any object that has exactly one
value in the <code class="docutils literal notranslate"><span class="pre">object_to_obj_users</span></code> table is private. To find all the
private objects in a page or a trailer or root dictionary key, one
merely has make this determination for each element in the
<code class="docutils literal notranslate"><span class="pre">obj_user_to_objects</span></code> table for the given page or key.</p>
<p>Note that pages and thumbnails have different object user types, so the
above test on a page will not include objects referenced by the page’s
thumbnail dictionary and nothing else.</p>
</section>
<section id="writing-linearized-files">
<span id="linearization-writing"></span><h3>Writing Linearized Files<a class="headerlink" href="#writing-linearized-files" title="Permalink to this headline"></a></h3>
<p>We will create files with only primary hint streams. We will never write
overflow hint streams. (As of PDF version 1.4, Acrobat doesn’t either,
and they are never necessary.) The hint streams contain offset
information to objects that point to where they would be if the hint
stream were not present. This means that we have to calculate all object
positions before we can generate and write the hint table. This means
that we have to generate the file in two passes. To make this reliable,
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> in linearization mode invokes exactly the same code twice
to write the file to a pipeline.</p>
<p>In the first pass, the target pipeline is a count pipeline chained to a
discard pipeline. The count pipeline simply passes its data through to
the next pipeline in the chain but can return the number of bytes passed
through it at any intermediate point. The discard pipeline is an end of
line pipeline that just throws its data away. The hint stream is not
written and dummy values with adequate padding are stored in the first
cross reference table, linearization parameter dictionary, and /Prev key
of the first trailer dictionary. All the offset, length, object
renumbering information, and anything else we need for the second pass
is stored.</p>
<p>At the end of the first pass, this information is passed to the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code>
class which constructs a compressed hint stream in a memory buffer and
returns it. <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> uses this information to write a complete
hint stream object into a memory buffer. At this point, the length of
the hint stream is known.</p>
<p>In the second pass, the end of the pipeline chain is a regular file
instead of a discard pipeline, and we have known values for all the
offsets and lengths that we didn’t have in the first pass. We have to
adjust offsets that appear after the start of the hint stream by the
length of the hint stream, which is known. Anything that is of variable
length is padded, with the padding code surrounding any writing code
that differs in the two passes. This ensures that changes to the way
things are represented never results in offsets that were gathered
during the first pass becoming incorrect for the second pass.</p>
<p>Using this strategy, we can write linearized files to a non-seekable
output stream with only a single pass to disk or wherever the output is
going.</p>
</section>
<section id="calculating-linearization-data">
<span id="linearization-data"></span><h3>Calculating Linearization Data<a class="headerlink" href="#calculating-linearization-data" title="Permalink to this headline"></a></h3>
<p>Once a file is optimized, we have information about which objects access
which other objects. We can then process these tables to decide which
part (as described in “Linearized PDF Document Structure” in the PDF
specification) each object is contained within. This tells us the exact
order in which objects are written. The <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> class asks for
this information and enqueues objects for writing in the proper order.
It also turns on a check that causes an exception to be thrown if an
object is encountered that has not already been queued. (This could
happen only if there were a bug in the traversal code used to calculate
the linearization data.)</p>
</section>
<section id="known-issues-with-linearization">
<span id="linearization-issues"></span><h3>Known Issues with Linearization<a class="headerlink" href="#known-issues-with-linearization" title="Permalink to this headline"></a></h3>
<p>There are a handful of known issues with this linearization code. These
issues do not appear to impact the behavior of linearized files which
still work as intended: it is possible for a web browser to begin to
display them before they are fully downloaded. In fact, it seems that
various other programs that create linearized files have many of these
same issues. These items make reference to terminology used in the
linearization appendix of the PDF specification.</p>
<ul class="simple">
<li><p>Thread Dictionary information keys appear in part 4 with the rest of
Threads instead of in part 9. Objects in part 9 are not grouped
together functionally.</p></li>
<li><p>We are not calculating numerators for shared object positions within
content streams or interleaving them within content streams.</p></li>
<li><p>We generate only page offset, shared object, and outline hint tables.
It would be relatively easy to add some additional tables. We gather
most of the information needed to create thumbnail hint tables. There
are comments in the code about this.</p></li>
</ul>
</section>
<section id="debugging-note">
<span id="linearization-debugging"></span><h3>Debugging Note<a class="headerlink" href="#debugging-note" title="Permalink to this headline"></a></h3>
<p>The <strong class="command">qpdf --show-linearization</strong> command can show
the complete contents of linearization hint streams. To look at the raw
data, you can extract the filtered contents of the linearization hint
tables using <strong class="command">qpdf --show-object=n
--filtered-stream-data</strong>. Then, to convert this into a bit
stream (since linearization tables are bit streams written without
regard to byte boundaries), you can pipe the resulting data through the
following perl code:</p>
<div class="highlight-perl notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nn">bytes</span><span class="p">;</span>
<span class="nb">binmode</span> <span class="bp">STDIN</span><span class="p">;</span>
<span class="nb">undef</span> <span class="vg">$/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$a</span> <span class="o">=</span> <span class="sr">&lt;STDIN&gt;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">@ch</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">//</span><span class="p">,</span> <span class="nv">$a</span><span class="p">);</span>
<span class="nb">map</span> <span class="p">{</span> <span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%08b&quot;</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$_</span><span class="p">))</span> <span class="p">}</span> <span class="nv">@ch</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<span id="document-object-streams"></span><section id="object-and-cross-reference-streams">
<span id="object-and-xref-streams"></span><h2>Object and Cross-Reference Streams<a class="headerlink" href="#object-and-cross-reference-streams" title="Permalink to this headline"></a></h2>
<p>This chapter provides information about the implementation of object
stream and cross-reference stream support in qpdf.</p>
<section id="object-streams">
<span id="id1"></span><h3>Object Streams<a class="headerlink" href="#object-streams" title="Permalink to this headline"></a></h3>
<p>Object streams can contain any regular object except the following:</p>
<ul class="simple">
<li><p>stream objects</p></li>
<li><p>objects with generation &gt; 0</p></li>
<li><p>the encryption dictionary</p></li>
<li><p>objects containing the /Length of another stream</p></li>
</ul>
<p>In addition, Adobe reader (at least as of version 8.0.0) appears to not
be able to handle having the document catalog appear in an object stream
if the file is encrypted, though this is not specifically disallowed by
the specification.</p>
<p>There are additional restrictions for linearized files. See
<a class="reference internal" href="#object-streams-linearization"><span class="std std-ref">Implications for Linearized Files</span></a> for details.</p>
<p>The PDF specification refers to objects in object streams as “compressed
objects” regardless of whether the object stream is compressed.</p>
<p>The generation number of every object in an object stream must be zero.
It is possible to delete and replace an object in an object stream with
a regular object.</p>
<p>The object stream dictionary has the following keys:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/N</span></code>: number of objects</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/First</span></code>: byte offset of first object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/Extends</span></code>: indirect reference to stream that this extends</p></li>
</ul>
<p>Stream collections are formed with <code class="docutils literal notranslate"><span class="pre">/Extends</span></code>. They must form a
directed acyclic graph. These can be used for semantic information and
are not meaningful to the PDF document’s syntactic structure. Although
qpdf preserves stream collections, it never generates them and doesn’t
make use of this information in any way.</p>
<p>The specification recommends limiting the number of objects in object
stream for efficiency in reading and decoding. Acrobat 6 uses no more
than 100 objects per object stream for linearized files and no more 200
objects per stream for non-linearized files. <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>, in object
stream generation mode, never puts more than 100 objects in an object
stream.</p>
<p>Object stream contents consists of <em>N</em> pairs of integers, each of which
is the object number and the byte offset of the object relative to the
first object in the stream, followed by the objects themselves,
concatenated.</p>
</section>
<section id="cross-reference-streams">
<span id="xref-streams"></span><h3>Cross-Reference Streams<a class="headerlink" href="#cross-reference-streams" title="Permalink to this headline"></a></h3>
<p>For non-hybrid files, the value following <code class="docutils literal notranslate"><span class="pre">startxref</span></code> is the byte
offset to the xref stream rather than the word <code class="docutils literal notranslate"><span class="pre">xref</span></code>.</p>
<p>For hybrid files (files containing both xref tables and cross-reference
streams), the xref table’s trailer dictionary contains the key
<code class="docutils literal notranslate"><span class="pre">/XRefStm</span></code> whose value is the byte offset to a cross-reference stream
that supplements the xref table. A PDF 1.5-compliant application should
read the xref table first. Then it should replace any object that it has
already seen with any defined in the xref stream. Then it should follow
any <code class="docutils literal notranslate"><span class="pre">/Prev</span></code> pointer in the original xref table’s trailer dictionary.
The specification is not clear about what should be done, if anything,
with a <code class="docutils literal notranslate"><span class="pre">/Prev</span></code> pointer in the xref stream referenced by an xref table.
The <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class ignores it, which is probably reasonable since, if
this case were to appear for any sensible PDF file, the previous xref
table would probably have a corresponding <code class="docutils literal notranslate"><span class="pre">/XRefStm</span></code> pointer of its
own. For example, if a hybrid file were appended, the appended section
would have its own xref table and <code class="docutils literal notranslate"><span class="pre">/XRefStm</span></code>. The appended xref table
would point to the previous xref table which would point the
<code class="docutils literal notranslate"><span class="pre">/XRefStm</span></code>, meaning that the new <code class="docutils literal notranslate"><span class="pre">/XRefStm</span></code> doesn’t have to point to
it.</p>
<p>Since xref streams must be read very early, they may not be encrypted,
and the may not contain indirect objects for keys required to read them,
which are these:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/Type</span></code>: value <code class="docutils literal notranslate"><span class="pre">/XRef</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/Size</span></code>: value <em>n+1</em>: where <em>n</em> is highest object number (same as
<code class="docutils literal notranslate"><span class="pre">/Size</span></code> in the trailer dictionary)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/Index</span></code> (optional): value
<code class="docutils literal notranslate"><span class="pre">[:samp:`{n</span> <span class="pre">count}`</span> <span class="pre">...]</span></code> used to determine
which objects’ information is stored in this stream. The default is
<code class="docutils literal notranslate"><span class="pre">[0</span> <span class="pre">/Size]</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/Prev</span></code>: value <code class="samp docutils literal notranslate"><em><span class="pre">offset</span></em></code>: byte
offset of previous xref stream (same as <code class="docutils literal notranslate"><span class="pre">/Prev</span></code> in the trailer
dictionary)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/W</span> <span class="pre">[...]</span></code>: sizes of each field in the xref table</p></li>
</ul>
<p>The other fields in the xref stream, which may be indirect if desired,
are the union of those from the xref table’s trailer dictionary.</p>
<section id="cross-reference-stream-data">
<span id="xref-stream-data"></span><h4>Cross-Reference Stream Data<a class="headerlink" href="#cross-reference-stream-data" title="Permalink to this headline"></a></h4>
<p>The stream data is binary and encoded in big-endian byte order. Entries
are concatenated, and each entry has a length equal to the total of the
entries in <code class="docutils literal notranslate"><span class="pre">/W</span></code> above. Each entry consists of one or more fields, the
first of which is the type of the field. The number of bytes for each
field is given by <code class="docutils literal notranslate"><span class="pre">/W</span></code> above. A 0 in <code class="docutils literal notranslate"><span class="pre">/W</span></code> indicates that the field
is omitted and has the default value. The default value for the field
type is “<code class="docutils literal notranslate"><span class="pre">1</span></code>”. All other default values are “<code class="docutils literal notranslate"><span class="pre">0</span></code>”.</p>
<p>PDF 1.5 has three field types:</p>
<ul class="simple">
<li><p>0: for free objects. Format: <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">obj</span> <span class="pre">next-generation</span></code>, same as the
free table in a traditional cross-reference table</p></li>
<li><p>1: regular non-compressed object. Format: <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">offset</span> <span class="pre">generation</span></code></p></li>
<li><p>2: for objects in object streams. Format: <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">object-stream-number</span>
<span class="pre">index</span></code>, the number of object stream containing the object and the
index within the object stream of the object.</p></li>
</ul>
<p>It seems standard to have the first entry in the table be <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">0</span> <span class="pre">0</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">0</span> <span class="pre">ffff</span></code> if there are no deleted objects.</p>
</section>
</section>
<section id="implications-for-linearized-files">
<span id="object-streams-linearization"></span><h3>Implications for Linearized Files<a class="headerlink" href="#implications-for-linearized-files" title="Permalink to this headline"></a></h3>
<p>For linearized files, the linearization dictionary, document catalog,
and page objects may not be contained in object streams.</p>
<p>Objects stored within object streams are given the highest range of
object numbers within the main and first-page cross-reference sections.</p>
<p>It is okay to use cross-reference streams in place of regular xref
tables. There are on special considerations.</p>
<p>Hint data refers to object streams themselves, not the objects in the
streams. Shared object references should also be made to the object
streams. There are no reference in any hint tables to the object numbers
of compressed objects (objects within object streams).</p>
<p>When numbering objects, all shared objects within both the first and
second halves of the linearized files must be numbered consecutively
after all normal uncompressed objects in that half.</p>
</section>
<section id="implementation-notes">
<span id="object-stream-implementation"></span><h3>Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline"></a></h3>
<p>There are three modes for writing object streams:
<code class="samp docutils literal notranslate"><span class="pre">disable</span></code>, <code class="samp docutils literal notranslate"><span class="pre">preserve</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">generate</span></code>. In disable mode, we do not generate
any object streams, and we also generate an xref table rather than xref
streams. This can be used to generate PDF files that are viewable with
older readers. In preserve mode, we write object streams such that
written object streams contain the same objects and <code class="docutils literal notranslate"><span class="pre">/Extends</span></code>
relationships as in the original file. This is equal to disable if the
file has no object streams. In generate, we create object streams
ourselves by grouping objects that are allowed in object streams
together in sets of no more than 100 objects. We also ensure that the
PDF version is at least 1.5 in generate mode, but we preserve the
version header in the other modes. The default is
<code class="samp docutils literal notranslate"><span class="pre">preserve</span></code>.</p>
<p>We do not support creation of hybrid files. When we write files, even in
preserve mode, we will lose any xref tables and merge any appended
sections.</p>
</section>
</section>
<span id="document-release-notes"></span><section id="release-notes">
<span id="id1"></span><h2>Release Notes<a class="headerlink" href="#release-notes" title="Permalink to this headline"></a></h2>
<p>For a detailed list of changes, please see the file
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> in the source distribution.</p>
<dl>
<dt>10.5.0: December 21, 2021</dt><dd><ul class="simple">
<li><p>Packaging changes</p>
<ul>
<li><p>Pre-built documentation is no longer distributed with the source
distribution. The AppImage and Windows binary distributions
still contain embedded documentation, and a separate <code class="docutils literal notranslate"><span class="pre">doc</span></code>
distribution file is available from the qpdf release site.
Documentation is now available at <a class="reference external" href="https://qpdf.readthedocs.io">https://qpdf.readthedocs.io</a> for every major/minor version
starting with version 10.5. Please see <a class="reference internal" href="index.html#packaging-doc"><span class="std std-ref">Packaging Documentation</span></a> for
details on how packagers should handle documentation.</p></li>
<li><p>The documentation sources have been switched from docbook to
reStructuredText processed with <a class="reference external" href="https://www.sphinx-doc.org">Sphinx</a>. This will break previous
documentation links. A redirect is in place on the main website.
A top-to-bottom review of the documentation is planned for an
upcoming release.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Since qpdf version 8, using object accessor methods on an
instance of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> may create warnings if the
object is not of the expected type. These warnings now have an
error code of <code class="docutils literal notranslate"><span class="pre">qpdf_e_object</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">qpdf_e_damaged_pdf</span></code>. Also, comments have been added to
<code class="file docutils literal notranslate"><span class="pre">QPDFObjectHandle.hh</span></code> to explain in more detail what the
behavior is. See <a class="reference internal" href="index.html#object-accessors"><span class="std std-ref">Object Accessor Methods</span></a> for a more in-depth
discussion.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">Pl_Buffer::getMallocBuffer()</span></code> to initialize a buffer
allocated with <code class="docutils literal notranslate"><span class="pre">malloc()</span></code> for better cross-language
interoperability.</p></li>
</ul>
</li>
<li><p>C API Enhancements</p>
<ul>
<li><p>Many thanks to M. Holger whose contributions have heavily
influenced these C API enhancements. His several suggestions,
pull requests, questions, and critical reading of documentation
and comments have resulted in significant usability improvements
to the C API.</p></li>
<li><p>Overhaul error handling for the object handle functions C API.
Some rare error conditions that would previously have caused a
crash are now trapped and reported, and the functions that
generate them return fallback values. See comments in the
<code class="docutils literal notranslate"><span class="pre">ERROR</span> <span class="pre">HANDLING</span></code> section of <code class="file docutils literal notranslate"><span class="pre">include/qpdf/qpdf-c.h</span></code> for
details. In particular, exceptions thrown by the underlying C++
code when calling object accessors are caught and converted into
errors. The errors can be checked by calling <code class="docutils literal notranslate"><span class="pre">qpdf_has_error</span></code>.
Use <code class="docutils literal notranslate"><span class="pre">qpdf_silence_errors</span></code> to prevent the error from being
written to stderr.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_get_last_string_length</span></code> to the C API to get the
length of the last string that was returned. This is needed to
handle strings that contain embedded null characters.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_oh_is_initialized</span></code> and
<code class="docutils literal notranslate"><span class="pre">qpdf_oh_new_uninitialized</span></code> to the C API to make it possible
to work with uninitialized objects.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_oh_new_object</span></code> to the C API. This allows you to
clone an object handle.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_get_object_by_id</span></code>, <code class="docutils literal notranslate"><span class="pre">qpdf_make_indirect_object</span></code>,
and <code class="docutils literal notranslate"><span class="pre">qpdf_replace_object</span></code>, exposing the corresponding methods
in <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> and <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>.</p></li>
<li><p>Add several functions for working with pages. See <code class="docutils literal notranslate"><span class="pre">PAGE</span>
<span class="pre">FUNCTIONS</span></code> in <code class="docutils literal notranslate"><span class="pre">include/qpdf/qpdf-c.h</span></code> for details.</p></li>
<li><p>Add several functions for working with streams. See <code class="docutils literal notranslate"><span class="pre">STREAM</span>
<span class="pre">FUNCTIONS</span></code> in <code class="docutils literal notranslate"><span class="pre">include/qpdf/qpdf-c.h</span></code> for details.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_oh_get_type_code</span></code> and <code class="docutils literal notranslate"><span class="pre">qpdf_oh_get_type_name</span></code>.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_oh_get_binary_string_value</span></code> and
<code class="docutils literal notranslate"><span class="pre">qpdf_oh_new_binary_string</span></code> for making it easier to deal with
strings that contain embedded null characters.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.4.0: November 16, 2021</dt><dd><ul class="simple">
<li><p>Handling of Weak Cryptography Algorithms</p>
<ul>
<li><p>From the qpdf CLI, the
<code class="samp docutils literal notranslate"><span class="pre">--allow-weak-crypto</span></code> is now required to
suppress a warning when explicitly creating PDF files using RC4
encryption. While qpdf will always retain the ability to read
and write such files, doing so will require explicit
acknowledgment moving forward. For qpdf 10.4, this change only
affects the command-line tool. Starting in qpdf 11, there will
be small API changes to require explicit acknowledgment in
those cases as well. For additional information, see <a class="reference internal" href="index.html#weak-crypto"><span class="std std-ref">Weak Cryptography</span></a>.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>Fix potential bounds error when handling shell completion that
could occur when given bogus input.</p></li>
<li><p>Properly handle overlay/underlay on completely empty pages
(with no resource dictionary).</p></li>
<li><p>Fix crash that could occur under certain conditions when using
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> with files that had form
fields.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Make <code class="docutils literal notranslate"><span class="pre">QPDF::findPage</span></code> functions public.</p></li>
<li><p>Add methods to <code class="docutils literal notranslate"><span class="pre">Pl_Flate</span></code> to be able to receive warnings on
certain recoverable conditions.</p></li>
<li><p>Add an extra check to the library to detect when foreign
objects are inserted directly (instead of using
<code class="docutils literal notranslate"><span class="pre">QPDF::copyForeignObject</span></code>) at the time of insertion rather
than when the file is written. Catching the error sooner makes
it much easier to locate the incorrect code.</p></li>
</ul>
</li>
<li><p>CLI Enhancements</p>
<ul>
<li><p>Improve diagnostics around parsing
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> command-line options</p></li>
</ul>
</li>
<li><p>Packaging Changes</p>
<ul>
<li><p>The Windows binary distribution is now built with crypto
provided by OpenSSL 3.0.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.3.2: May 8, 2021</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>When generating a file while preserving object streams,
unreferenced objects are correctly removed unless
<code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced</span></code> is specified.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>When adding a page that already exists, make a shallow copy
instead of throwing an exception. This makes the library
behavior consistent with the CLI behavior. See
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> for additional notes.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.3.1: March 11, 2021</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>Form field copying failed on files where /DR was a direct
object in the document-level form dictionary.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.3.0: March 4, 2021</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>The code for handling form fields when copying pages from
10.2.0 was not quite right and didn’t work in a number of
situations, such as when the same page was copied multiple
times or when there were conflicting resource or field names
across multiple copies. The 10.3.0 code has been much more
thoroughly tested with more complex cases and with a multitude
of readers and should be much closer to correct. The 10.2.0
code worked well enough for page splitting or for copying pages
with form fields into documents that didn’t already have them
but was still not quite correct in handling of field-level
resources.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">QPDF::replaceObject</span></code> or <code class="docutils literal notranslate"><span class="pre">QPDF::swapObjects</span></code> is
called, existing <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> instances no longer point
to the old objects. The next time they are accessed, they
automatically notice the change to the underlying object and
update themselves. This resolves a very longstanding source of
confusion, albeit in a very rarely used method call.</p></li>
<li><p>Fix form field handling code to look for default appearances,
quadding, and default resources in the right places. The code
was not looking for things in the document-level interactive
form dictionary that it was supposed to be finding there. This
required adding a few new methods to
<code class="docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper</span></code>.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Reworked the code that handles copying annotations and form
fields during page operations. There were additional methods
added to the public API from 10.2.0 and a one deprecation of a
method added in 10.2.0. The majority of the API changes are in
methods most people would never call and that will hopefully be
superseded by higher-level interfaces for handling page copies.
Please see the <code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> file for
details.</p></li>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">QPDF::numWarnings</span></code> was added so that you can tell
whether any warnings happened during a specific block of code.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.2.0: February 23, 2021</dt><dd><ul class="simple">
<li><p>CLI Behavior Changes</p>
<ul>
<li><p>Operations that work on combining pages are much better about
protecting form fields. In particular,
<code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> now preserve interaction form
functionality by copying the relevant form field information
from the original files. Additionally, if you use
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> to select only some pages from
the original input file, unused form fields are removed, which
prevents lots of unused annotations from being retained.</p></li>
<li><p>By default, <strong class="command">qpdf</strong> no longer allows
creation of encrypted PDF files whose user password is
non-empty and owner password is empty when a 256-bit key is in
use. The <code class="samp docutils literal notranslate"><span class="pre">--allow-insecure</span></code> option,
specified inside the <code class="samp docutils literal notranslate"><span class="pre">--encrypt</span></code> options,
allows creation of such files. Behavior changes in the CLI are
avoided when possible, but an exception was made here because
this is security-related. qpdf must always allow creation of
weird files for testing purposes, but it should not default to
letting users unknowingly create insecure files.</p></li>
</ul>
</li>
<li><p>Library Behavior Changes</p>
<ul>
<li><p>Note: the changes in this section cause differences in output
in some cases. These differences change the syntax of the PDF
but do not change the semantics (meaning). I make a strong
effort to avoid gratuitous changes in qpdf’s output so that
qpdf changes don’t break people’s tests. In this case, the
changes significantly improve the readability of the generated
PDF and don’t affect any output that’s generated by simple
transformation. If you are annoyed by having to update test
files, please rest assured that changes like this have been and
will continue to be rare events.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::newUnicodeString</span></code> now uses whichever of
ASCII, PDFDocEncoding, of UTF-16 is sufficient to encode all
the characters in the string. This reduces needless encoding in
UTF-16 of strings that can be encoded in ASCII. This change may
cause qpdf to generate different output than before when form
field values are set using <code class="docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper</span></code> but
does not change the meaning of the output.</p></li>
<li><p>The code that places form XObjects and also the code that
flattens rotations trim trailing zeroes from real numbers that
they calculate. This causes slight (but semantically
equivalent) differences in generated appearance streams and
form XObject invocations in overlay/underlay code or in user
code that calls the methods that place form XObjects on a page.</p></li>
</ul>
</li>
<li><p>CLI Enhancements</p>
<ul>
<li><p>Add new command line options for listing, saving, adding,
removing, and and copying file attachments. See <a class="reference internal" href="index.html#attachments"><span class="std std-ref">Embedded Files/Attachments Options</span></a> for details.</p></li>
<li><p>Page splitting and merging operations, as well as
<code class="samp docutils literal notranslate"><span class="pre">--flatten-rotation</span></code>, are better behaved
with respect to annotations and interactive form fields. In
most cases, interactive form field functionality and proper
formatting and functionality of annotations is preserved by
these operations. There are still some cases that aren’t
perfect, such as when functionality of annotations depends on
document-level data that qpdf doesn’t yet understand or when
there are problems with referential integrity among form fields
and annotations (e.g., when a single form field object or its
associated annotations are shared across multiple pages, a case
that is out of spec but that works in most viewers anyway).</p></li>
<li><p>The option
<code class="samp docutils literal notranslate"><span class="pre">--password-file=</span><em><span class="pre">filename</span></em></code>
can now be used to read the decryption password from a file.
You can use <code class="docutils literal notranslate"><span class="pre">-</span></code> as the file name to read the password from
standard input. This is an easier/more obvious way to read
passwords from files or standard input than using
<code class="samp docutils literal notranslate"><span class="pre">&#64;file</span></code> for this purpose.</p></li>
<li><p>Add some information about attachments to the json output, and
added <code class="docutils literal notranslate"><span class="pre">attachments</span></code> as an additional json key. The
information included here is limited to the preferred name and
content stream and a reference to the file spec object. This is
enough detail for clients to avoid the hassle of navigating a
name tree and provides what is needed for basic enumeration and
extraction of attachments. More detailed information can be
obtained by following the reference to the file spec object.</p></li>
<li><p>Add numeric option to <code class="samp docutils literal notranslate"><span class="pre">--collate</span></code>. If
<code class="samp docutils literal notranslate"><span class="pre">--collate=</span><em><span class="pre">n</span></em></code>
is given, take pages in groups of
<code class="samp docutils literal notranslate"><em><span class="pre">n</span></em></code> from the given files.</p></li>
<li><p>It is now valid to provide <code class="samp docutils literal notranslate"><span class="pre">--rotate=0</span></code>
to clear rotation from a page.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>This release includes numerous additions to the API. Not all
changes are listed here. Please see the
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> file in the source
distribution for a comprehensive list. Highlights appear below.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::ditems()</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::aitems()</span></code> that enable C++-style iteration,
including range-for iteration, over dictionary and array
QPDFObjectHandles. See comments in
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDFObjectHandle.hh</span></code>
and
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-name-number-tree.cc</span></code>
for details.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::copyStream</span></code> for making a copy of a
stream within the same <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> instance.</p></li>
<li><p>Add new helper classes for supporting file attachments, also
known as embedded files. New classes are
<code class="docutils literal notranslate"><span class="pre">QPDFEmbeddedFileDocumentHelper</span></code>,
<code class="docutils literal notranslate"><span class="pre">QPDFFileSpecObjectHelper</span></code>, and <code class="docutils literal notranslate"><span class="pre">QPDFEFStreamObjectHelper</span></code>.
See their respective headers for details and
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-attach-file.cc</span></code> for an
example.</p></li>
<li><p>Add a version of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::parse</span></code> that takes a
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> pointer as context so that it can parse strings
containing indirect object references. This is illustrated in
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-attach-file.cc</span></code>.</p></li>
<li><p>Re-implement <code class="docutils literal notranslate"><span class="pre">QPDFNameTreeObjectHelper</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFNumberTreeObjectHelper</span></code> to be more efficient, add an
iterator-based API, give them the capability to repair broken
trees, and create methods for modifying the trees. With this
change, qpdf has a robust read/write implementation of name and
number trees.</p></li>
<li><p>Add new versions of <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::replaceStreamData</span></code>
that take <code class="docutils literal notranslate"><span class="pre">std::function</span></code> objects for cases when you need
something between a static string and a full-fledged
StreamDataProvider. Using this with <code class="docutils literal notranslate"><span class="pre">QUtil::file_provider</span></code> is
a very easy way to create a stream from the contents of a file.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDFMatrix</span></code> class, formerly a private, internal class,
has been added to the public API. See
<code class="file docutils literal notranslate"><span class="pre">include/qpdf/QPDFMatrix.hh</span></code> for
details. This class is for working with transformation
matrices. Some methods in <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code> make use of
this to make information about transformation matrices
available. For an example, see
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-overlay-page.cc</span></code>.</p></li>
<li><p>Several new methods were added to
<code class="docutils literal notranslate"><span class="pre">QPDFAcroFormDocumentHelper</span></code> for adding, removing, getting
information about, and enumerating form fields.</p></li>
<li><p>Add method
<code class="docutils literal notranslate"><span class="pre">QPDFAcroFormDocumentHelper::transformAnnotations</span></code>, which
applies a transformation to each annotation on a page.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::copyAnnotations</span></code>, which copies
annotations and, if applicable, associated form fields, from
one page to another, possibly transforming the rectangles.</p></li>
</ul>
</li>
<li><p>Build Changes</p>
<ul>
<li><p>A C++-14 compiler is now required to build qpdf. There is no
intention to require anything newer than that for a while.
C++-14 includes modest enhancements to C++-11 and appears to be
supported about as widely as C++-11.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--flatten-rotation</span></code> option applies
transformations to any annotations that may be on the page.</p></li>
<li><p>If a form XObject lacks a resources dictionary, consider any
names in that form XObject to be referenced from the containing
page. This is compliant with older PDF versions. Also detect if
any form XObjects have any unresolved names and, if so, don’t
remove unreferenced resources from them or from the page that
contains them. Unfortunately this has the side effect of
preventing removal of unreferenced resources in some cases
where names appear that don’t refer to resources, such as with
tagged PDF. This is a bit of a corner case that is not likely
to cause a significant problem in practice, but the only side
effect would be lack of removal of shared resources. A future
version of qpdf may be more sophisticated in its detection of
names that refer to resources.</p></li>
<li><p>Properly handle strings if they appear in inline image
dictionaries while externalizing inline images.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.1.0: January 5, 2021</dt><dd><ul class="simple">
<li><p>CLI Enhancements</p>
<ul>
<li><p>Add <code class="samp docutils literal notranslate"><span class="pre">--flatten-rotation</span></code> command-line
option, which causes all pages that are rotated using
parameters in the page’s dictionary to instead be identically
rotated in the page’s contents. The change is not user-visible
for compliant PDF readers but can be used to work around broken
PDF applications that don’t properly handle page rotation.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Support for user-provided (pluggable, modular) stream filters.
It is now possible to derive a class from <code class="docutils literal notranslate"><span class="pre">QPDFStreamFilter</span></code>
and register it with <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> so that regular library methods,
including those used by <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>, can decode streams with
filters not directly supported by the library. The example
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-custom-filter.cc</span></code>
illustrates how to use this capability.</p></li>
<li><p>Add methods to <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code> to iterate through
XObjects on a page or form XObjects, possibly recursing into
nested form XObjects: <code class="docutils literal notranslate"><span class="pre">forEachXObject</span></code>, <code class="docutils literal notranslate"><span class="pre">ForEachImage</span></code>,
<code class="docutils literal notranslate"><span class="pre">forEachFormXObject</span></code>.</p></li>
<li><p>Enhance several methods in <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code> to work
with form XObjects as well as pages, as noted in comments. See
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> for a full list.</p></li>
<li><p>Rename some functions in <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code>, while
keeping old names for compatibility:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">getPageImages</span></code> to <code class="docutils literal notranslate"><span class="pre">getImages</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filterPageContents</span></code> to <code class="docutils literal notranslate"><span class="pre">filterContents</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pipePageContents</span></code> to <code class="docutils literal notranslate"><span class="pre">pipeContents</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parsePageContents</span></code> to <code class="docutils literal notranslate"><span class="pre">parseContents</span></code></p></li>
</ul>
</li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::getFormXObjects</span></code> to return
a map of form XObjects directly on a page or form XObject</p></li>
<li><p>Add new helper methods to <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>:
<code class="docutils literal notranslate"><span class="pre">isFormXObject</span></code>, <code class="docutils literal notranslate"><span class="pre">isImage</span></code></p></li>
<li><p>Add the optional <code class="docutils literal notranslate"><span class="pre">allow_streams</span></code> parameter
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::makeDirect</span></code>. When
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::makeDirect</span></code> is called in this way, it
preserves references to streams rather than throwing an
exception.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::setFilterOnWrite</span></code> method. Calling this
on a stream prevents <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> from attempting to
uncompress, recompress, or otherwise filter a stream even if it
could. Developers can use this to protect streams that are
optimized should be protected from <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>’s default
behavior for any other reason.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ostream</span></code> <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> operator for <code class="docutils literal notranslate"><span class="pre">QPDFObjGen</span></code>. This is
useful to have for debugging.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::flattenRotation</span></code>, which
replaces a page’s <code class="docutils literal notranslate"><span class="pre">/Rotate</span></code> keyword by rotating the page
within the content stream and altering the page’s bounding
boxes so the rendering is the same. This can be used to work
around buggy PDF readers that can’t properly handle page
rotation.</p></li>
</ul>
</li>
<li><p>C API Enhancements</p>
<ul>
<li><p>Add several new functions to the C API for working with
objects. These are wrappers around many of the methods in
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. Their inclusion adds considerable new
capability to the C API.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">qpdf_register_progress_reporter</span></code> to the C API,
corresponding to <code class="docutils literal notranslate"><span class="pre">QPDFWriter::registerProgressReporter</span></code>.</p></li>
</ul>
</li>
<li><p>Performance Enhancements</p>
<ul>
<li><p>Improve steps <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> takes to prepare a <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object
for writing, resulting in about an 8% improvement in write
performance while allowing indirect objects to appear in
<code class="docutils literal notranslate"><span class="pre">/DecodeParms</span></code>.</p></li>
<li><p>When extracting pages, the <strong class="command">qpdf</strong> CLI
only removes unreferenced resources from the pages that are
being kept, resulting in a significant performance improvement
when extracting small numbers of pages from large, complex
documents.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::externalizeInlineImages</span></code> was not
externalizing images referenced from form XObjects that
appeared on the page.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::filterPageContents</span></code> was broken for pages
with multiple content streams.</p></li>
<li><p>Tweak zsh completion code to behave a little better with
respect to path completion.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.0.4: November 21, 2020</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>Fix a handful of integer overflows. This includes cases found
by fuzzing as well as having qpdf not do range checking on
unused values in the xref stream.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.0.3: October 31, 2020</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>The fix to the bug involving copying streams with indirect
filters was incorrect and introduced a new, more serious bug.
The original bug has been fixed correctly, as has the bug
introduced in 10.0.2.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.0.2: October 27, 2020</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>When concatenating content streams, as with
<code class="samp docutils literal notranslate"><span class="pre">--coalesce-contents</span></code>, there were cases
in which qpdf would merge two lexical tokens together, creating
invalid results. A newline is now inserted between merged
content streams if one is not already present.</p></li>
<li><p>Fix an internal error that could occur when copying foreign
streams whose stream data had been replaced using a stream data
provider if those streams had indirect filters or decode
parameters. This is a rare corner case.</p></li>
<li><p>Ensure that the caller’s locale settings do not change the
results of numeric conversions performed internally by the qpdf
library. Note that the problem here could only be caused when
the qpdf library was used programmatically. Using the qpdf CLI
already ignored the user’s locale for numeric conversion.</p></li>
<li><p>Fix several instances in which warnings were not suppressed in
spite of <code class="samp docutils literal notranslate"><span class="pre">--no-warn</span></code> and/or errors or
warnings were written to standard output rather than standard
error.</p></li>
<li><p>Fixed a memory leak that could occur under specific
circumstances when
<code class="samp docutils literal notranslate"><span class="pre">--object-streams=generate</span></code> was used.</p></li>
<li><p>Fix various integer overflows and similar conditions found by
the OSS-Fuzz project.</p></li>
</ul>
</li>
<li><p>Enhancements</p>
<ul>
<li><p>New option <code class="samp docutils literal notranslate"><span class="pre">--warning-exit-0</span></code> causes qpdf
to exit with a status of <code class="docutils literal notranslate"><span class="pre">0</span></code> rather than <code class="docutils literal notranslate"><span class="pre">3</span></code> if there are
warnings but no errors. Combine with
<code class="samp docutils literal notranslate"><span class="pre">--no-warn</span></code> to completely ignore
warnings.</p></li>
<li><p>Performance improvements have been made to
<code class="docutils literal notranslate"><span class="pre">QPDF::processMemoryFile</span></code>.</p></li>
<li><p>The OpenSSL crypto provider produces more detailed error
messages.</p></li>
</ul>
</li>
<li><p>Build Changes</p>
<ul>
<li><p>The option <code class="samp docutils literal notranslate"><span class="pre">--disable-rpath</span></code> is now
supported by qpdf’s <strong class="command">./configure</strong>
script. Some distributions’ packaging standards recommended the
use of this option.</p></li>
<li><p>Selection of a printf format string for <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">long</span></code> has
been moved from <code class="docutils literal notranslate"><span class="pre">ifdefs</span></code> to an autoconf
test. If you are using your own build system, you will need to
provide a value for <code class="docutils literal notranslate"><span class="pre">LL_FMT</span></code> in
<code class="file docutils literal notranslate"><span class="pre">libqpdf/qpdf/qpdf-config.h</span></code>, which
would typically be <code class="docutils literal notranslate"><span class="pre">&quot;%lld&quot;</span></code> or, for some Windows compilers,
<code class="docutils literal notranslate"><span class="pre">&quot;%I64d&quot;</span></code>.</p></li>
<li><p>Several improvements were made to build-time configuration of
the OpenSSL crypto provider.</p></li>
<li><p>A nearly stand-alone Linux binary zip file is now included with
the qpdf release. This is built on an older (but supported)
Ubuntu LTS release, but would work on most reasonably recent
Linux distributions. It contains only the executables and
required shared libraries that would not be present on a
minimal system. It can be used for including qpdf in a minimal
environment, such as a docker container. The zip file is also
known to work as a layer in AWS Lambda.</p></li>
<li><p>QPDF’s automated build has been migrated from Azure Pipelines
to GitHub Actions.</p></li>
</ul>
</li>
<li><p>Windows-specific Changes</p>
<ul>
<li><p>The Windows executables distributed with qpdf releases now use
the OpenSSL crypto provider by default. The native crypto
provider is also compiled in and can be selected at runtime
with the <code class="docutils literal notranslate"><span class="pre">QPDF_CRYPTO_PROVIDER</span></code> environment variable.</p></li>
<li><p>Improvements have been made to how a cryptographic provider is
obtained in the native Windows crypto implementation. However
mostly this is shadowed by OpenSSL being used by default.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.0.1: April 9, 2020</dt><dd><ul class="simple">
<li><p>Bug Fixes</p>
<ul>
<li><p>10.0.0 introduced a bug in which calling
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getStreamData</span></code> on a stream that can’t be
filtered was returning the raw data instead of throwing an
exception. This is now fixed.</p></li>
<li><p>Fix a bug that was preventing qpdf from linking with some
versions of clang on some platforms.</p></li>
</ul>
</li>
<li><p>Enhancements</p>
<ul>
<li><p>Improve the <code class="file docutils literal notranslate"><span class="pre">pdf-invert-images</span></code>
example to avoid having to load all the images into RAM at the
same time.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>10.0.0: April 6, 2020</dt><dd><ul class="simple">
<li><p>Performance Enhancements</p>
<ul>
<li><p>The qpdf library and executable should run much faster in this
version than in the last several releases. Several internal
library optimizations have been made, and there has been
improved behavior on page splitting as well. This version of
qpdf should outperform any of the 8.x or 9.x versions.</p></li>
</ul>
</li>
<li><p>Incompatible API (source-level) Changes (minor)</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QUtil::srandom</span></code> method was removed. It didn’t do
anything unless insecure random numbers were compiled in, and
they have been off by default for a long time. If you were
calling it, just remove the call since it wasn’t doing anything
anyway.</p></li>
</ul>
</li>
<li><p>Build/Packaging Changes</p>
<ul>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">openssl</span></code> crypto provider, which is implemented with
OpenSSL and also works with BoringSSL. Thanks to Dean Scarff
for this contribution. If you maintain qpdf for a distribution,
pay special attention to make sure that you are including
support for the crypto providers you want. Package maintainers
will have to weigh the advantages of allowing users to pick a
crypto provider at runtime against the disadvantages of adding
more dependencies to qpdf.</p></li>
<li><p>Allow qpdf to built on stripped down systems whose C/C++
libraries lack the <code class="docutils literal notranslate"><span class="pre">wchar_t</span></code> type. Search for <code class="docutils literal notranslate"><span class="pre">wchar_t</span></code> in
qpdf’s README.md for details. This should be very rare, but it
is known to be helpful in some embedded environments.</p></li>
</ul>
</li>
<li><p>CLI Enhancements</p>
<ul>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">objectinfo</span></code> key to the JSON output. This will be a place
to put computed metadata or other information about PDF objects
that are not immediately evident in other ways or that seem
useful for some other reason. In this version, information is
provided about each object indicating whether it is a stream
and, if so, what its length and filters are. Without this, it
was not possible to tell conclusively from the JSON output
alone whether or not an object was a stream. Run
<strong class="command">qpdf --json-help</strong> for details.</p></li>
<li><p>Add new option
<code class="samp docutils literal notranslate"><span class="pre">--remove-unreferenced-resources</span></code> which
takes <code class="docutils literal notranslate"><span class="pre">auto</span></code>, <code class="docutils literal notranslate"><span class="pre">yes</span></code>, or <code class="docutils literal notranslate"><span class="pre">no</span></code> as arguments. The new
<code class="docutils literal notranslate"><span class="pre">auto</span></code> mode, which is the default, performs a fast heuristic
over a PDF file when splitting pages to determine whether the
expensive process of finding and removing unreferenced
resources is likely to be of benefit. For most files, this new
default will result in a significant performance improvement
for splitting pages. See <a class="reference internal" href="index.html#advanced-transformation"><span class="std std-ref">Advanced Transformation Options</span></a> for a more detailed
discussion.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced-resources</span></code>
is now just a synonym for
<code class="samp docutils literal notranslate"><span class="pre">--remove-unreferenced-resources=no</span></code>.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">QPDF_EXECUTABLE</span></code> environment variable is set when
invoking <strong class="command">qpdf --bash-completion</strong> or
<strong class="command">qpdf --zsh-completion</strong>, the completion
command that it outputs will refer to qpdf using the value of
that variable rather than what <strong class="command">qpdf</strong>
determines its executable path to be. This can be useful when
wrapping <strong class="command">qpdf</strong> with a script, working
with a version in the source tree, using an AppImage, or other
situations where there is some indirection.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Random number generation is now delegated to the crypto
provider. The old behavior is still used by the native crypto
provider. It is still possible to provide your own random
number generator.</p></li>
<li><p>Add a new version of
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::StreamDataProvider::provideStreamData</span></code>
that accepts the <code class="docutils literal notranslate"><span class="pre">suppress_warnings</span></code> and <code class="docutils literal notranslate"><span class="pre">will_retry</span></code>
options and allows a success code to be returned. This makes it
possible to implement a <code class="docutils literal notranslate"><span class="pre">StreamDataProvider</span></code> that calls
<code class="docutils literal notranslate"><span class="pre">pipeStreamData</span></code> on another stream and to pass the response
back to the caller, which enables better error handling on
those proxied streams.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::pipeStreamData</span></code> to return an
overall success code that goes beyond whether or not filtered
data was written successfully. This allows better error
handling of cases that were not filtering errors. You have to
call this explicitly. Methods in previously existing APIs have
the same semantics as before.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::placeFormXObject</span></code> method now
allows separate control over whether it should be willing to
shrink or expand objects to fit them better into the
destination rectangle. The previous behavior was that shrinking
was allowed but expansion was not. The previous behavior is
still the default.</p></li>
<li><p>When calling the C API, any non-zero value passed to a boolean
parameter is treated as <code class="docutils literal notranslate"><span class="pre">TRUE</span></code>. Previously only the value
<code class="docutils literal notranslate"><span class="pre">1</span></code> was accepted. This makes the C API behave more like most
C interfaces and is known to improve compatibility with some
Windows environments that dynamically load the DLL and call
functions from it.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::unsafeShallowCopy</span></code> for copying only
top-level dictionary keys or array items. This is unsafe
because it creates a situation in which changing a lower-level
item in one object may also change it in another object, but
for cases in which you <em>know</em> you are only inserting or
replacing top-level items, it is much faster than
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::shallowCopy</span></code>.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::filterAsContents</span></code>, which filter’s a
stream’s data as a content stream. This is useful for parsing
the contents for form XObjects in the same way as parsing page
content streams.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>When detecting and removing unreferenced resources during page
splitting, traverse into form XObjects and handle their
resources dictionaries as well.</p></li>
<li><p>The same error recovery is applied to streams in other than the
primary input file when merging or splitting pages.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>9.1.1: January 26, 2020</dt><dd><ul class="simple">
<li><p>Build/Packaging Changes</p>
<ul>
<li><p>The fix-qdf program was converted from perl to C++. As such,
qpdf no longer has a runtime dependency on perl.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Added new helper routine <code class="docutils literal notranslate"><span class="pre">QUtil::call_main_from_wmain</span></code> which
converts <code class="docutils literal notranslate"><span class="pre">wchar_t</span></code> arguments to UTF-8 encoded strings. This
is useful for qpdf because library methods expect file names to
be UTF-8 encoded, even on Windows</p></li>
<li><p>Added new <code class="docutils literal notranslate"><span class="pre">QUtil::read_lines_from_file</span></code> methods that take
<code class="docutils literal notranslate"><span class="pre">FILE*</span></code> arguments and that allow preservation of end-of-line
characters. This also fixes a bug where
<code class="docutils literal notranslate"><span class="pre">QUtil::read_lines_from_file</span></code> wouldn’t work properly with
Unicode filenames.</p></li>
</ul>
</li>
<li><p>CLI Enhancements</p>
<ul>
<li><p>Added options <code class="samp docutils literal notranslate"><span class="pre">--is-encrypted</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--requires-password</span></code> for testing whether
a file is encrypted or requires a password other than the
supplied (or empty) password. These communicate via exit
status, making them useful for shell scripts. They also work on
encrypted files with unknown passwords.</p></li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> key to JSON options. With the exception of
the reconstructed user password for older encryption formats,
this provides the same information as
<code class="samp docutils literal notranslate"><span class="pre">--show-encryption</span></code> but in a consistent,
parseable format. See output of <strong class="command">qpdf
--json-help</strong> for details.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>In QDF mode, be sure not to write more than one XRef stream to
a file, even when
<code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced</span></code> is used.
<strong class="command">fix-qdf</strong> assumes that there is only
one XRef stream, and that it appears at the end of the file.</p></li>
<li><p>When externalizing inline images, properly handle images whose
color space is a reference to an object in the page’s resource
dictionary.</p></li>
<li><p>Windows-specific fix for acquiring crypt context with a new
keyset.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>9.1.0: November 17, 2019</dt><dd><ul class="simple">
<li><p>Build Changes</p>
<ul>
<li><p>A C++-11 compiler is now required to build qpdf.</p></li>
<li><p>A new crypto provider that uses gnutls for crypto functions is
now available and can be enabled at build time. See <a class="reference internal" href="index.html#crypto"><span class="std std-ref">Crypto Providers</span></a> for more information about crypto
providers and <a class="reference internal" href="index.html#crypto-build"><span class="std std-ref">Build Support For Crypto Providers</span></a> for specific information about
the build.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Incorporate contribution from Masamichi Hosoda to properly
handle signature dictionaries by not including them in object
streams, formatting the <code class="docutils literal notranslate"><span class="pre">Contents</span></code> key has a hexadecimal
string, and excluding the <code class="docutils literal notranslate"><span class="pre">/Contents</span></code> key from encryption and
decryption.</p></li>
<li><p>Incorporate contribution from Masamichi Hosoda to provide new
API calls for getting file-level information about input and
output files, enabling certain operations on the files at the
file level rather than the object level. New methods include
<code class="docutils literal notranslate"><span class="pre">QPDF::getXRefTable()</span></code>,
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getParsedOffset()</span></code>,
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::getRenumberedObjGen(QPDFObjGen)</span></code>, and
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::getWrittenXRefTable()</span></code>.</p></li>
<li><p>Support build-time and runtime selectable crypto providers.
This includes the addition of new classes
<code class="docutils literal notranslate"><span class="pre">QPDFCryptoProvider</span></code> and <code class="docutils literal notranslate"><span class="pre">QPDFCryptoImpl</span></code> and the
recognition of the <code class="docutils literal notranslate"><span class="pre">QPDF_CRYPTO_PROVIDER</span></code> environment
variable. Crypto providers are described in depth in <a class="reference internal" href="index.html#crypto"><span class="std std-ref">Crypto Providers</span></a>.</p></li>
</ul>
</li>
<li><p>CLI Enhancements</p>
<ul>
<li><p>Addition of the <code class="samp docutils literal notranslate"><span class="pre">--show-crypto</span></code> option in
support of selectable crypto providers, as described in <a class="reference internal" href="index.html#crypto"><span class="std std-ref">Crypto Providers</span></a>.</p></li>
<li><p>Allow <code class="docutils literal notranslate"><span class="pre">:even</span></code> or <code class="docutils literal notranslate"><span class="pre">:odd</span></code> to be appended to numeric ranges
for specification of the even or odd pages from among the pages
specified in the range.</p></li>
<li><p>Fix shell wildcard expansion behavior (<code class="docutils literal notranslate"><span class="pre">*</span></code> and <code class="docutils literal notranslate"><span class="pre">?</span></code>) of the
<strong class="command">qpdf.exe</strong> as built my MSVC.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>9.0.2: October 12, 2019</dt><dd><ul class="simple">
<li><p>Bug Fix</p>
<ul>
<li><p>Fix the name of the temporary file used by
<code class="samp docutils literal notranslate"><span class="pre">--replace-input</span></code> so that it doesn’t
require path splitting and works with paths include
directories.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>9.0.1: September 20, 2019</dt><dd><ul class="simple">
<li><p>Bug Fixes/Enhancements</p>
<ul>
<li><p>Fix some build and test issues on big-endian systems and
compilers with characters that are unsigned by default. The
problems were in build and test only. There were no actual bugs
in the qpdf library itself relating to endianness or unsigned
characters.</p></li>
<li><p>When a dictionary has a duplicated key, report this with a
warning. The behavior of the library in this case is unchanged,
but the error condition is no longer silently ignored.</p></li>
<li><p>When a form field’s display rectangle is erroneously specified
with inverted coordinates, detect and correct this situation.
This avoids some form fields from being flipped when flattening
annotations on files with this condition.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>9.0.0: August 31, 2019</dt><dd><ul class="simple">
<li><p>Incompatible API (source-level) Changes (minor)</p>
<ul>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">QUtil::strcasecmp</span></code> has been renamed to
<code class="docutils literal notranslate"><span class="pre">QUtil::str_compare_nocase</span></code>. This incompatible change is
necessary to enable qpdf to build on platforms that define
<code class="docutils literal notranslate"><span class="pre">strcasecmp</span></code> as a macro.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDF::copyForeignObject</span></code> method had an overloaded
version that took a boolean parameter that was not used. If you
were using this version, just omit the extra parameter.</p></li>
<li><p>There was a version <code class="docutils literal notranslate"><span class="pre">QPDFTokenizer::expectInlineImage</span></code> that
took no arguments. This version has been removed since it
caused the tokenizer to return incorrect inline images. A new
version was added some time ago that produces correct output.
This is a very low level method that doesn’t make sense to call
outside of qpdf’s lexical engine. There are higher level
methods for tokenizing content streams.</p></li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">QPDFOutlineDocumentHelper::getTopLevelOutlines</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFOutlineObjectHelper::getKids</span></code> to return a
<code class="docutils literal notranslate"><span class="pre">std::vector</span></code> instead of a <code class="docutils literal notranslate"><span class="pre">std::list</span></code> of
<code class="docutils literal notranslate"><span class="pre">QPDFOutlineObjectHelper</span></code> objects.</p></li>
<li><p>Remove method <code class="docutils literal notranslate"><span class="pre">QPDFTokenizer::allowPoundAnywhereInName</span></code>. This
function would allow creation of name tokens whose value would
change when unparsed, which is never the correct behavior.</p></li>
</ul>
</li>
<li><p>CLI Enhancements</p>
<ul>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--replace-input</span></code> option may be given
in place of an output file name. This causes qpdf to overwrite
the input file with the output. See the description of
<code class="samp docutils literal notranslate"><span class="pre">--replace-input</span></code> in <a class="reference internal" href="index.html#basic-options"><span class="std std-ref">Basic Options</span></a> for more details.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--recompress-flate</span></code> instructs
<strong class="command">qpdf</strong> to recompress streams that are
already compressed with <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code>. Useful with
<code class="samp docutils literal notranslate"><span class="pre">--compression-level</span></code>.</p></li>
<li><p>The
<code class="samp docutils literal notranslate"><span class="pre">--compression-level=</span><em><span class="pre">level</span></em></code>
sets the zlib compression level used for any streams compressed
by <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code>. Most effective when combined with
<code class="samp docutils literal notranslate"><span class="pre">--recompress-flate</span></code>.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>A new namespace <code class="docutils literal notranslate"><span class="pre">QIntC</span></code>, provided by
<code class="file docutils literal notranslate"><span class="pre">qpdf/QIntC.hh</span></code>, provides safe
conversion methods between different integer types. These
conversion methods do range checking to ensure that the cast
can be performed with no loss of information. Every use of
<code class="docutils literal notranslate"><span class="pre">static_cast</span></code> in the library was inspected to see if it could
use one of these safe converters instead. See <a class="reference internal" href="index.html#casting"><span class="std std-ref">Casting Policy</span></a> for additional details.</p></li>
<li><p>Method <code class="docutils literal notranslate"><span class="pre">QPDF::anyWarnings</span></code> tells whether there have been any
warnings without clearing the list of warnings.</p></li>
<li><p>Method <code class="docutils literal notranslate"><span class="pre">QPDF::closeInputSource</span></code> closes or otherwise releases
the input source. This enables the input file to be deleted or
renamed.</p></li>
<li><p>New methods have been added to <code class="docutils literal notranslate"><span class="pre">QUtil</span></code> for converting back
and forth between strings and unsigned integers:
<code class="docutils literal notranslate"><span class="pre">uint_to_string</span></code>, <code class="docutils literal notranslate"><span class="pre">uint_to_string_base</span></code>,
<code class="docutils literal notranslate"><span class="pre">string_to_uint</span></code>, and <code class="docutils literal notranslate"><span class="pre">string_to_ull</span></code>.</p></li>
<li><p>New methods have been added to <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> that return
the value of <code class="docutils literal notranslate"><span class="pre">Integer</span></code> objects as <code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span></code>
with range checking and sensible fallback values, and a new
method was added to return an unsigned value. This makes it
easier to write code that is safe from unintentional data loss.
Functions: <code class="docutils literal notranslate"><span class="pre">getUIntValue</span></code>, <code class="docutils literal notranslate"><span class="pre">getIntValueAsInt</span></code>,
<code class="docutils literal notranslate"><span class="pre">getUIntValueAsUInt</span></code>.</p></li>
<li><p>When parsing content streams with
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::ParserCallbacks</span></code>, in place of the method
<code class="docutils literal notranslate"><span class="pre">handleObject(QPDFObjectHandle)</span></code>, the developer may override
<code class="docutils literal notranslate"><span class="pre">handleObject(QPDFObjectHandle,</span> <span class="pre">size_t</span> <span class="pre">offset,</span> <span class="pre">size_t</span>
<span class="pre">length)</span></code>. If this method is defined, it will
be invoked with the object along with its offset and length
within the overall contents being parsed. Intervening spaces
and comments are not included in offset and length.
Additionally, a new method <code class="docutils literal notranslate"><span class="pre">contentSize(size_t)</span></code> may be
implemented. If present, it will be called prior to the first
call to <code class="docutils literal notranslate"><span class="pre">handleObject</span></code> with the total size in bytes of the
combined contents.</p></li>
<li><p>New methods <code class="docutils literal notranslate"><span class="pre">QPDF::userPasswordMatched</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDF::ownerPasswordMatched</span></code> have been added to enable a
caller to determine whether the supplied password was the user
password, the owner password, or both. This information is also
displayed by <strong class="command">qpdf --show-encryption</strong>
and <strong class="command">qpdf --check</strong>.</p></li>
<li><p>Static method <code class="docutils literal notranslate"><span class="pre">Pl_Flate::setCompressionLevel</span></code> can be called
to set the zlib compression level globally used by all
instances of Pl_Flate in deflate mode.</p></li>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setRecompressFlate</span></code> can be called to
tell <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> to uncompress and recompress streams
already compressed with <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code>.</p></li>
<li><p>The underlying implementation of QPDF arrays has been enhanced
to be much more memory efficient when dealing with arrays with
lots of nulls. This enables qpdf to use drastically less memory
for certain types of files.</p></li>
<li><p>When traversing the pages tree, if nodes are encountered with
invalid types, the types are fixed, and a warning is issued.</p></li>
<li><p>A new helper method <code class="docutils literal notranslate"><span class="pre">QUtil::read_file_into_memory</span></code> was added.</p></li>
<li><p>All conditions previously reported by
<code class="docutils literal notranslate"><span class="pre">QPDF::checkLinearization()</span></code> as errors are now presented as
warnings.</p></li>
<li><p>Name tokens containing the <code class="docutils literal notranslate"><span class="pre">#</span></code> character not preceded by two
hexadecimal digits, which is invalid in PDF 1.2 and above, are
properly handled by the library: a warning is generated, and
the name token is properly preserved, even if invalid, in the
output. See <code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> for a more
complete description of this change.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>A small handful of memory issues, assertion failures, and
unhandled exceptions that could occur on badly mangled input
files have been fixed. Most of these problems were found by
Google’s OSS-Fuzz project.</p></li>
<li><p>When <strong class="command">qpdf --check</strong> or
<strong class="command">qpdf --check-linearization</strong> encounters
a file with linearization warnings but not errors, it now
properly exits with exit code 3 instead of 2.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--completion-bash</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--completion-zsh</span></code> options now work
properly when qpdf is invoked as an AppImage.</p></li>
<li><p>Calling <code class="docutils literal notranslate"><span class="pre">QPDFWriter::set*EncryptionParameters</span></code> on a
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> object whose output filename has not yet been
set no longer produces a segmentation fault.</p></li>
<li><p>When reading encrypted files, follow the spec more closely
regarding encryption key length. This allows qpdf to open
encrypted files in most cases when they have invalid or missing
/Length keys in the encryption dictionary.</p></li>
</ul>
</li>
<li><p>Build Changes</p>
<ul>
<li><p>On platforms that support it, qpdf now builds with
<code class="samp docutils literal notranslate"><span class="pre">-fvisibility=hidden</span></code>. If you build qpdf
with your own build system, this is now safe to use. This
prevents methods that are not part of the public API from being
exported by the shared library, and makes qpdf’s ELF shared
libraries (used on Linux, MacOS, and most other UNIX flavors)
behave more like the Windows DLL. Since the DLL already behaves
in much this way, it is unlikely that there are any methods
that were accidentally not exported. However, with ELF shared
libraries, typeinfo for some classes has to be explicitly
exported. If there are problems in dynamically linked code
catching exceptions or subclassing, this could be the reason.
If you see this, please report a bug at
<a class="reference external" href="https://github.com/qpdf/qpdf/issues/">https://github.com/qpdf/qpdf/issues/</a>.</p></li>
<li><p>QPDF is now compiled with integer conversion and sign
conversion warnings enabled. Numerous changes were made to the
library to make this safe.</p></li>
<li><p>QPDF’s <strong class="command">make install</strong> target explicitly
specifies the mode to use when installing files instead of
relying the user’s umask. It was previously doing this for some
files but not others.</p></li>
<li><p>If <strong class="command">pkg-config</strong> is available, use it to
locate <code class="file docutils literal notranslate"><span class="pre">libjpeg</span></code> and
<code class="file docutils literal notranslate"><span class="pre">zlib</span></code> dependencies, falling back on
old behavior if unsuccessful.</p></li>
</ul>
</li>
<li><p>Other Notes</p>
<ul>
<li><p>QPDF has been fully integrated into <a class="reference external" href="https://github.com/google/oss-fuzz">Google’s OSS-Fuzz
project</a>. This project
exercises code with randomly mutated inputs and is great for
discovering hidden security crashes and security issues.
Several bugs found by oss-fuzz have already been fixed in qpdf.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.4.2: May 18, 2019</dt><dd><p>This release has just one change: correction of a buffer overrun in
the Windows code used to open files. Windows users should take this
update. There are no code changes that affect non-Windows releases.</p>
</dd>
<dt>8.4.1: April 27, 2019</dt><dd><ul class="simple">
<li><p>Enhancements</p>
<ul>
<li><p>When <strong class="command">qpdf --version</strong> is run, it will
detect if the qpdf CLI was built with a different version of
qpdf than the library, which may indicate a problem with the
installation.</p></li>
<li><p>New option <code class="samp docutils literal notranslate"><span class="pre">--remove-page-labels</span></code> will
remove page labels before generating output. This used to
happen if you ran <strong class="command">qpdf --empty --pages ..
--</strong>, but the behavior changed in qpdf 8.3.0. This
option enables people who were relying on the old behavior to
get it again.</p></li>
<li><p>New option
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open-threshold=</span><em><span class="pre">count</span></em></code>
can be used to override number of files that qpdf will use to
trigger the behavior of not keeping all files open when merging
files. This may be necessary if your system allows fewer than
the default value of 200 files to be open at the same time.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>Handle Unicode characters in filenames on Windows. The changes
to support Unicode on the CLI in Windows broke Unicode
filenames for Windows.</p></li>
<li><p>Slightly tighten logic that determines whether an object is a
page. This should resolve problems in some rare files where
some non-page objects were passing qpdf’s test for whether
something was a page, thus causing them to be erroneously lost
during page splitting operations.</p></li>
<li><p>Revert change that included preservation of outlines
(bookmarks) in <code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code>. The way
it was implemented in 8.3.0 and 8.4.0 caused a very significant
degradation of performance for splitting certain files. A
future release of qpdf may re-introduce the behavior in a more
performant and also more correct fashion.</p></li>
<li><p>In JSON mode, add missing leading 0 to decimal values between
-1 and 1 even if not present in the input. The JSON
specification requires the leading 0. The PDF specification
does not.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.4.0: February 1, 2019</dt><dd><ul class="simple">
<li><p>Command-line Enhancements</p>
<ul>
<li><p><em>Non-compatible CLI change:</em> The qpdf command-line tool
interprets passwords given at the command-line differently from
previous releases when the passwords contain non-ASCII
characters. In some cases, the behavior differs from previous
releases. For a discussion of the current behavior, please see
<a class="reference internal" href="index.html#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a>. The
incompatibilities are as follows:</p>
<ul>
<li><p>On Windows, qpdf now receives all command-line options as
Unicode strings if it can figure out the appropriate
compile/link options. This is enabled at least for MSVC and
mingw builds. That means that if non-ASCII strings are
passed to the qpdf CLI in Windows, qpdf will now correctly
receive them. In the past, they would have either been
encoded as Windows code page 1252 (also known as “Windows
ANSI” or as something unintelligible. In almost all cases,
qpdf is able to properly interpret Unicode arguments now,
whereas in the past, it would almost never interpret them
properly. The result is that non-ASCII passwords given to
the qpdf CLI on Windows now have a much greater chance of
creating PDF files that can be opened by a variety of
readers. In the past, usually files encrypted from the
Windows CLI using non-ASCII passwords would not be readable
by most viewers. Note that the current version of qpdf is
able to decrypt files that it previously created using the
previously supplied password.</p></li>
<li><p>The PDF specification requires passwords to be encoded as
UTF-8 for 256-bit encryption and with PDF Doc encoding for
40-bit or 128-bit encryption. Older versions of qpdf left it
up to the user to provide passwords with the correct
encoding. The qpdf CLI now detects when a password is given
with UTF-8 encoding and automatically transcodes it to what
the PDF spec requires. While this is almost always the
correct behavior, it is possible to override the behavior if
there is some reason to do so. This is discussed in more
depth in <a class="reference internal" href="index.html#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a>.</p></li>
</ul>
</li>
<li><p>New options
<code class="samp docutils literal notranslate"><span class="pre">--externalize-inline-images</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--ii-min-bytes</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">--keep-inline-images</span></code> control qpdf’s
handling of inline images and possible conversion of them to
regular images. By default,
<code class="samp docutils literal notranslate"><span class="pre">--optimize-images</span></code> now also applies to
inline images. These options are discussed in <a class="reference internal" href="index.html#advanced-transformation"><span class="std std-ref">Advanced Transformation Options</span></a>.</p></li>
<li><p>Add options <code class="samp docutils literal notranslate"><span class="pre">--overlay</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--underlay</span></code> for overlaying or
underlaying pages of other files onto output pages. See
<a class="reference internal" href="index.html#overlay-underlay"><span class="std std-ref">Overlay and Underlay Options</span></a> for
details.</p></li>
<li><p>When opening an encrypted file with a password, if the
specified password doesn’t work and the password contains any
non-ASCII characters, qpdf will try a number of alternative
passwords to try to compensate for possible character encoding
errors. This behavior can be suppressed with the
<code class="samp docutils literal notranslate"><span class="pre">--suppress-password-recovery</span></code> option.
See <a class="reference internal" href="index.html#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a> for a full
discussion.</p></li>
<li><p>Add the <code class="samp docutils literal notranslate"><span class="pre">--password-mode</span></code> option to
fine-tune how qpdf interprets password arguments, especially
when they contain non-ASCII characters. See <a class="reference internal" href="index.html#unicode-passwords"><span class="std std-ref">Unicode Passwords</span></a> for more information.</p></li>
<li><p>In the <code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> option, it is now
possible to copy the same page more than once from the same
file without using the previous workaround of specifying two
different paths to the same file.</p></li>
<li><p>In the <code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> option, allow use of “.”
as a shortcut for the primary input file. That way, you can do
<strong class="command">qpdf in.pdf --pages . 1-2 -- out.pdf</strong>
instead of having to repeat <code class="file docutils literal notranslate"><span class="pre">in.pdf</span></code>
in the command.</p></li>
<li><p>When encrypting with 128-bit and 256-bit encryption, new
encryption options <code class="samp docutils literal notranslate"><span class="pre">--assemble</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--annotate</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--form</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">--modify-other</span></code> allow more fine-grained
granularity in configuring options. Before, the
<code class="samp docutils literal notranslate"><span class="pre">--modify</span></code> option only configured certain
predefined groups of permissions.</p></li>
</ul>
</li>
<li><p>Bug Fixes and Enhancements</p>
<ul>
<li><p><em>Potential data-loss bug:</em> Versions of qpdf between 8.1.0 and
8.3.0 had a bug that could cause page splitting and merging
operations to drop some font or image resources if the PDF
file’s internal structure shared these resource lists across
pages and if some but not all of the pages in the output did
not reference all the fonts and images. Using the
<code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced-resources</span></code>
option would work around the incorrect behavior. This bug was
the result of a typo in the code and a deficiency in the test
suite. The case that triggered the error was known, just not
handled properly. This case is now exercised in qpdf’s test
suite and properly handled.</p></li>
<li><p>When optimizing images, detect and refuse to optimize images
that can’t be converted to JPEG because of bit depth or color
space.</p></li>
<li><p>Linearization and page manipulation APIs now detect and recover
from files that have duplicate Page objects in the pages tree.</p></li>
<li><p>Using older option
<code class="samp docutils literal notranslate"><span class="pre">--stream-data=compress</span></code> with object
streams, object streams and xref streams were not compressed.</p></li>
<li><p>When the tokenizer returns inline image tokens, delimiters
following <code class="docutils literal notranslate"><span class="pre">ID</span></code> and <code class="docutils literal notranslate"><span class="pre">EI</span></code> operators are no longer excluded.
This makes it possible to reliably extract the actual image
data.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::externalizeInlineImages</span></code> to
convert inline images to regular images.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QUtil::possible_repaired_encodings()</span></code> to generate
a list of strings that represent other ways the given string
could have been encoded. This is the method the QPDF CLI uses
to generate the strings it tries when recovering incorrectly
encoded Unicode passwords.</p></li>
<li><p>Add new versions of
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setR{3,4,5,6}EncryptionParameters</span></code> that allow
more granular setting of permissions bits. See
<code class="file docutils literal notranslate"><span class="pre">QPDFWriter.hh</span></code> for details.</p></li>
<li><p>Add new versions of the transcoders from UTF-8 to single-byte
coding systems in <code class="docutils literal notranslate"><span class="pre">QUtil</span></code> that report success or failure
rather than just substituting a specified unknown character.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QUtil::analyze_encoding()</span></code> to determine whether a
string has high-bit characters and is appears to be UTF-16 or
valid UTF-8 encoding.</p></li>
<li><p>Add new method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::shallowCopyPage()</span></code> to
copy a new page that is a “shallow copy” of a page. The
resulting object is an indirect object ready to be passed to
<code class="docutils literal notranslate"><span class="pre">QPDFPageDocumentHelper::addPage()</span></code> for either the original
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object or a different one. This is what the
<strong class="command">qpdf</strong> command-line tool uses to copy
the same page multiple times from the same file during
splitting and merging operations.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDF::getUniqueId()</span></code>, which returns a unique
identifier for the given QPDF object. The identifier will be
unique across the life of the application. The returned value
can be safely used as a map key.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDF::setImmediateCopyFrom</span></code>. This further
enhances qpdf’s ability to allow a <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object from which
objects are being copied to go out of scope before the
destination object is written. If you call this method on a
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> instances, objects copied <em>from</em> this instance will be
copied immediately instead of lazily. This option uses more
memory but allows the source object to go out of scope before
the destination object is written in all cases. See comments in
<code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code> for details.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::getAttribute</span></code> for
retrieving an attribute from the page dictionary taking
inheritance into consideration, and optionally making a copy if
your intention is to modify the attribute.</p></li>
<li><p>Fix long-standing limitation of
<code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::getPageImages</span></code> so that it now properly
reports images from inherited resources dictionaries,
eliminating the need to call
<code class="docutils literal notranslate"><span class="pre">QPDFPageDocumentHelper::pushInheritedAttributesToPage</span></code> in
this case.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getUniqueResourceName</span></code> for
finding an unused name in a resource dictionary.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::getFormXObjectForPage</span></code> for
generating a form XObject equivalent to a page. The resulting
object can be used in the same file or copied to another file
with <code class="docutils literal notranslate"><span class="pre">copyForeignObject</span></code>. This can be useful for implementing
underlay, overlay, n-up, thumbnails, or any other functionality
requiring replication of pages in other contexts.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper::placeFormXObject</span></code> for
generating content stream text that places a given form XObject
on a page, centered and fit within a specified rectangle. This
method takes care of computing the proper transformation matrix
and may optionally compensate for rotation or scaling of the
destination page.</p></li>
</ul>
</li>
<li><p>Build Improvements</p>
<ul>
<li><p>Add new configure option
<code class="samp docutils literal notranslate"><span class="pre">--enable-avoid-windows-handle</span></code>, which
causes the preprocessor symbol <code class="docutils literal notranslate"><span class="pre">AVOID_WINDOWS_HANDLE</span></code> to be
defined. When defined, qpdf will avoid referencing the Windows
<code class="docutils literal notranslate"><span class="pre">HANDLE</span></code> type, which is disallowed with certain versions of
the Windows SDK.</p></li>
<li><p>For Windows builds, attempt to determine what options, if any,
have to be passed to the compiler and linker to enable use of
<code class="docutils literal notranslate"><span class="pre">wmain</span></code>. This causes the preprocessor symbol
<code class="docutils literal notranslate"><span class="pre">WINDOWS_WMAIN</span></code> to be defined. If you do your own builds with
other compilers, you can define this symbol to cause <code class="docutils literal notranslate"><span class="pre">wmain</span></code>
to be used. This is needed to allow the Windows
<strong class="command">qpdf</strong> command to receive Unicode
command-line options.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.3.0: January 7, 2019</dt><dd><ul class="simple">
<li><p>Command-line Enhancements</p>
<ul>
<li><p>Shell completion: you can now use eval <strong class="command">$(qpdf
--completion-bash)</strong> and eval <strong class="command">$(qpdf
--completion-zsh)</strong> to enable shell completion for
bash and zsh.</p></li>
<li><p>Page numbers (also known as page labels) are now preserved when
merging and splitting files with the
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code> options.</p></li>
<li><p>Bookmarks are partially preserved when splitting pages with the
<code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code> option. Specifically, the
outlines dictionary and some supporting metadata are copied
into the split files. The result is that all bookmarks from the
original file appear, those that point to pages that are
preserved work, and those that point to pages that are not
preserved don’t do anything. This is an interim step toward
proper support for bookmarks in splitting and merging
operations.</p></li>
<li><p>Page collation: add new option
<code class="samp docutils literal notranslate"><span class="pre">--collate</span></code>. When specified, the
semantics of <code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> change from
concatenation to collation. See <a class="reference internal" href="index.html#page-selection"><span class="std std-ref">Page Selection Options</span></a> for examples and discussion.</p></li>
<li><p>Generation of information in JSON format, primarily to
facilitate use of qpdf from languages other than C++. Add new
options <code class="samp docutils literal notranslate"><span class="pre">--json</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--json-key</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">--json-object</span></code> to generate a JSON
representation of the PDF file. Run <strong class="command">qpdf
--json-help</strong> to get a description of the JSON
format. For more information, see <a class="reference internal" href="index.html#json"><span class="std std-ref">QPDF JSON</span></a>.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--generate-appearances</span></code> flag will
cause qpdf to generate appearances for form fields if the PDF
file indicates that form field appearances are out of date.
This can happen when PDF forms are filled in by a program that
doesn’t know how to regenerate the appearances of the filled-in
fields.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--flatten-annotations</span></code> flag can be
used to <em>flatten</em> annotations, including form fields.
Ordinarily, annotations are drawn separately from the page.
Flattening annotations is the process of combining their
appearances into the page’s contents. You might want to do this
if you are going to rotate or combine pages using a tool that
doesn’t understand about annotations. You may also want to use
<code class="samp docutils literal notranslate"><span class="pre">--generate-appearances</span></code> when using this
flag since annotations for outdated form fields are not
flattened as that would cause loss of information.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--optimize-images</span></code> flag tells qpdf
to recompresses every image using DCT (JPEG) compression as
long as the image is not already compressed with lossy
compression and recompressing the image reduces its size. The
additional options <code class="samp docutils literal notranslate"><span class="pre">--oi-min-width</span></code>,
<code class="samp docutils literal notranslate"><span class="pre">--oi-min-height</span></code>, and
<code class="samp docutils literal notranslate"><span class="pre">--oi-min-area</span></code> prevent recompression of
images whose width, height, or pixel area (width × height) are
below a specified threshold.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--show-object</span></code> option can now be
given as <code class="samp docutils literal notranslate"><span class="pre">--show-object=trailer</span></code> to show
the trailer dictionary.</p></li>
</ul>
</li>
<li><p>Bug Fixes and Enhancements</p>
<ul>
<li><p>QPDF now automatically detects and recovers from dangling
references. If a PDF file contained an indirect reference to a
non-existent object, which is valid, when adding a new object
to the file, it was possible for the new object to take the
object ID of the dangling reference, thereby causing the
dangling reference to point to the new object. This case is now
prevented.</p></li>
<li><p>Fixes to form field setting code: strings are always written in
UTF-16 format, and checkboxes and radio buttons are handled
properly with respect to synchronization of values and
appearance states.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDF::checkLinearization()</span></code> no longer causes the program
to crash when it detects problems with linearization data.
Instead, it issues a normal warning or error.</p></li>
<li><p>Ordinarily qpdf treats an argument of the form
<code class="samp docutils literal notranslate"><span class="pre">&#64;file</span></code> to mean that command-line options
should be read from <code class="file docutils literal notranslate"><span class="pre">file</span></code>. Now, if
<code class="file docutils literal notranslate"><span class="pre">file</span></code> does not exist but
<code class="file docutils literal notranslate"><span class="pre">&#64;file</span></code> does, qpdf will treat
<code class="file docutils literal notranslate"><span class="pre">&#64;file</span></code> as a regular option. This
makes it possible to work more easily with PDF files whose
names happen to start with the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> character.</p></li>
</ul>
</li>
<li><p>Library Enhancements</p>
<ul>
<li><p>Remove the restriction in most cases that the source QPDF
object used in a <code class="docutils literal notranslate"><span class="pre">QPDF::copyForeignObject</span></code> call has to stick
around until the destination QPDF is written. The exceptional
case is when the source stream gets is data using a
QPDFObjectHandle::StreamDataProvider. For a more in-depth
discussion, see comments around <code class="docutils literal notranslate"><span class="pre">copyForeignObject</span></code> in
<code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code>.</p></li>
<li><p>Add new method <code class="docutils literal notranslate"><span class="pre">QPDFWriter::getFinalVersion()</span></code>, which returns
the PDF version that will ultimately be written to the final
file. See comments in <code class="file docutils literal notranslate"><span class="pre">QPDFWriter.hh</span></code>
for some restrictions on its use.</p></li>
<li><p>Add several methods for transcoding strings to some of the
character sets used in PDF files: <code class="docutils literal notranslate"><span class="pre">QUtil::utf8_to_ascii</span></code>,
<code class="docutils literal notranslate"><span class="pre">QUtil::utf8_to_win_ansi</span></code>, <code class="docutils literal notranslate"><span class="pre">QUtil::utf8_to_mac_roman</span></code>, and
<code class="docutils literal notranslate"><span class="pre">QUtil::utf8_to_utf16</span></code>. For the single-byte encodings that
support only a limited character sets, these methods replace
unsupported characters with a specified substitute.</p></li>
<li><p>Add new methods to <code class="docutils literal notranslate"><span class="pre">QPDFAnnotationObjectHelper</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper</span></code> for querying flags and
interpretation of different field types. Define constants in
<code class="file docutils literal notranslate"><span class="pre">qpdf/Constants.h</span></code> to help with
interpretation of flag values.</p></li>
<li><p>Add new methods
<code class="docutils literal notranslate"><span class="pre">QPDFAcroFormDocumentHelper::generateAppearancesIfNeeded</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper::generateAppearance</span></code> for
generating appearance streams. See discussion in
<code class="file docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper.hh</span></code> for
limitations.</p></li>
<li><p>Add two new helper functions for dealing with resource
dictionaries: <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getResourceNames()</span></code> returns
a list of all second-level keys, which correspond to the names
of resources, and <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::mergeResources()</span></code> merges
two resources dictionaries as long as they have non-conflicting
keys. These methods are useful for certain types of objects
that resolve resources from multiple places, such as form
fields.</p></li>
<li><p>Add methods <code class="docutils literal notranslate"><span class="pre">QPDFPageDocumentHelper::flattenAnnotations()</span></code>
and
<code class="docutils literal notranslate"><span class="pre">QPDFAnnotationObjectHelper::getPageContentForAppearance()</span></code>
for handling low-level details of annotation flattening.</p></li>
<li><p>Add new helper classes: <code class="docutils literal notranslate"><span class="pre">QPDFOutlineDocumentHelper</span></code>,
<code class="docutils literal notranslate"><span class="pre">QPDFOutlineObjectHelper</span></code>, <code class="docutils literal notranslate"><span class="pre">QPDFPageLabelDocumentHelper</span></code>,
<code class="docutils literal notranslate"><span class="pre">QPDFNameTreeObjectHelper</span></code>, and
<code class="docutils literal notranslate"><span class="pre">QPDFNumberTreeObjectHelper</span></code>.</p></li>
<li><p>Add method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getJSON()</span></code> that returns a JSON
representation of the object. Call <code class="docutils literal notranslate"><span class="pre">serialize()</span></code> on the
result to convert it to a string.</p></li>
<li><p>Add a simple JSON serializer. This is not a complete or
general-purpose JSON library. It allows assembly and
serialization of JSON structures with some restrictions, which
are described in the header file. This is the serializer used
by qpdf’s new JSON representation.</p></li>
<li><p>Add new <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::Matrix</span></code> class along with a few
convenience methods for dealing with six-element numerical
arrays as matrices.</p></li>
<li><p>Add new method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::wrapInArray</span></code>, which returns
the object itself if it is an array, or an array containing the
object otherwise. This is a common construct in PDF. This
method prevents you from having to explicitly test whether
something is a single element or an array.</p></li>
</ul>
</li>
<li><p>Build Improvements</p>
<ul>
<li><p>It is no longer necessary to run
<strong class="command">autogen.sh</strong> to build from a pristine
checkout. Automatically generated files are now committed so
that it is possible to build on platforms without autoconf
directly from a clean checkout of the repository. The
<strong class="command">configure</strong> script detects if the files
are out of date when it also determines that the tools are
present to regenerate them.</p></li>
<li><p>Pull requests and the master branch are now built automatically
in <a class="reference external" href="https://dev.azure.com/qpdf/qpdf/_build">Azure
Pipelines</a>, which is
free for open source projects. The build includes Linux, mac,
Windows 32-bit and 64-bit with mingw and MSVC, and an AppImage
build. Official qpdf releases are now built with Azure
Pipelines.</p></li>
</ul>
</li>
<li><p>Notes for Packagers</p>
<ul>
<li><p>A new section has been added to the documentation with notes
for packagers. Please see <a class="reference internal" href="index.html#packaging"><span class="std std-ref">Notes for Packagers</span></a>.</p></li>
<li><p>The qpdf detects out-of-date automatically generated files. If
your packaging system automatically refreshes libtool or
autoconf files, it could cause this check to fail. To avoid
this problem, pass
<code class="samp docutils literal notranslate"><span class="pre">--disable-check-autofiles</span></code> to
<strong class="command">configure</strong>.</p></li>
<li><p>If you would like to have qpdf completion enabled
automatically, you can install completion files in the
distribution’s default location. You can find sample completion
files to install in the <code class="file docutils literal notranslate"><span class="pre">completions</span></code>
directory.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.2.1: August 18, 2018</dt><dd><ul class="simple">
<li><p>Command-line Enhancements</p>
<ul>
<li><p>Add
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open=</span><em><span class="pre">[yn]</span></em></code>
to override default determination of whether to keep files open
when merging. Please see the discussion of
<code class="samp docutils literal notranslate"><span class="pre">--keep-files-open</span></code> in <a class="reference internal" href="index.html#basic-options"><span class="std std-ref">Basic Options</span></a> for additional details.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.2.0: August 16, 2018</dt><dd><ul class="simple">
<li><p>Command-line Enhancements</p>
<ul>
<li><p>Add <code class="samp docutils literal notranslate"><span class="pre">--no-warn</span></code> option to suppress
issuing warning messages. If there are any conditions that
would have caused warnings to be issued, the exit status is
still 3.</p></li>
</ul>
</li>
<li><p>Bug Fixes and Optimizations</p>
<ul>
<li><p>Performance fix: optimize page merging operation to avoid
unnecessary open/close calls on files being merged. This solves
a dramatic slow-down that was observed when merging certain
types of files.</p></li>
<li><p>Optimize how memory was used for the TIFF predictor,
drastically improving performance and memory usage for files
containing high-resolution images compressed with Flate using
the TIFF predictor.</p></li>
<li><p>Bug fix: end of line characters were not properly handled
inside strings in some cases.</p></li>
<li><p>Bug fix: using <code class="samp docutils literal notranslate"><span class="pre">--progress</span></code> on very small
files could cause an infinite loop.</p></li>
</ul>
</li>
<li><p>API enhancements</p>
<ul>
<li><p>Add new class <code class="docutils literal notranslate"><span class="pre">QPDFSystemError</span></code>, derived from
<code class="docutils literal notranslate"><span class="pre">std::runtime_error</span></code>, which is now thrown by
<code class="docutils literal notranslate"><span class="pre">QUtil::throw_system_error</span></code>. This enables the triggering
<code class="docutils literal notranslate"><span class="pre">errno</span></code> value to be retrieved.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ClosedFileInputSource::stayOpen</span></code> method, enabling a
<code class="docutils literal notranslate"><span class="pre">ClosedFileInputSource</span></code> to stay open during manually
indicated periods of high activity, thus reducing the overhead
of frequent open/close operations.</p></li>
</ul>
</li>
<li><p>Build Changes</p>
<ul>
<li><p>For the mingw builds, change the name of the DLL import library
from <code class="file docutils literal notranslate"><span class="pre">libqpdf.a</span></code> to
<code class="file docutils literal notranslate"><span class="pre">libqpdf.dll.a</span></code> to more accurately
reflect that it is an import library rather than a static
library. This potentially clears the way for supporting a
static library in the future, though presently, the qpdf
Windows build only builds the DLL and executables.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.1.0: June 23, 2018</dt><dd><ul class="simple">
<li><p>Usability Improvements</p>
<ul>
<li><p>When splitting files, qpdf detects fonts and images that the
document metadata claims are referenced from a page but are not
actually referenced and omits them from the output file. This
change can cause a significant reduction in the size of split
PDF files for files created by some software packages. In some
cases, it can also make page splitting slower. Prior versions
of qpdf would believe the document metadata and sometimes
include all the images from all the other pages even though the
pages were no longer present. In the unlikely event that the
old behavior should be desired, or if you have a case where
page splitting is very slow, the old behavior (and speed) can
be enabled by specifying
<code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced-resources</span></code>. For
additional details, please see <a class="reference internal" href="index.html#advanced-transformation"><span class="std std-ref">Advanced Transformation Options</span></a>.</p></li>
<li><p>When merging multiple PDF files, qpdf no longer leaves all the
files open. This makes it possible to merge numbers of files
that may exceed the operating system’s limit for the maximum
number of open files.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--rotate</span></code> option’s syntax has been
extended to make the page range optional. If you specify
<code class="samp docutils literal notranslate"><span class="pre">--rotate=</span><em><span class="pre">angle</span></em></code>
without specifying a page range, the rotation will be applied
to all pages. This can be especially useful for adjusting a PDF
created from a multi-page document that was scanned upside
down.</p></li>
<li><p>When merging multiple files, the
<code class="samp docutils literal notranslate"><span class="pre">--verbose</span></code> option now prints information
about each file as it operates on that file.</p></li>
<li><p>When the <code class="samp docutils literal notranslate"><span class="pre">--progress</span></code> option is
specified, qpdf will print a running indicator of its best
guess at how far through the writing process it is. Note that,
as with all progress meters, it’s an approximation. This option
is implemented in a way that makes it useful for software that
uses the qpdf library; see API Enhancements below.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>Properly decrypt files that use revision 3 of the standard
security handler but use 40 bit keys (even though revision 3
supports 128-bit keys).</p></li>
<li><p>Limit depth of nested data structures to prevent crashes from
certain types of malformed (malicious) PDFs.</p></li>
<li><p>In “newline before endstream” mode, insert the required extra
newline before the <code class="docutils literal notranslate"><span class="pre">endstream</span></code> at the end of object streams.
This one case was previously omitted.</p></li>
</ul>
</li>
<li><p>API Enhancements</p>
<ul>
<li><p>The first round of higher level “helper” interfaces has been
introduced. These are designed to provide a more convenient way
of interacting with certain document features than using
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> directly. For details on helpers, see
<a class="reference internal" href="index.html#helper-classes"><span class="std std-ref">Helper Classes</span></a>. Specific additional
interfaces are described below.</p></li>
<li><p>Add two new document helper classes: <code class="docutils literal notranslate"><span class="pre">QPDFPageDocumentHelper</span></code>
for working with pages, and <code class="docutils literal notranslate"><span class="pre">QPDFAcroFormDocumentHelper</span></code> for
working with interactive forms. No old methods have been
removed, but <code class="docutils literal notranslate"><span class="pre">QPDFPageDocumentHelper</span></code> is now the preferred
way to perform operations on pages rather than calling the old
methods in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> and <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> directly. Comments
in the header files direct you to the new interfaces. Please
see the header files and <code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code>
for additional details.</p></li>
<li><p>Add three new object helper class: <code class="docutils literal notranslate"><span class="pre">QPDFPageObjectHelper</span></code> for
pages, <code class="docutils literal notranslate"><span class="pre">QPDFFormFieldObjectHelper</span></code> for interactive form
fields, and <code class="docutils literal notranslate"><span class="pre">QPDFAnnotationObjectHelper</span></code> for annotations. All
three classes are fairly sparse at the moment, but they have
some useful, basic functionality.</p></li>
<li><p>A new example program
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-set-form-values.cc</span></code> has
been added that illustrates use of the new document and object
helpers.</p></li>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">QPDFWriter::registerProgressReporter</span></code> has been
added. This method allows you to register a function that is
called by <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> to update your idea of the percentage
it thinks it is through writing its output. Client programs can
use this to implement reasonably accurate progress meters. The
<strong class="command">qpdf</strong> command line tool uses this to
implement its <code class="samp docutils literal notranslate"><span class="pre">--progress</span></code> option.</p></li>
<li><p>New methods <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::newUnicodeString</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFObject::unparseBinary</span></code> have been added to allow for more
convenient creation of strings that are explicitly encoded
using big-endian UTF-16. This is useful for creating strings
that appear outside of content streams, such as labels, form
fields, outlines, document metadata, etc.</p></li>
<li><p>A new class <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::Rectangle</span></code> has been added to
ease working with PDF rectangles, which are just arrays of four
numeric values.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>8.0.2: March 6, 2018</dt><dd><ul class="simple">
<li><p>When a loop is detected while following cross reference streams or
tables, treat this as damage instead of silently ignoring the
previous table. This prevents loss of otherwise recoverable data
in some damaged files.</p></li>
<li><p>Properly handle pages with no contents.</p></li>
</ul>
</dd>
<dt>8.0.1: March 4, 2018</dt><dd><ul class="simple">
<li><p>Disregard data check errors when uncompressing <code class="docutils literal notranslate"><span class="pre">/FlateDecode</span></code>
streams. This is consistent with most other PDF readers and allows
qpdf to recover data from another class of malformed PDF files.</p></li>
<li><p>On the command line when specifying page ranges, support preceding
a page number by “r” to indicate that it should be counted from
the end. For example, the range <code class="docutils literal notranslate"><span class="pre">r3-r1</span></code> would indicate the last
three pages of a document.</p></li>
</ul>
</dd>
<dt>8.0.0: February 25, 2018</dt><dd><ul class="simple">
<li><p>Packaging and Distribution Changes</p>
<ul>
<li><p>QPDF is now distributed as an
<a class="reference external" href="https://appimage.org/">AppImage</a> in addition to all the
other ways it is distributed. The AppImage can be found in the
download area with the other packages. Thanks to Kurt Pfeifle
and Simon Peter for their contributions.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getUTF8Val</span></code> now properly treats
non-Unicode strings as encoded with PDF Doc Encoding.</p></li>
<li><p>Improvements to handling of objects in PDF files that are not
of the expected type. In most cases, qpdf will be able to warn
for such cases rather than fail with an exception. Previous
versions of qpdf would sometimes fail with errors such as
“operation for dictionary object attempted on object of wrong
type”. This situation should be mostly or entirely eliminated
now.</p></li>
</ul>
</li>
<li><p>Enhancements to the <strong class="command">qpdf</strong> Command-line
Tool. All new options listed here are documented in more detail in
<a class="reference internal" href="index.html#using"><span class="std std-ref">Running QPDF</span></a>.</p>
<ul>
<li><p>The option
<code class="samp docutils literal notranslate"><span class="pre">--linearize-pass1=</span><em><span class="pre">file</span></em></code>
has been added for debugging qpdf’s linearization code.</p></li>
<li><p>The option <code class="samp docutils literal notranslate"><span class="pre">--coalesce-contents</span></code> can be
used to combine content streams of a page whose contents are an
array of streams into a single stream.</p></li>
</ul>
</li>
<li><p>API Enhancements. All new API calls are documented in their
respective classes’ header files. There are no non-compatible
changes to the API.</p>
<ul>
<li><p>Add function <code class="docutils literal notranslate"><span class="pre">qpdf_check_pdf</span></code> to the C API. This function
does basic checking that is a subset of what <strong class="command">qpdf
--check</strong> performs.</p></li>
<li><p>Major enhancements to the lexical layer of qpdf. For a complete
list of enhancements, please refer to the
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> file. Most of the changes
result in improvements to qpdf’s ability handle erroneous
files. It is also possible for programs to handle whitespace,
comments, and inline images as tokens.</p></li>
<li><p>New API for working with PDF content streams at a lexical
level. The new class <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::TokenFilter</span></code> allows
the developer to provide token handlers. Token filters can be
used with several different methods in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> as
well as with a lower-level interface. See comments in
<code class="file docutils literal notranslate"><span class="pre">QPDFObjectHandle.hh</span></code> as well as the
new examples
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-filter-tokens.cc</span></code> and
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-count-strings.cc</span></code> for
details.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>7.1.1: February 4, 2018</dt><dd><ul class="simple">
<li><p>Bug fix: files whose /ID fields were other than 16 bytes long can
now be properly linearized</p></li>
<li><p>A few compile and link issues have been corrected for some
platforms.</p></li>
</ul>
</dd>
<dt>7.1.0: January 14, 2018</dt><dd><ul class="simple">
<li><p>PDF files contain streams that may be compressed with various
compression algorithms which, in some cases, may be enhanced by
various predictor functions. Previously only the PNG up predictor
was supported. In this version, all the PNG predictors as well as
the TIFF predictor are supported. This increases the range of
files that qpdf is able to handle.</p></li>
<li><p>QPDF now allows a raw encryption key to be specified in place of a
password when opening encrypted files, and will optionally display
the encryption key used by a file. This is a non-standard
operation, but it can be useful in certain situations. Please see
the discussion of <code class="samp docutils literal notranslate"><span class="pre">--password-is-hex-key</span></code> in
<a class="reference internal" href="index.html#basic-options"><span class="std std-ref">Basic Options</span></a> or the comments around
<code class="docutils literal notranslate"><span class="pre">QPDF::setPasswordIsHexKey</span></code> in
<code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code> for additional details.</p></li>
<li><p>Bug fix: numbers ending with a trailing decimal point are now
properly recognized as numbers.</p></li>
<li><p>Bug fix: when building qpdf from source on some platforms
(especially MacOS), the build could get confused by older versions
of qpdf installed on the system. This has been corrected.</p></li>
</ul>
</dd>
<dt>7.0.0: September 15, 2017</dt><dd><ul class="simple">
<li><p>Packaging and Distribution Changes</p>
<ul>
<li><p>QPDF’s primary license is now <a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">version 2.0 of the Apache
License</a> rather
than version 2.0 of the Artistic License. You may still, at
your option, consider qpdf to be licensed with version 2.0 of
the Artistic license.</p></li>
<li><p>QPDF no longer has a dependency on the PCRE (Perl-Compatible
Regular Expression) library. QPDF now has an added dependency
on the JPEG library.</p></li>
</ul>
</li>
<li><p>Bug Fixes</p>
<ul>
<li><p>This release contains many bug fixes for various infinite
loops, memory leaks, and other memory errors that could be
encountered with specially crafted or otherwise erroneous PDF
files.</p></li>
</ul>
</li>
<li><p>New Features</p>
<ul>
<li><p>QPDF now supports reading and writing streams encoded with JPEG
or RunLength encoding. Library API enhancements and
command-line options have been added to control this behavior.
See command-line options
<code class="samp docutils literal notranslate"><span class="pre">--compress-streams</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--decode-level</span></code> and methods
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setCompressStreams</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setDecodeLevel</span></code>.</p></li>
<li><p>QPDF is much better at recovering from broken files. In most
cases, qpdf will skip invalid objects and will preserve broken
stream data by not attempting to filter broken streams. QPDF is
now able to recover or at least not crash on dozens of broken
test files I have received over the past few years.</p></li>
<li><p>Page rotation is now supported and accessible from both the
library and the command line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> supports writing files in a way that preserves
PCLm compliance in support of driverless printing. This is very
specialized and is only useful to applications that already
know how to create PCLm files.</p></li>
</ul>
</li>
<li><p>Enhancements to the <strong class="command">qpdf</strong> Command-line
Tool. All new options listed here are documented in more detail in
<a class="reference internal" href="index.html#using"><span class="std std-ref">Running QPDF</span></a>.</p>
<ul>
<li><p>Command-line arguments can now be read from files or standard
input using <code class="docutils literal notranslate"><span class="pre">&#64;file</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;-</span></code> syntax. Please see <a class="reference internal" href="index.html#invocation"><span class="std std-ref">Basic Invocation</span></a>.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--rotate</span></code>: request page rotation</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--newline-before-endstream</span></code>: ensure that
a newline appears before every <code class="docutils literal notranslate"><span class="pre">endstream</span></code> keyword in the
file; used to prevent qpdf from breaking PDF/A compliance on
already compliant files.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--preserve-unreferenced</span></code>: preserve
unreferenced objects in the input PDF</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code>: break output into chunks
with fixed numbers of pages</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--verbose</span></code>: print the name of each
output file that is created</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">--compress-streams</span></code> and
<code class="samp docutils literal notranslate"><span class="pre">--decode-level</span></code> replace
<code class="samp docutils literal notranslate"><span class="pre">--stream-data</span></code> for improving granularity
of controlling compression and decompression of stream data.
The <code class="samp docutils literal notranslate"><span class="pre">--stream-data</span></code> option will remain
available.</p></li>
<li><p>When running <strong class="command">qpdf --check</strong> with other
options, checks are always run first. This enables qpdf to
perform its full recovery logic before outputting other
information. This can be especially useful when manually
recovering broken files, looking at qpdf’s regenerated cross
reference table, or other similar operations.</p></li>
<li><p>Process <strong class="command">--pages</strong> earlier so that other
options like <code class="samp docutils literal notranslate"><span class="pre">--show-pages</span></code> or
<code class="samp docutils literal notranslate"><span class="pre">--split-pages</span></code> can operate on the file
after page splitting/merging has occurred.</p></li>
</ul>
</li>
<li><p>API Changes. All new API calls are documented in their respective
classes’ header files.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::rotatePage</span></code>: apply rotation to a page
object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFWriter::setNewlineBeforeEndstream</span></code>: force newline to
appear before <code class="docutils literal notranslate"><span class="pre">endstream</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFWriter::setPreserveUnreferencedObjects</span></code>: preserve
unreferenced objects that appear in the input PDF. The default
behavior is to discard them.</p></li>
<li><p>New <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> types <code class="docutils literal notranslate"><span class="pre">Pl_RunLength</span></code> and <code class="docutils literal notranslate"><span class="pre">Pl_DCT</span></code> are
available for developers who wish to produce or consume
RunLength or DCT stream data directly. The
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-create.cc</span></code> example
illustrates their use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFWriter::setCompressStreams</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setDecodeLevel</span></code> methods control handling of
different types of stream compression.</p></li>
<li><p>Add new C API functions <code class="docutils literal notranslate"><span class="pre">qpdf_set_compress_streams</span></code>,
<code class="docutils literal notranslate"><span class="pre">qpdf_set_decode_level</span></code>,
<code class="docutils literal notranslate"><span class="pre">qpdf_set_preserve_unreferenced_objects</span></code>, and
<code class="docutils literal notranslate"><span class="pre">qpdf_set_newline_before_endstream</span></code> corresponding to the new
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> methods.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>6.0.0: November 10, 2015</dt><dd><ul class="simple">
<li><p>Implement <code class="samp docutils literal notranslate"><span class="pre">--deterministic-id</span></code> command-line
option and <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setDeterministicID</span></code> as well as C API
function <code class="docutils literal notranslate"><span class="pre">qpdf_set_deterministic_ID</span></code> for generating a
deterministic ID for non-encrypted files. When this option is
selected, the ID of the file depends on the contents of the output
file, and not on transient items such as the timestamp or output
file name.</p></li>
<li><p>Make qpdf more tolerant of files whose xref table entries are not
the correct length.</p></li>
</ul>
</dd>
<dt>5.1.3: May 24, 2015</dt><dd><ul class="simple">
<li><p>Bug fix: fix-qdf was not properly handling files that contained
object streams with more than 255 objects in them.</p></li>
<li><p>Bug fix: qpdf was not properly initializing Microsoft’s secure
crypto provider on fresh Windows installations that had not had
any keys created yet.</p></li>
<li><p>Fix a few errors found by Gynvael Coldwind and Mateusz Jurczyk of
the Google Security Team. Please see the ChangeLog for details.</p></li>
<li><p>Properly handle pages that have no contents at all. There were
many cases in which qpdf handled this fine, but a few methods
blindly obtained page contents with handling the possibility that
there were no contents.</p></li>
<li><p>Make qpdf more robust for a few more kinds of problems that may
occur in invalid PDF files.</p></li>
</ul>
</dd>
<dt>5.1.2: June 7, 2014</dt><dd><ul class="simple">
<li><p>Bug fix: linearizing files could create a corrupted output file
under extremely unlikely file size circumstances. See ChangeLog
for details. The odds of getting hit by this are very low, though
one person did.</p></li>
<li><p>Bug fix: qpdf would fail to write files that had streams with
decode parameters referencing other streams.</p></li>
<li><p>New example program: <strong class="command">pdf-split-pages</strong>:
efficiently split PDF files into individual pages. The example
program does this more efficiently than using <strong class="command">qpdf
--pages</strong> to do it.</p></li>
<li><p>Packaging fix: Visual C++ binaries did not support Windows XP.
This has been rectified by updating the compilers used to generate
the release binaries.</p></li>
</ul>
</dd>
<dt>5.1.1: January 14, 2014</dt><dd><ul class="simple">
<li><p>Performance fix: copying foreign objects could be very slow with
certain types of files. This was most likely to be visible during
page splitting and was due to traversing the same objects multiple
times in some cases.</p></li>
</ul>
</dd>
<dt>5.1.0: December 17, 2013</dt><dd><ul class="simple">
<li><p>Added runtime option (<code class="docutils literal notranslate"><span class="pre">QUtil::setRandomDataProvider</span></code>) to supply
your own random data provider. You can use this if you want to
avoid using the OS-provided secure random number generation
facility or stdlib’s less secure version. See comments in
include/qpdf/QUtil.hh for details.</p></li>
<li><p>Fixed image comparison tests to not create 12-bit-per-pixel images
since some versions of tiffcmp have bugs in comparing them in some
cases. This increases the disk space required by the image
comparison tests, which are off by default anyway.</p></li>
<li><p>Introduce a number of small fixes for compilation on the latest
clang in MacOS and the latest Visual C++ in Windows.</p></li>
<li><p>Be able to handle broken files that end the xref table header with
a space instead of a newline.</p></li>
</ul>
</dd>
<dt>5.0.1: October 18, 2013</dt><dd><ul class="simple">
<li><p>Thanks to a detailed review by Florian Weimer and the Red Hat
Product Security Team, this release includes a number of
non-user-visible security hardening changes. Please see the
ChangeLog file in the source distribution for the complete list.</p></li>
<li><p>When available, operating system-specific secure random number
generation is used for generating initialization vectors and other
random values used during encryption or file creation. For the
Windows build, this results in an added dependency on Microsoft’s
cryptography API. To disable the OS-specific cryptography and use
the old version, pass the
<code class="samp docutils literal notranslate"><span class="pre">--enable-insecure-random</span></code> option to
<strong class="command">./configure</strong>.</p></li>
<li><p>The <strong class="command">qpdf</strong> command-line tool now issues a
warning when <code class="samp docutils literal notranslate"><span class="pre">-accessibility=n</span></code> is specified
for newer encryption versions stating that the option is ignored.
qpdf, per the spec, has always ignored this flag, but it
previously did so silently. This warning is issued only by the
command-line tool, not by the library. The library’s handling of
this flag is unchanged.</p></li>
</ul>
</dd>
<dt>5.0.0: July 10, 2013</dt><dd><ul class="simple">
<li><p>Bug fix: previous versions of qpdf would lose objects with
generation != 0 when generating object streams. Fixing this
required changes to the public API.</p></li>
<li><p>Removed methods from public API that were only supposed to be
called by QPDFWriter and couldn’t realistically be called anywhere
else. See ChangeLog for details.</p></li>
<li><p>New <code class="docutils literal notranslate"><span class="pre">QPDFObjGen</span></code> class added to represent an object
ID/generation pair. <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getObjGen()</span></code> is now
preferred over <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getObjectID()</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getGeneration()</span></code> as it makes it less likely
for people to accidentally write code that ignores the generation
number. See <code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code> and
<code class="file docutils literal notranslate"><span class="pre">QPDFObjectHandle.hh</span></code> for additional
notes.</p></li>
<li><p>Add <code class="samp docutils literal notranslate"><span class="pre">--show-npages</span></code> command-line option to
the <strong class="command">qpdf</strong> command to show the number of
pages in a file.</p></li>
<li><p>Allow omission of the page range within
<code class="samp docutils literal notranslate"><span class="pre">--pages</span></code> for the
<strong class="command">qpdf</strong> command. When omitted, the page
range is implicitly taken to be all the pages in the file.</p></li>
<li><p>Various enhancements were made to support different types of
broken files or broken readers. Details can be found in
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code>.</p></li>
</ul>
</dd>
<dt>4.1.0: April 14, 2013</dt><dd><ul class="simple">
<li><p>Note to people including qpdf in distributions: the
<code class="file docutils literal notranslate"><span class="pre">.la</span></code> files generated by libtool are now
installed by qpdf’s <strong class="command">make install</strong> target.
Before, they were not installed. This means that if your
distribution does not want to include
<code class="file docutils literal notranslate"><span class="pre">.la</span></code> files, you must remove them as
part of your packaging process.</p></li>
<li><p>Major enhancement: API enhancements have been made to support
parsing of content streams. This enhancement includes the
following changes:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::parseContentStream</span></code> method parses objects
in a content stream and calls handlers in a callback class. The
example
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-parse-content.cc</span></code>
illustrates how this may be used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> can now represent operators and inline
images, object types that may only appear in content streams.</p></li>
<li><p>Method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getTypeCode()</span></code> returns an
enumerated type value representing the underlying object type.
Method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getTypeName()</span></code> returns a text
string describing the name of the type of a
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> object. These methods can be used for more
efficient parsing and debugging/diagnostic messages.</p></li>
</ul>
</li>
<li><p><strong class="command">qpdf --check</strong> now parses all pages’
content streams in addition to doing other checks. While there are
still many types of errors that cannot be detected, syntactic
errors in content streams will now be reported.</p></li>
<li><p>Minor compilation enhancements have been made to facilitate easier
for support for a broader range of compilers and compiler
versions.</p>
<ul>
<li><p>Warning flags have been moved into a separate variable in
<code class="file docutils literal notranslate"><span class="pre">autoconf.mk</span></code></p></li>
<li><p>The configure flag <code class="samp docutils literal notranslate"><span class="pre">--enable-werror</span></code> work
for Microsoft compilers</p></li>
<li><p>All MSVC CRT security warnings have been resolved.</p></li>
<li><p>All C-style casts in C++ Code have been replaced by C++ casts,
and many casts that had been included to suppress higher
warning levels for some compilers have been removed, primarily
for clarity. Places where integer type coercion occurs have
been scrutinized. A new casting policy has been documented in
the manual. This is of concern mainly to people porting qpdf to
new platforms or compilers. It is not visible to programmers
writing code that uses the library</p></li>
<li><p>Some internal limits have been removed in code that converts
numbers to strings. This is largely invisible to users, but it
does trigger a bug in some older versions of mingw-w64’s C++
library. See <code class="file docutils literal notranslate"><span class="pre">README-windows.md</span></code> in
the source distribution if you think this may affect you. The
copy of the DLL distributed with qpdf’s binary distribution is
not affected by this problem.</p></li>
</ul>
</li>
<li><p>The RPM spec file previously included with qpdf has been removed.
This is because virtually all Linux distributions include qpdf now
that it is a dependency of CUPS filters.</p></li>
<li><p>A few bug fixes are included:</p>
<ul>
<li><p>Overridden compressed objects are properly handled. Before,
there were certain constructs that could cause qpdf to see old
versions of some objects. The most usual manifestation of this
was loss of filled in form values for certain files.</p></li>
<li><p>Installation no longer uses GNU/Linux-specific versions of some
commands, so <strong class="command">make install</strong> works on
Solaris with native tools.</p></li>
<li><p>The 64-bit mingw Windows binary package no longer includes a
32-bit DLL.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>4.0.1: January 17, 2013</dt><dd><ul class="simple">
<li><p>Fix detection of binary attachments in test suite to avoid false
test failures on some platforms.</p></li>
<li><p>Add clarifying comment in <code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code> to
methods that return the user password explaining that it is no
longer possible with newer encryption formats to recover the user
password knowing the owner password. In earlier encryption
formats, the user password was encrypted in the file using the
owner password. In newer encryption formats, a separate encryption
key is used on the file, and that key is independently encrypted
using both the user password and the owner password.</p></li>
</ul>
</dd>
<dt>4.0.0: December 31, 2012</dt><dd><ul class="simple">
<li><p>Major enhancement: support has been added for newer encryption
schemes supported by version X of Adobe Acrobat. This includes use
of 127-character passwords, 256-bit encryption keys, and the
encryption scheme specified in ISO 32000-2, the PDF 2.0
specification. This scheme can be chosen from the command line by
specifying use of 256-bit keys. qpdf also supports the deprecated
encryption method used by Acrobat IX. This encryption style has
known security weaknesses and should not be used in practice.
However, such files exist “in the wild,” so support for this
scheme is still useful. New methods
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setR6EncryptionParameters</span></code> (for the PDF 2.0 scheme)
and <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setR5EncryptionParameters</span></code> (for the deprecated
scheme) have been added to enable these new encryption schemes.
Corresponding functions have been added to the C API as well.</p></li>
<li><p>Full support for Adobe extension levels in PDF version
information. Starting with PDF version 1.7, corresponding to ISO
32000, Adobe adds new functionality by increasing the extension
level rather than increasing the version. This support includes
addition of the <code class="docutils literal notranslate"><span class="pre">QPDF::getExtensionLevel</span></code> method for retrieving
the document’s extension level, addition of versions of
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setMinimumPDFVersion</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::forcePDFVersion</span></code> that accept an extension level,
and extended syntax for specifying forced and minimum versions on
the command line as described in <a class="reference internal" href="index.html#advanced-transformation"><span class="std std-ref">Advanced Transformation Options</span></a>. Corresponding functions
have been added to the C API as well.</p></li>
<li><p>Minor fixes to prevent qpdf from referencing objects in the file
that are not referenced in the file’s overall structure. Most
files don’t have any such objects, but some files have contain
unreferenced objects with errors, so these fixes prevent qpdf from
needlessly rejecting or complaining about such objects.</p></li>
<li><p>Add new generalized methods for reading and writing files from/to
programmer-defined sources. The method
<code class="docutils literal notranslate"><span class="pre">QPDF::processInputSource</span></code> allows the programmer to use any
input source for the input file, and
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setOutputPipeline</span></code> allows the programmer to write
the output file through any pipeline. These methods would make it
possible to perform any number of specialized operations, such as
accessing external storage systems, creating bindings for qpdf in
other programming languages that have their own I/O systems, etc.</p></li>
<li><p>Add new method <code class="docutils literal notranslate"><span class="pre">QPDF::getEncryptionKey</span></code> for retrieving the
underlying encryption key used in the file.</p></li>
<li><p>This release includes a small handful of non-compatible API
changes. While effort is made to avoid such changes, all the
non-compatible API changes in this version were to parts of the
API that would likely never be used outside the library itself. In
all cases, the altered methods or structures were parts of the
<code class="docutils literal notranslate"><span class="pre">QPDF</span></code> that were public to enable them to be called from either
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> or were part of validation code that was
over-zealous in reporting problems in parts of the file that would
not ordinarily be referenced. In no case did any of the removed
methods do anything worse that falsely report error conditions in
files that were broken in ways that didn’t matter. The following
public parts of the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> class were changed in a
non-compatible way:</p>
<ul>
<li><p>Updated nested <code class="docutils literal notranslate"><span class="pre">QPDF::EncryptionData</span></code> class to add fields
needed by the newer encryption formats, member variables
changed to private so that future changes will not require
breaking backward compatibility.</p></li>
<li><p>Added additional parameters to <code class="docutils literal notranslate"><span class="pre">compute_data_key</span></code>, which is
used by <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> to compute the encryption key used to
encrypt a specific object.</p></li>
<li><p>Removed the method <code class="docutils literal notranslate"><span class="pre">flattenScalarReferences</span></code>. This method was
previously used prior to writing a new PDF file, but it has the
undesired side effect of causing qpdf to read objects in the
file that were not referenced. Some otherwise files have
unreferenced objects with errors in them, so this could cause
qpdf to reject files that would be accepted by virtually all
other PDF readers. In fact, qpdf relied on only a very small
part of what flattenScalarReferences did, so only this part has
been preserved, and it is now done directly inside
<code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>.</p></li>
<li><p>Removed the method <code class="docutils literal notranslate"><span class="pre">decodeStreams</span></code>. This method was used by
the <code class="samp docutils literal notranslate"><span class="pre">--check</span></code> option of the
<strong class="command">qpdf</strong> command-line tool to force all
streams in the file to be decoded, but it also suffered from
the problem of opening otherwise unreferenced streams and thus
could report false positive. The
<code class="samp docutils literal notranslate"><span class="pre">--check</span></code> option now causes qpdf to go
through all the motions of writing a new file based on the
original one, so it will always reference and check exactly
those parts of a file that any ordinary viewer would check.</p></li>
<li><p>Removed the method <code class="docutils literal notranslate"><span class="pre">trimTrailerForWrite</span></code>. This method was
used by <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> to modify the original QPDF object by
removing fields from the trailer dictionary that wouldn’t apply
to the newly written file. This functionality, though generally
harmless, was a poor implementation and has been replaced by
having QPDFWriter filter these out when copying the trailer
rather than modifying the original QPDF object. (Note that qpdf
never modifies the original file itself.)</p></li>
</ul>
</li>
<li><p>Allow the PDF header to appear anywhere in the first 1024 bytes of
the file. This is consistent with what other readers do.</p></li>
<li><p>Fix the <strong class="command">pkg-config</strong> files to list zlib
and pcre in <code class="docutils literal notranslate"><span class="pre">Requires.private</span></code> to better support static linking
using <strong class="command">pkg-config</strong>.</p></li>
</ul>
</dd>
<dt>3.0.2: September 6, 2012</dt><dd><ul class="simple">
<li><p>Bug fix: <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setOutputMemory</span></code> did not work when not
used with <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setStaticID</span></code>, which made it pretty much
useless. This has been fixed.</p></li>
<li><p>New API call <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setExtraHeaderText</span></code> inserts additional
text near the header of the PDF file. The intended use case is to
insert comments that may be consumed by a downstream application,
though other use cases may exist.</p></li>
</ul>
</dd>
<dt>3.0.1: August 11, 2012</dt><dd><ul class="simple">
<li><p>Version 3.0.0 included addition of files for
<strong class="command">pkg-config</strong>, but this was not mentioned
in the release notes. The release notes for 3.0.0 were updated to
mention this.</p></li>
<li><p>Bug fix: if an object stream ended with a scalar object not
followed by space, qpdf would incorrectly report that it
encountered a premature EOF. This bug has been in qpdf since
version 2.0.</p></li>
</ul>
</dd>
<dt>3.0.0: August 2, 2012</dt><dd><ul class="simple">
<li><p>Acknowledgment: I would like to express gratitude for the
contributions of Tobias Hoffmann toward the release of qpdf
version 3.0. He is responsible for most of the implementation and
design of the new API for manipulating pages, and contributed code
and ideas for many of the improvements made in version 3.0.
Without his work, this release would certainly not have happened
as soon as it did, if at all.</p></li>
<li><p><em>Non-compatible API changes:</em></p>
<ul>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::replaceStreamData</span></code> that uses a
<code class="docutils literal notranslate"><span class="pre">StreamDataProvider</span></code> to provide the stream data no longer
takes a <code class="docutils literal notranslate"><span class="pre">length</span></code> parameter. The parameter was removed since
this provides the user an opportunity to simplify the calling
code. This method was introduced in version 2.2. At the time,
the <code class="docutils literal notranslate"><span class="pre">length</span></code> parameter was required in order to ensure that
calls to the stream data provider returned the same length for a
specific stream every time they were invoked. In particular, the
linearization code depends on this. Instead, qpdf 3.0 and newer
check for that constraint explicitly. The first time the stream
data provider is called for a specific stream, the actual length
is saved, and subsequent calls are required to return the same
number of bytes. This means the calling code no longer has to
compute the length in advance, which can be a significant
simplification. If your code fails to compile because of the
extra argument and you don’t want to make other changes to your
code, just omit the argument.</p></li>
<li><p>Many methods take <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">long</span></code> instead of other integer types.
Most if not all existing code should compile fine with this
change since such parameters had always previously been smaller
types. This change was required to support files larger than two
gigabytes in size.</p></li>
</ul>
</li>
<li><p>Support has been added for large files. The test suite verifies
support for files larger than 4 gigabytes, and manual testing has
verified support for files larger than 10 gigabytes. Large file
support is available for both 32-bit and 64-bit platforms as long
as the compiler and underlying platforms support it.</p></li>
<li><p>Support for page selection (splitting and merging PDF files) has
been added to the <strong class="command">qpdf</strong> command-line
tool. See <a class="reference internal" href="index.html#page-selection"><span class="std std-ref">Page Selection Options</span></a>.</p></li>
<li><p>Options have been added to the <strong class="command">qpdf</strong>
command-line tool for copying encryption parameters from another
file. See <a class="reference internal" href="index.html#basic-options"><span class="std std-ref">Basic Options</span></a>.</p></li>
<li><p>New methods have been added to the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object for adding and
removing pages. See <a class="reference internal" href="index.html#adding-and-remove-pages"><span class="std std-ref">Adding and Removing Pages</span></a>.</p></li>
<li><p>New methods have been added to the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object for copying
objects from other PDF files. See <a class="reference internal" href="index.html#foreign-objects"><span class="std std-ref">Copying Objects From Other PDF Files</span></a></p></li>
<li><p>A new method <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::parse</span></code> has been added for
constructing <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> objects from a string
description.</p></li>
<li><p>Methods have been added to <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> to allow writing to an
already open stdio <code class="docutils literal notranslate"><span class="pre">FILE*</span></code> addition to writing to standard
output or a named file. Methods have been added to <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> to be
able to process a file from an already open stdio <code class="docutils literal notranslate"><span class="pre">FILE*</span></code>. This
makes it possible to read and write PDF from secure temporary
files that have been unlinked prior to being fully read or
written.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDF::emptyPDF</span></code> can be used to allow creation of PDF files
from scratch. The example
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-create.cc</span></code> illustrates how
it can be used.</p></li>
<li><p>Several methods to take <code class="docutils literal notranslate"><span class="pre">PointerHolder&lt;Buffer&gt;</span></code> can now also
accept <code class="docutils literal notranslate"><span class="pre">std::string</span></code> arguments.</p></li>
<li><p>Many new convenience methods have been added to the library, most
in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>. See <code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code>
for a full list.</p></li>
<li><p>When building on a platform that supports ELF shared libraries
(such as Linux), symbol versions are enabled by default. They can
be disabled by passing
<code class="samp docutils literal notranslate"><span class="pre">--disable-ld-version-script</span></code> to
<strong class="command">./configure</strong>.</p></li>
<li><p>The file <code class="file docutils literal notranslate"><span class="pre">libqpdf.pc</span></code> is now installed
to support <strong class="command">pkg-config</strong>.</p></li>
<li><p>Image comparison tests are off by default now since they are not
needed to verify a correct build or port of qpdf. They are needed
only when changing the actual PDF output generated by qpdf. You
should enable them if you are making deep changes to qpdf itself.
See <code class="file docutils literal notranslate"><span class="pre">README.md</span></code> for details.</p></li>
<li><p>Large file tests are off by default but can be turned on with
<strong class="command">./configure</strong> or by setting an environment
variable before running the test suite. See
<code class="file docutils literal notranslate"><span class="pre">README.md</span></code> for details.</p></li>
<li><p>When qpdf’s test suite fails, failures are not printed to the
terminal anymore by default. Instead, find them in
<code class="file docutils literal notranslate"><span class="pre">build/qtest.log</span></code>. For packagers who are
building with an autobuilder, you can add the
<code class="samp docutils literal notranslate"><span class="pre">--enable-show-failed-test-output</span></code> option to
<strong class="command">./configure</strong> to restore the old behavior.</p></li>
</ul>
</dd>
<dt>2.3.1: December 28, 2011</dt><dd><ul class="simple">
<li><p>Fix thread-safety problem resulting from non-thread-safe use of
the PCRE library.</p></li>
<li><p>Made a few minor documentation fixes.</p></li>
<li><p>Add workaround for a bug that appears in some versions of
ghostscript to the test suite</p></li>
<li><p>Fix minor build issue for Visual C++ 2010.</p></li>
</ul>
</dd>
<dt>2.3.0: August 11, 2011</dt><dd><ul class="simple">
<li><p>Bug fix: when preserving existing encryption on encrypted files
with cleartext metadata, older qpdf versions would generate
password-protected files with no valid password. This operation
now works. This bug only affected files created by copying
existing encryption parameters; explicit encryption with
specification of cleartext metadata worked before and continues to
work.</p></li>
<li><p>Enhance <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> with a new constructor that allows you to
delay the specification of the output file. When using this
constructor, you may now call <code class="docutils literal notranslate"><span class="pre">QPDFWriter::setOutputFilename</span></code> to
specify the output file, or you may use
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::setOutputMemory</span></code> to cause <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code> to write
the resulting PDF file to a memory buffer. You may then use
<code class="docutils literal notranslate"><span class="pre">QPDFWriter::getBuffer</span></code> to retrieve the memory buffer.</p></li>
<li><p>Add new API call <code class="docutils literal notranslate"><span class="pre">QPDF::replaceObject</span></code> for replacing objects by
object ID</p></li>
<li><p>Add new API call <code class="docutils literal notranslate"><span class="pre">QPDF::swapObjects</span></code> for swapping two objects by
object ID</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getDictAsMap</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle::getArrayAsVector</span></code> to allow retrieval of
dictionary objects as maps and array objects as vectors.</p></li>
<li><p>Add functions <code class="docutils literal notranslate"><span class="pre">qpdf_get_info_key</span></code> and <code class="docutils literal notranslate"><span class="pre">qpdf_set_info_key</span></code> to
the C API for manipulating string fields of the document’s
<code class="docutils literal notranslate"><span class="pre">/Info</span></code> dictionary.</p></li>
<li><p>Add functions <code class="docutils literal notranslate"><span class="pre">qpdf_init_write_memory</span></code>,
<code class="docutils literal notranslate"><span class="pre">qpdf_get_buffer_length</span></code>, and <code class="docutils literal notranslate"><span class="pre">qpdf_get_buffer</span></code> to the C API
for writing PDF files to a memory buffer instead of a file.</p></li>
</ul>
</dd>
<dt>2.2.4: June 25, 2011</dt><dd><ul class="simple">
<li><p>Fix installation and compilation issues; no functionality changes.</p></li>
</ul>
</dd>
<dt>2.2.3: April 30, 2011</dt><dd><ul class="simple">
<li><p>Handle some damaged streams with incorrect characters following
the stream keyword.</p></li>
<li><p>Improve handling of inline images when normalizing content
streams.</p></li>
<li><p>Enhance error recovery to properly handle files that use object 0
as a regular object, which is specifically disallowed by the spec.</p></li>
</ul>
</dd>
<dt>2.2.2: October 4, 2010</dt><dd><ul class="simple">
<li><p>Add new function <code class="docutils literal notranslate"><span class="pre">qpdf_read_memory</span></code> to the C API to call
<code class="docutils literal notranslate"><span class="pre">QPDF::processMemoryFile</span></code>. This was an omission in qpdf 2.2.1.</p></li>
</ul>
</dd>
<dt>2.2.1: October 1, 2010</dt><dd><ul class="simple">
<li><p>Add new method <code class="docutils literal notranslate"><span class="pre">QPDF::setOutputStreams</span></code> to replace <code class="docutils literal notranslate"><span class="pre">std::cout</span></code>
and <code class="docutils literal notranslate"><span class="pre">std::cerr</span></code> with other streams for generation of diagnostic
messages and error messages. This can be useful for GUIs or other
applications that want to capture any output generated by the
library to present to the user in some other way. Note that QPDF
does not write to <code class="docutils literal notranslate"><span class="pre">std::cout</span></code> (or the specified output stream)
except where explicitly mentioned in
<code class="file docutils literal notranslate"><span class="pre">QPDF.hh</span></code>, and that the only use of the
error stream is for warnings. Note also that output of warnings is
suppressed when <code class="docutils literal notranslate"><span class="pre">setSuppressWarnings(true)</span></code> is called.</p></li>
<li><p>Add new method <code class="docutils literal notranslate"><span class="pre">QPDF::processMemoryFile</span></code> for operating on PDF
files that are loaded into memory rather than in a file on disk.</p></li>
<li><p>Give a warning but otherwise ignore empty PDF objects by treating
them as null. Empty object are not permitted by the PDF
specification but have been known to appear in some actual PDF
files.</p></li>
<li><p>Handle inline image filter abbreviations when the appear as stream
filter abbreviations. The PDF specification does not allow use of
stream filter abbreviations in this way, but Adobe Reader and some
other PDF readers accept them since they sometimes appear
incorrectly in actual PDF files.</p></li>
<li><p>Implement miscellaneous enhancements to <code class="docutils literal notranslate"><span class="pre">PointerHolder</span></code> and
<code class="docutils literal notranslate"><span class="pre">Buffer</span></code> to support other changes.</p></li>
</ul>
</dd>
<dt>2.2.0: August 14, 2010</dt><dd><ul class="simple">
<li><p>Add new methods to <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code> (<code class="docutils literal notranslate"><span class="pre">newStream</span></code> and
<code class="docutils literal notranslate"><span class="pre">replaceStreamData</span></code> for creating new streams and replacing
stream data. This makes it possible to perform a wide range of
operations that were not previously possible.</p></li>
<li><p>Add new helper method in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>
(<code class="docutils literal notranslate"><span class="pre">addPageContents</span></code>) for appending or prepending new content
streams to a page. This method makes it possible to manipulate
content streams without having to be concerned whether a page’s
contents are a single stream or an array of streams.</p></li>
<li><p>Add new method in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>: <code class="docutils literal notranslate"><span class="pre">replaceOrRemoveKey</span></code>,
which replaces a dictionary key with a given value unless the
value is null, in which case it removes the key instead.</p></li>
<li><p>Add new method in <code class="docutils literal notranslate"><span class="pre">QPDFObjectHandle</span></code>: <code class="docutils literal notranslate"><span class="pre">getRawStreamData</span></code>,
which returns the raw (unfiltered) stream data into a buffer. This
complements the <code class="docutils literal notranslate"><span class="pre">getStreamData</span></code> method, which returns the
filtered (uncompressed) stream data and can only be used when the
stream’s data is filterable.</p></li>
<li><p>Provide two new examples:
<strong class="command">pdf-double-page-size</strong> and
<strong class="command">pdf-invert-images</strong> that illustrate the
newly added interfaces.</p></li>
<li><p>Fix a memory leak that would cause loss of a few bytes for every
object involved in a cycle of object references. Thanks to Jian Ma
for calling my attention to the leak.</p></li>
</ul>
</dd>
<dt>2.1.5: April 25, 2010</dt><dd><ul class="simple">
<li><p>Remove restriction of file identifier strings to 16 bytes. This
unnecessary restriction was preventing qpdf from being able to
encrypt or decrypt files with identifier strings that were not
exactly 16 bytes long. The specification imposes no such
restriction.</p></li>
</ul>
</dd>
<dt>2.1.4: April 18, 2010</dt><dd><ul class="simple">
<li><p>Apply the same padding calculation fix from version 2.1.2 to the
main cross reference stream as well.</p></li>
<li><p>Since <strong class="command">qpdf --check</strong> only performs limited
checks, clarify the output to make it clear that there still may
be errors that qpdf can’t check. This should make it less
surprising to people when another PDF reader is unable to read a
file that qpdf thinks is okay.</p></li>
</ul>
</dd>
<dt>2.1.3: March 27, 2010</dt><dd><ul class="simple">
<li><p>Fix bug that could cause a failure when rewriting PDF files that
contain object streams with unreferenced objects that in turn
reference indirect scalars.</p></li>
<li><p>Don’t complain about (invalid) AES streams that aren’t a multiple
of 16 bytes. Instead, pad them before decrypting.</p></li>
</ul>
</dd>
<dt>2.1.2: January 24, 2010</dt><dd><ul class="simple">
<li><p>Fix bug in padding around first half cross reference stream in
linearized files. The bug could cause an assertion failure when
linearizing certain unlucky files.</p></li>
</ul>
</dd>
<dt>2.1.1: December 14, 2009</dt><dd><ul class="simple">
<li><p>No changes in functionality; insert missing include in an internal
library header file to support gcc 4.4, and update test suite to
ignore broken Adobe Reader installations.</p></li>
</ul>
</dd>
<dt>2.1: October 30, 2009</dt><dd><ul>
<li><p>This is the first version of qpdf to include Windows support. On
Windows, it is possible to build a DLL. Additionally, a partial
C-language API has been introduced, which makes it possible to
call qpdf functions from non-C++ environments. I am very grateful
to Žarko Gajić (<a class="reference external" href="http://zarko-gajic.iz.hr/">http://zarko-gajic.iz.hr/</a>) for tirelessly testing
numerous pre-release versions of this DLL and providing many
excellent suggestions on improving the interface.</p>
<p>For programming to the C interface, please see the header file
<code class="file docutils literal notranslate"><span class="pre">qpdf/qpdf-c.h</span></code> and the example
<code class="file docutils literal notranslate"><span class="pre">examples/pdf-linearize.c</span></code>.</p>
</li>
<li><p>Žarko Gajić has written a Delphi wrapper for qpdf, which can be
downloaded from qpdf’s download side. Žarko’s Delphi wrapper is
released with the same licensing terms as qpdf itself and comes
with this disclaimer: “Delphi wrapper unit
<code class="file docutils literal notranslate"><span class="pre">qpdf.pas</span></code> created by Žarko Gajić
(<a class="reference external" href="http://zarko-gajic.iz.hr/">http://zarko-gajic.iz.hr/</a>). Use at your own risk and for whatever
purpose you want. No support is provided. Sample code is
provided.”</p></li>
<li><p>Support has been added for AES encryption and crypt filters.
Although qpdf does not presently support files that use PKI-based
encryption, with the addition of AES and crypt filters, qpdf is
now be able to open most encrypted files created with newer
versions of Acrobat or other PDF creation software. Note that I
have not been able to get very many files encrypted in this way,
so it’s possible there could still be some cases that qpdf can’t
handle. Please report them if you find them.</p></li>
<li><p>Many error messages have been improved to include more information
in hopes of making qpdf a more useful tool for PDF experts to use
in manually recovering damaged PDF files.</p></li>
<li><p>Attempt to avoid compressing metadata streams if possible. This is
consistent with other PDF creation applications.</p></li>
<li><p>Provide new command-line options for AES encrypt, cleartext
metadata, and setting the minimum and forced PDF versions of
output files.</p></li>
<li><p>Add additional methods to the <code class="docutils literal notranslate"><span class="pre">QPDF</span></code> object for querying the
document’s permissions. Although qpdf does not enforce these
permissions, it does make them available so that applications that
use qpdf can enforce permissions.</p></li>
<li><p>The <code class="samp docutils literal notranslate"><span class="pre">--check</span></code> option to
<strong class="command">qpdf</strong> has been extended to include some
additional information.</p></li>
<li><p><em>Non-compatible API changes:</em></p>
<ul class="simple">
<li><p>QPDF’s exception handling mechanism now uses
<code class="docutils literal notranslate"><span class="pre">std::logic_error</span></code> for internal errors and
<code class="docutils literal notranslate"><span class="pre">std::runtime_error</span></code> for runtime errors in favor of the now
removed <code class="docutils literal notranslate"><span class="pre">QEXC</span></code> classes used in previous versions. The <code class="docutils literal notranslate"><span class="pre">QEXC</span></code>
exception classes predated the addition of the
<code class="file docutils literal notranslate"><span class="pre">&lt;stdexcept&gt;</span></code> header file to the C++ standard library.
Most of the exceptions thrown by the qpdf library itself are
still of type <code class="docutils literal notranslate"><span class="pre">QPDFExc</span></code> which is now derived from
<code class="docutils literal notranslate"><span class="pre">std::runtime_error</span></code>. Programs that catch an instance of
<code class="docutils literal notranslate"><span class="pre">std::exception</span></code> and displayed it by calling the <code class="docutils literal notranslate"><span class="pre">what()</span></code>
method will not need to be changed.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QPDFExc</span></code> class now internally represents various fields
of the error condition and provides interfaces for querying
them. Among the fields is a numeric error code that can help
applications act differently on (a small number of) different
error conditions. See <code class="file docutils literal notranslate"><span class="pre">QPDFExc.hh</span></code> for details.</p></li>
<li><p>Warnings can be retrieved from qpdf as instances of <code class="docutils literal notranslate"><span class="pre">QPDFExc</span></code>
instead of strings.</p></li>
<li><p>The nested <code class="docutils literal notranslate"><span class="pre">QPDF::EncryptionData</span></code> class’s constructor takes an
additional argument. This class is primarily intended to be used
by <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>. There’s not really anything useful an
end-user application could do with it. It probably shouldn’t
really be part of the public interface to begin with. Likewise,
some of the methods for computing internal encryption dictionary
parameters have changed to support <code class="docutils literal notranslate"><span class="pre">/R=4</span></code> encryption.</p></li>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">QPDF::getUserPassword</span></code> has been removed since it
didn’t do what people would think it did. There are now two new
methods: <code class="docutils literal notranslate"><span class="pre">QPDF::getPaddedUserPassword</span></code> and
<code class="docutils literal notranslate"><span class="pre">QPDF::getTrimmedUserPassword</span></code>. The first one does what the
old <code class="docutils literal notranslate"><span class="pre">QPDF::getUserPassword</span></code> method used to do, which is to
return the password with possible binary padding as specified by
the PDF specification. The second one returns a human-readable
password string.</p></li>
<li><p>The enumerated types that used to be nested in <code class="docutils literal notranslate"><span class="pre">QPDFWriter</span></code>
have moved to top-level enumerated types and are now defined in
the file <code class="file docutils literal notranslate"><span class="pre">qpdf/Constants.h</span></code>. This enables them to be
shared by both the C and C++ interfaces.</p></li>
</ul>
</li>
</ul>
</dd>
<dt>2.0.6: May 3, 2009</dt><dd><ul class="simple">
<li><p>Do not attempt to uncompress streams that have decode parameters
we don’t recognize. Earlier versions of qpdf would have rejected
files with such streams.</p></li>
</ul>
</dd>
<dt>2.0.5: March 10, 2009</dt><dd><ul class="simple">
<li><p>Improve error handling in the LZW decoder, and fix a small error
introduced in the previous version with regard to handling full
tables. The LZW decoder has been more strongly verified in this
release.</p></li>
</ul>
</dd>
<dt>2.0.4: February 21, 2009</dt><dd><ul class="simple">
<li><p>Include proper support for LZW streams encoded without the “early
code change” flag. Special thanks to Atom Smasher who reported the
problem and provided an input file compressed in this way, which I
did not previously have.</p></li>
<li><p>Implement some improvements to file recovery logic.</p></li>
</ul>
</dd>
<dt>2.0.3: February 15, 2009</dt><dd><ul class="simple">
<li><p>Compile cleanly with gcc 4.4.</p></li>
<li><p>Handle strings encoded as UTF-16BE properly.</p></li>
</ul>
</dd>
<dt>2.0.2: June 30, 2008</dt><dd><ul class="simple">
<li><p>Update test suite to work properly with a
non-<strong class="command">bash</strong>
<code class="file docutils literal notranslate"><span class="pre">/bin/sh</span></code> and with Perl 5.10. No changes
were made to the actual qpdf source code itself for this release.</p></li>
</ul>
</dd>
<dt>2.0.1: May 6, 2008</dt><dd><ul class="simple">
<li><p>No changes in functionality or interface. This release includes
fixes to the source code so that qpdf compiles properly and passes
its test suite on a broader range of platforms. See
<code class="file docutils literal notranslate"><span class="pre">ChangeLog</span></code> in the source distribution
for details.</p></li>
</ul>
</dd>
<dt>2.0: April 29, 2008</dt><dd><ul class="simple">
<li><p>First public release.</p></li>
</ul>
</dd>
</dl>
</section>
<span id="document-acknowledgement"></span><section id="acknowledgments">
<span id="id1"></span><h2>Acknowledgments<a class="headerlink" href="#acknowledgments" title="Permalink to this headline"></a></h2>
<p>QPDF was originally created in 2001 and modified periodically between
2001 and 2005 during my employment at <a class="reference external" href="https://apexcovantage.com/">Apex CoVantage</a>. Upon my departure from Apex, the
company graciously allowed me to take ownership of the software and
continue maintaining it as an open source project, a decision for which I
am very grateful. I have made considerable enhancements to it since
that time. I feel fortunate to have worked for people who would make
such a decision. This work would not have been possible without their
support.</p>
<p>In 2020, I joined <a class="reference external" href="https://adventhp.com/">Advent Health Partners</a>,
which has sponsored some previous QPDF work and generously allows me
to spend some “company time” maintaining QPDF.</p>
</section>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2005-2021, Jay Berkenbilt.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>